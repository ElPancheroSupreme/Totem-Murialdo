<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Buffet Murialdino</title>
    <link rel="icon" href="../assets/images/Iconos/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css?family=Inter:400,600,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/style/Config.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/dashboard/auth.js"></script>
</head>

<body>
    <!-- Modal PIN de Administrador -->
    <div id="modal-pin-admin" class="modal" style="display:none;">
        <div class="modal-content">
            <h2>PIN de Administrador</h2>
            <div class="modal-description">Ingrese el PIN para acceder a esta secci√≥n</div>
            <input type="password" id="input-pin-admin" maxlength="8">
            <div id="pin-admin-error">PIN incorrecto</div>
            <div class="modal-buttons">
                <button id="btn-pin-admin-cancelar" class="btn-light" type="button">Cancelar</button>
                <button id="btn-pin-admin-confirmar" class="btn-green" type="button">Acceder</button>
            </div>
        </div>
    </div>
    <div class="dashboard-layout">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="../assets/images/Iconos/Logo.png" alt="Buffet Murialdino" class="sidebar-logo-icon"
                        style="width:50px;height:50px;object-fit:contain;display:block;">
                    <div>
                        <div class="sidebar-title">Buffet Murialdino</div>
                        <div class="sidebar-subtitle">Sistema de T√≥tems</div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-section">NAVEGACI√ìN PRINCIPAL</div>
                <ul id="sidebar-menu">
                    <li class="active" data-section="dashboard" title="Dashboard"><span class="icon"><img src="../assets/images/Iconos/casa_color.svg" class="icon-svg" alt="Dashboard"></span>Dashboard
                    </li>
                    <li data-section="productos" title="Productos"><span class="icon"><img src="../assets/images/Iconos/caja_color.svg" class="icon-svg" alt="Productos"></span>Productos</li>
                    <li data-section="pedidos" title="Pedidos"><span class="icon"><img src="../assets/images/Iconos/portapapeles_color.svg" class="icon-svg" alt="Pedidos"></span>Pedidos</li>
                    <li data-section="comandas" title="Comandas"><span class="icon"><img src="../assets/images/Iconos/timbre_color.svg" class="icon-svg" alt="Comandas"></span>Comandas</li>
                    <li data-section="estadisticas" title="Estad√≠sticas"><span class="icon"><img src="../assets/images/Iconos/estadisticas_color.svg" class="icon-svg" alt="Estad√≠sticas"></span>Estad√≠sticas</li>
                    <li data-section="usuarios" title="Usuarios"><span class="icon"><img src="../assets/images/Iconos/usuarios_color.svg" class="icon-svg" alt="Usuarios"></span>Usuarios</li>
                    <li data-section="proveedores" title="Proveedores"><span class="icon"><img src="../assets/images/Iconos/camion_color.svg" class="icon-svg" alt="Proveedores"></span>Proveedores</li>
                    <li data-section="configuracion" title="Configuraci√≥n"><span class="icon"><img src="../assets/images/Iconos/engranaje_color.svg" class="icon-svg" alt="Configuraci√≥n"></span>Configuraci√≥n</li>
                </ul>
            </nav>
            <div class="sidebar-theme-switch">
                <div class="theme-switch-container">
                    <span class="theme-label"><img src="../assets/images/Iconos/sol_color.svg" class="icon-svg" alt="Productos"></span>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="theme-slider"></span>
                    </label>
                    <span class="theme-label"><img src="../assets/images/Iconos/luna2.svg" class="icon-svg" alt="Luna"></span>
                </div>
            </div>
            <div class="sidebar-user">
                <div class="user-info">
                    <div class="user-name" id="user-name"></div>
                </div>
                <button class="btn-logout" id="btn-logout">Cerrar sesi√≥n</button>
            </div>
        </aside>

        <!-- Overlay para cerrar sidebar en m√≥vil -->
        <div class="sidebar-overlay" id="sidebar-overlay"></div>

        <main class="main-content">
            <header class="main-header">
                <div class="main-header-left">
                    <button class="menu-btn">‚ò∞</button>
                    <span class="breadcrumb" id="breadcrumb">Buffet Murialdino <span class="breadcrumb-sep">/</span>
                        Dashboard</span>
                </div>
            </header>
            <div class="main-scroll-area">
                <section id="dashboard-section" class="seccion">
                    <section class="welcome-section">
                        <h1>¬°Bienvenido al Dashboard!</h1>
                        <p>Aqu√≠ tienes un resumen completo del estado actual del buffet escolar</p>
                    </section>
                    <section class="summary-cards">
                        <div class="card card-green">
                            <div class="card-title">Ventas del D√≠a</div>
                            <div class="card-value" id="ventas-dia">$0</div>
                        </div>
                        <div class="card card-yellow">
                            <div class="card-title">Pedidos en Curso</div>
                            <div class="card-value" id="pedidos-curso">0</div>
                        </div>
                        <div class="card card-blue">
                            <div class="card-title">M√©todo M√°s Usado</div>
                            <div class="card-value" id="metodo-mas-usado">-</div>
                        </div>
                    </section>
                    <section class="sales-summary">
                        <div class="sales-summary-header">
                            <span class="summary-title">Resumen de Ventas del D√≠a</span>
                            <span class="sales-summary-sub">Estad√≠sticas actualizadas en tiempo real</span>
                        </div>
                        <div class="sales-summary-cards">
                            <div class="summary-box summary-green">
                                <div class="summary-value">156</div>
                                <div class="summary-label">Total Pedidos</div>
                            </div>
                            <div class="summary-box summary-blue">
                                <div class="summary-value">$2,847</div>
                                <div class="summary-label">Ingresos</div>
                            </div>
                            <div class="summary-box summary-purple">
                                <div class="summary-value">$18.25</div>
                                <div class="summary-label">Ticket Promedio</div>
                            </div>
                        </div>
                    </section>
                    <div class="main-row">
                        <section class="recent-orders">
                            <div class="section-title-row">
                                <div class="section-title"><span class="section-icon"><img src="../assets/images/Iconos/galletita_color.svg" class="icon-svg" alt="Productos"></span>Pedidos Recientes</div>
                                <button class="see-all-btn see-all-inline" onclick="irASeccionPedidos()">Ver
                                    Todos</button>
                            </div>
                            <div class="section-sub">√öltimos pedidos del d√≠a</div>
                            <div class="orders-list" id="orders-list">
                                <div style="text-align: center; padding: 2rem; color: #666;">
                                    Cargando pedidos...
                                </div>
                            </div>
                        </section>
                        <section class="dashboard-top5">
                            <div class="section-title-row">
                                <div class="section-title"><span class="section-icon"><img src="../assets/images/Iconos/trofeo_color.svg" class="icon-svg" alt="Productos"></span>Productos M√°s
                                    Vendidos</div>
                                <button class="see-all-btn see-all-inline" onclick="irASeccionEstadisticas()">Ver
                                    M√°s</button>
                            </div>
                            <div class="section-sub">Los productos con mayor demanda</div>
                            <div class="top5-list" id="dashboard-top5-list">
                                <div class="loading">Cargando productos...</div>
                            </div>
                        </section>
                    </div>
                </section>
                <!-- Secci√≥n Productos -->
                <section class="seccion" id="productos-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Gesti√≥n de Productos</h1>
                            <p>Administra el cat√°logo de productos</p>
                        </div>
                        <div class="productos-actions">
                            <button class="btn-masivo" id="btn-activar-masivo" title="Activar seleccionados">üü¢
                                Activar</button>
                            <button class="btn-masivo" id="btn-desactivar-masivo" title="Desactivar seleccionados">üî¥
                                Desactivar</button>
                            <button class="btn-masivo" id="btn-eliminar-masivo" title="Eliminar seleccionados"><img src="../assets/images/Iconos/basura_color.svg" class="icon-svg" alt="Productos">
                                Eliminar</button>
                            <div class="btn-masivo-precio" id="btn-masivo-precio">
                                <button type="button" class="btn-precio-tipo" id="btn-precio-tipo"
                                    title="Cambiar tipo">$
                                </button>
                                <input type="number" class="input-precio-masivo" id="input-precio-masivo"
                                    placeholder="0" step="any">
                                <button type="button" class="btn-precio-aplicar" id="btn-precio-aplicar"
                                    title="Aplicar cambio de precio masivo">Aplicar</button>
                            </div>
                            <button class="btn-secondary" onclick="categoriasManager.abrirModal()"><img src="../assets/images/Iconos/etiqueta_color.svg" class="icon-svg" alt="Productos"> Gestionar Categor√≠as</button>
                            <button class="btn-export" onclick="productosManager.exportarCSV()"><img src="../assets/images/Iconos/notas_color.svg" class="icon-svg" alt="Productos"> Exportar CSV</button>
                            <button class="btn-import" onclick="productosManager.mostrarImportar()"><img src="../assets/images/Iconos/carpeta_color.svg" class="icon-svg" alt="Productos"> Importar</button>
                        </div>
                    </div>
                    <div class="productos-toolbar">
                        <input type="text" class="input-search" placeholder="Buscar productos...">
                        <select class="filter-select" id="categoria-filter">
                            <option value="">Todas las categor√≠as</option>
                        </select>
                        <select class="filter-select" id="punto-venta-filter">
                            <option value="">Todos los puntos de venta</option>
                        </select>
                        <select class="filter-select" id="proveedor-filter">
                            <option value="">Todos los proveedores</option>
                        </select>
                        <div class="checkbox-container">
                            <label class="checkbox-label">
                                <input type="checkbox" id="mostrar-eliminados">
                                <span class="checkbox-text">Mostrar productos inactivos</span>
                            </label>
                        </div>
                        <select class="filter-select" id="orden-filter">
                            <option value="fecha">Fecha (m√°s reciente)</option>
                            <option value="alfabetico">Alfab√©tico (A-Z)</option>
                            <option value="alfabetico-desc">Alfab√©tico (Z-A)</option>
                            <option value="precio-asc">Precio (menor a mayor)</option>
                            <option value="precio-desc">Precio (mayor a menor)</option>
                        </select>
                        <div class="view-toggle">
                            <button class="btn-toggle active" id="vista-lista"><span><img src="../assets/images/Iconos/menu.svg" id="icono_blanco" class="icon-svg" alt="Productos"><img src="../assets/images/Iconos/menu_blanco.svg" id="icono_negro" class="icon-svg" alt="Productos"></span></button>
                            <button class="btn-toggle" id="vista-grilla"><span><img src="../assets/images/Iconos/grilla.svg" id="icono_blanco" class="icon-svg" alt="Productos"><img src="../assets/images/Iconos/grilla_blanco.svg" id="icono_negro" class="icon-svg" alt="Productos"></span></button>
                        </div>
                    </div>
                    <div class="productos-bottom-toolbar">
                        <div class="pagination-controls">
                            <label>Mostrar:</label>
                            <select class="filter-select" id="items-por-pagina">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="75">75</option>
                                <option value="100">100</option>
                            </select>
                            <label>por p√°gina</label>
                        </div>
                        <div class="agregar-producto-container">
                            <button class="btn-primary-action" onclick="productosManager.abrirModal()">+ Agregar
                                Producto</button>
                        </div>
                    </div>
                    <div class="productos-lista" id="productos-lista">
                        <div class="productos-lista-header">
                            <div class="productos-lista-title">Lista de Productos</div>
                            <div class="productos-lista-count">4 productos encontrados</div>
                        </div>
                        <div class="table-container">
                            <table class="productos-table" id="productos-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="select-all-productos" title="Seleccionar todos">
                                        </th>
                                        <th>Producto</th>
                                        <th>Categor√≠a</th>
                                        <th>Precio</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="productos-tbody">
                                    <!-- Los productos se cargar√°n din√°micamente desde JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pagination">
                            <button class="pagination-btn" id="prev-page" disabled>¬´ Anterior</button>
                            <div class="pagination-info">
                                <span id="page-info">P√°gina 1 de 1</span>
                                <span id="items-info">Mostrando 1-25 de 25 productos</span>
                            </div>
                            <button class="pagination-btn" id="next-page" disabled>Siguiente ¬ª</button>
                        </div>
                    </div>
                    <div class="productos-grilla" id="productos-grilla" style="display:none">
                        <div class="productos-lista-header">
                            <div class="productos-lista-title">Productos en Grilla</div>
                            <div class="productos-lista-count">4 productos encontrados</div>
                        </div>
                        <div class="productos-grid" id="productos-grid">
                            <!-- Los productos se cargar√°n din√°micamente desde JavaScript -->
                        </div>
                        <div class="pagination" id="pagination-grilla">
                            <button class="pagination-btn" id="prev-page-grilla" disabled>¬´ Anterior</button>
                            <div class="pagination-info">
                                <span id="page-info-grilla">P√°gina 1 de 1</span>
                                <span id="items-info-grilla">Mostrando 1-25 de 25 productos</span>
                            </div>
                            <button class="pagination-btn" id="next-page-grilla" disabled>Siguiente ¬ª</button>
                        </div>
                    </div>
                </section>
                <!-- Secci√≥n Pedidos -->
                <section class="seccion" id="pedidos-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Gesti√≥n de Pedidos</h1>
                            <p>Administra todos los pedidos del buffet escolar</p>
                        </div>
                    </div>
                    <div class="pedidos-cards-row" id="pedidos-cards-container">
                        <div class="pedido-card card-blue" id="card-pedidos-hoy">
                            <div class="pedido-card-title">Pedidos Hoy</div>
                            <div class="pedido-card-value" id="total-pedidos-hoy">0</div>
                            <div class="pedido-card-sub" id="comparativo-pedidos">Cargando...</div>
                        </div>
                        <div class="pedido-card card-yellow" id="card-en-preparacion">
                            <div class="pedido-card-title">En Preparaci√≥n</div>
                            <div class="pedido-card-value" id="total-en-preparacion">0</div>
                            <div class="pedido-card-sub" id="tiempo-promedio">Cargando...</div>
                        </div>
                        <div class="pedido-card card-green" id="card-entregados">
                            <div class="pedido-card-title">Entregados</div>
                            <div class="pedido-card-value" id="total-entregados">0</div>
                            <div class="pedido-card-sub" id="porcentaje-entregados">Cargando...</div>
                        </div>
                    </div>
                    <div class="pedidos-toolbar">
                        <input type="text" class="input-search" placeholder="Buscar por nombre, alumno...">
                        <button class="btn-light">Todas los estados</button>
                        <button class="btn-light">Filtrar por fecha</button>
                    </div>
                    <div class="productos-bottom-toolbar">
                        <div class="pagination-controls">
                            <label>Mostrar:</label>
                            <select class="filter-select" id="pedidos-por-pagina">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="75">75</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                            <label>por p√°gina</label>
                        </div>
                    </div>
                    <div class="pedidos-lista">
                        <div class="pedidos-lista-header">
                            <div class="pedidos-lista-title">Lista de Pedidos</div>
                            <div class="pedidos-lista-count">4 pedidos encontrados</div>
                        </div>
                        <div class="table-container">
                            <table class="pedidos-table">
                                <thead>
                                    <tr>
                                        <th>Pedido</th>
                                        <th>Items</th>
                                        <th>Total</th>
                                        <th>Estado</th>
                                        <th>M√©todo</th>
                                        <th>Punto</th>
                                        <th>Hora</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="pedidos-tbody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 2rem;">Cargando...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pedidos-pagination">
                            <button class="pagination-btn" id="prev-page-pedidos" disabled>¬´ Anterior</button>
                            <div class="pagination-info">
                                <span id="page-info-pedidos">P√°gina 1 de 1</span>
                                <span id="items-info-pedidos">Mostrando 1-100 de 100 pedidos</span>
                            </div>
                            <button class="pagination-btn" id="next-page-pedidos" disabled>Siguiente ¬ª</button>
                        </div>
                    </div>
                </section>
                <script src="../assets/js/dashboard/pedidos_filtros.js"></script>
                <script src="../assets/js/dashboard/usuarios_manager.js"></script>
                <!-- Secci√≥n Comandas -->
                <section class="seccion" id="comandas-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Panel de Comandas</h1>
                            <p>Gestiona el estado de los pedidos en tiempo real</p>
                        </div>
                        <div class="comandas-actions">
                            <button class="btn-secondary" onclick="window.open('comandas.html', '_blank')" title="Abrir vista completa de comandas">
                                üñ•Ô∏è Vista Completa
                            </button>
                        </div>
                    </div>
                    <div class="comandas-container">
                        <div class="comandas-header">
                            <div style="display: flex; gap: 8px;">
                                <button class="active" id="btn-activos-comandas">Activos</button>
                                <button id="btn-finalizados-comandas">Finalizados</button>
                            </div>
                            <div class="bulk-actions" style="display: flex; gap: 8px;">
                                <button class="btn-green" id="btn-continuar-masivo" title="Avanzar comandas seleccionadas">
                                    ‚ñ∂Ô∏è Continuar
                                </button>
                                <button class="btn-red" id="btn-cancelar-masivo" title="Cancelar comandas seleccionadas">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                        </div>
                        <div id="panel-activos-comandas">
                            <div class="comandas-columns">
                                <div class="comandas-col listos">
                                    <div class="col-title" style="color:#22c55e;">LISTOS</div>
                                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.95em;margin-bottom:12px;flex-shrink:0;">
                                        <input type="checkbox" class="comanda-checkbox select-all-checkbox" data-columna="listos" title="Seleccionar todos">
                                        <span id="listos-total">Total: 0 Pedidos</span>
                                    </div>
                                    <div class="comandas-col-content">
                                        <div id="listos-col"></div>
                                    </div>
                                </div>
                                <div class="comandas-col preparacion">
                                    <div class="col-title" style="color:#fbbf24;">EN PREPARACI√ìN</div>
                                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.95em;margin-bottom:12px;flex-shrink:0;">
                                        <input type="checkbox" class="comanda-checkbox select-all-checkbox" data-columna="preparacion" title="Seleccionar todos">
                                        <span id="preparacion-total">Total: 0 Pedidos</span>
                                    </div>
                                    <div class="comandas-col-content">
                                        <div id="preparacion-col"></div>
                                    </div>
                                </div>
                                <div class="comandas-col pendiente">
                                    <div class="col-title" style="color:#ef4444;">PAGO PENDIENTE</div>
                                    <div style="display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.95em;margin-bottom:12px;flex-shrink:0;">
                                        <input type="checkbox" class="comanda-checkbox select-all-checkbox" data-columna="pendiente" title="Seleccionar todos">
                                        <span id="pendiente-total">Total: 0 Pedidos</span>
                                    </div>
                                    <div class="comandas-col-content">
                                        <div id="pendiente-col"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="panel-finalizados-comandas" style="display:none;">
                            <div class="comandas-columns">
                                <div class="comandas-col completados">
                                    <div class="col-title" style="color:#22c55e;">‚úîÔ∏è COMPLETADOS</div>
                                    <div id="completados-total" style="text-align:center;font-size:0.95em;margin-bottom:12px;flex-shrink:0;">Total: 0 Pedidos</div>
                                    <div class="comandas-col-content">
                                        <div id="completados-col"></div>
                                    </div>
                                </div>
                                <div class="comandas-col cancelados">
                                    <div class="col-title" style="color:#ef4444;">‚ùå CANCELADOS</div>
                                    <div id="cancelados-total" style="text-align:center;font-size:0.95em;margin-bottom:12px;flex-shrink:0;">Total: 0 Pedidos</div>
                                    <div class="comandas-col-content">
                                        <div id="cancelados-col"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Secci√≥n Estad√≠sticas -->
                <section class="seccion" id="estadisticas-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Estad√≠sticas y Reportes</h1>
                            <p>Analiza el rendimiento del buffet escolar</p>
                        </div>
                        <div class="estadisticas-actions">
                            <button class="btn-green" onclick="exportarRentabilidadPDF()"><img src="../assets/images/Iconos/notas_color.svg" class="icon-svg" alt="Productos"> Exportar PDF</button>
                            <button class="btn-blue" onclick="exportarRentabilidadExcel()"><img src="../assets/images/Iconos/grafico_barras_color.svg" class="icon-svg" alt="Productos"> Exportar Excel</button>
                        </div>
                    </div>
                    <div class="filtros-fecha" style="margin: 16px 0; display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                        <button onclick="cambiarFiltroEstadisticas('hoy')" id="filtro-hoy"
                            class="filtro-btn active">Hoy</button>
                        <button onclick="cambiarFiltroEstadisticas('semana')" id="filtro-semana"
                            class="filtro-btn">Esta Semana</button>
                        <button onclick="cambiarFiltroEstadisticas('mes')" id="filtro-mes"
                            class="filtro-btn">Este Mes</button>
                        <button onclick="cambiarFiltroEstadisticas('3meses')" id="filtro-3meses"
                            class="filtro-btn">√öltimos 3 Meses</button>
                        <div class="filtro-personalizado" style="display: flex; gap: 8px; align-items: center; margin-left: 16px; padding-left: 16px; border-left: 1px solid #dee2e6;">
                            <label style="font-weight: 500; color: #6c757d; font-size: 14px;">Per√≠odo personalizado:</label>
                            <input type="date" id="fecha-inicio" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <span style="color: #6c757d;">a</span>
                            <input type="date" id="fecha-fin" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                            <button onclick="aplicarFiltroPersonalizado()" id="btn-filtro-personalizado" 
                                class="filtro-btn" style="background: #6f42c1; color: white;">Aplicar</button>
                        </div>
                    </div>
                    <div class="filtros-servicio" style="margin: 0 0 16px 0; display: flex; gap: 8px; align-items: center;">
                        <label style="font-weight: 500; color: #6c757d; font-size: 14px;">Tipo de servicio:</label>
                        <select class="filter-select" id="tipo-servicio-filter" onchange="cambiarFiltroServicio(this.value)">
                            <option value="">Todos los servicios</option>
                            <option value="1">Solo Buffet</option>
                            <option value="2">Solo Kiosco</option>
                        </select>
                        <div style="margin-left: 24px; display: flex; gap: 8px; align-items: center;">
                            <label style="font-weight: 500; color: #6c757d; font-size: 14px; display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="mostrar-todos-productos" onchange="cambiarVisualizacionProductos(this.checked)" style="margin-right: 6px;">
                                Mostrar todos los productos
                            </label>
                        </div>
                    </div>
                    <div class="estadisticas-cards-row">
                        <div class="estadistica-card card-green">
                            <div class="estadistica-title">Ingresos Totales</div>
                            <div class="estadistica-value" id="ingresos-totales">$0</div>
                            <div class="estadistica-sub" id="periodo-actual">Hoy</div>
                        </div>
                        <div class="estadistica-card card-purple-bg">
                            <div class="estadistica-title">Ticket Promedio</div>
                            <div class="estadistica-value" id="ticket-promedio">$0.00</div>
                            <div class="estadistica-sub" id="periodo-actual2">Hoy</div>
                        </div>
                        <div class="estadistica-card card-blue">
                            <div class="estadistica-title">Compras en el T√≥tem</div>
                            <div class="estadistica-value" id="contador-totem">0</div>
                            <div class="estadistica-sub" id="periodo-actual3">Hoy</div>
                        </div>
                    </div>
                    
                    <div class="estadisticas-graficos-row">
                        <div class="grafico grafico-bar">
                            <div class="grafico-title">Ventas por D√≠a</div>
                            <canvas id="ventasPorDiaChart"></canvas>
                        </div>
                        <div class="grafico grafico-pie">
                            <div class="grafico-title">M√©todos de Pago</div>
                            <canvas id="metodosPagoChart"></canvas>
                        </div>
                    </div>
                    <div class="estadisticas-bottom-row">
                        <div class="estadisticas-top5">
                            <div class="grafico-title">Productos M√°s Vendidos</div>
                            <ul class="top5-list" id="top5-list">
                                <li class="loading">Cargando productos...</li>
                            </ul>
                        </div>
                        <div class="estadisticas-horas">
                            <div class="grafico-title">Pedidos por Hora</div>
                            <canvas id="pedidosPorHoraChart"></canvas>
                        </div>
                    </div>
                    <div class="grafico-title" style="margin-bottom: 16px;">An√°lisis de Rentabilidad</div>
                    <div class="estadisticas-rentabilidad-row" style="margin: 24px 0;">
                        <div class="rentabilidad-section">
                            <div class="rentabilidad-content">
                                <div class="productos-lista">
                                    <div class="rentabilidad-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                        <h3 style="margin: 0; color: #333; font-size: 16px;">Productos por Rentabilidad</h3>
                                        <div class="rentabilidad-legend" style="display: flex; gap: 16px; font-size: 12px;">
                                            <span class="margen-alto">‚óè Alta rentabilidad (>50%)</span>
                                            <span class="margen-medio">‚óè Media rentabilidad (20-50%)</span>
                                            <span class="margen-bajo">‚óè Baja rentabilidad (<20%)</span>
                                        </div>
                                    </div>
                                    <div class="rentabilidad-controls" style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <label for="search-producto" style="font-weight: 600; color: #495057; font-size: 14px;">Buscar producto:</label>
                                            <input type="text" id="search-producto" placeholder="Escriba para buscar..." style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; width: 200px;">
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
                                            <button id="clear-filters" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Limpiar filtros</button>
                                        </div>
                                    </div>
                                    <div class="rentabilidad-table-wrapper" style="overflow-x: auto;">
                                        <table class="rentabilidad-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 12px 8px; text-align: left; font-weight: 600; color: #495057;">Producto</th>
                                                    <th class="sortable-header" data-column="precio_compra" style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057; cursor: pointer; user-select: none;">
                                                        P. Compra <span class="sort-indicator">‚áÖ</span>
                                                    </th>
                                                    <th class="sortable-header" data-column="precio_venta" style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057; cursor: pointer; user-select: none;">
                                                        P. Venta <span class="sort-indicator">‚áÖ</span>
                                                    </th>
                                                    <th class="sortable-header" data-column="ganancia_unitaria" style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057; cursor: pointer; user-select: none;">
                                                        Ganancia <span class="sort-indicator">‚áÖ</span>
                                                    </th>
                                                    <th class="sortable-header" data-column="margen_porcentaje" style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057; cursor: pointer; user-select: none;">
                                                        Margen % <span class="sort-indicator">‚áÖ</span>
                                                    </th>
                                                    <th class="sortable-header" data-column="unidades_vendidas" style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057; cursor: pointer; user-select: none;">
                                                        Unid. Vendidas <span class="sort-indicator">‚áÖ</span>
                                                    </th>
                                                    <th class="sortable-header" data-column="ganancia_total" style="padding: 12px 8px; text-align: right; font-weight: 600; color: #495057; cursor: pointer; user-select: none;">
                                                        Ganancia Total <span class="sort-indicator">‚áÖ</span>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody id="rentabilidad-tbody">
                                                <tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6c757d;">Cargando datos de rentabilidad...</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Controles de paginaci√≥n para rentabilidad -->
                                    <div class="pagination" id="rentabilidad-pagination">
                                        <button class="pagination-btn" id="prev-page-rentabilidad" disabled>‚Üê Anterior</button>
                                        <div class="pagination-info">
                                            <span id="page-info-rentabilidad">P√°gina 1 de 1</span>
                                            <span id="items-info-rentabilidad">Mostrando 0-0 de 0 productos</span>
                                        </div>
                                        <button class="pagination-btn" id="next-page-rentabilidad" disabled>Siguiente ‚Üí</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Secci√≥n Usuarios -->
                <section class="seccion" id="usuarios-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Gesti√≥n de Usuarios</h1>
                            <p>Administra usuarios, roles y permisos del sistema</p>
                        </div>
                        <button class="btn-green" id="btn-agregar-usuario" onclick="window.getUsuariosManager()?.mostrarModalAgregar()" style="margin-left:auto;">+ Agregar
                            Usuario</button>
                    </div>
                    <div class="usuarios-toolbar">
                        <input type="text" id="buscar-usuarios" class="input-search" placeholder="Buscar usuarios...">
                        <button class="btn-light">Todos los roles</button>
                    </div>
                    <div class="usuarios-lista">
                        <div class="usuarios-lista-header">
                            <div class="usuarios-lista-title">Lista de Usuarios</div>
                            <div class="usuarios-lista-count" id="usuarios-count">4 usuarios encontrados</div>
                        </div>
                        <div class="table-container">
                            <table class="usuarios-table">
                                <thead>
                                    <tr>
                                        <th>Usuario</th>
                                        <th>Contacto</th>
                                        <th>Rol</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="usuarios-tbody">
                                    <tr>
                                        <td colspan="4" style="text-align: center; padding: 2rem; color: #666;">
                                            Cargando usuarios...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>
                
                <!-- Secci√≥n Proveedores -->
                <section class="seccion" id="proveedores-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Gesti√≥n de Proveedores</h1>
                            <p>Administra proveedores, productos y pedidos de restock</p>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="btn-green" id="btn-nuevo-proveedor">
                                <span style="margin-right: 8px;"><img src="../assets/images/Iconos/mas_color.svg" class="icon-svg" alt="Productos"></span>Nuevo Proveedor
                            </button>
                            <button class="btn-blue" id="btn-asignar-productos">
                                <span style="margin-right: 8px;"><img src="../assets/images/Iconos/cadena_color.svg" class="icon-svg" alt="Productos"></span>Asignar Productos
                            </button>
                                <button class="btn-orange" id="btn-gestionar-plantillas" style="background: #ff9800; color: white; font-weight: 500;">
                                    <span style="margin-right: 8px;"><img src="../assets/images/Iconos/notas_color.svg" class="icon-svg" alt="Productos"></span>Gestionar Plantillas
                                </button>
                                <!-- Modal Gesti√≥n Plantillas -->
                                <div id="modal-gestionar-plantillas" class="modal" style="display: none;">
                                    <div class="modal-content" style="max-width: 700px;">
                                        <div class="modal-header">
                                            <h2>Gesti√≥n de Plantillas de Mensaje</h2>
                                            <button class="modal-close" onclick="document.getElementById('modal-gestionar-plantillas').style.display='none'">&times;</button>
                                        </div>
                                        <div class="modal-body">
                                            <div style="background: #fff3cd; color: #856404; border: 1px solid #ffeeba; border-radius: 8px; padding: 14px; margin-bottom: 18px; font-size: 15px; display: flex; align-items: flex-start; gap: 10px;">
                                                <span style="font-size: 1.5em;">üí°</span>
                                                <div>
                                                    <strong>¬øC√≥mo usar plantillas de mensaje para pedidos a proveedores?</strong><br>
                                                    Puedes crear plantillas personalizadas para los mensajes de pedido. Utiliza los siguientes marcadores din√°micos en el texto:<br>
                                                    <ul style="margin: 8px 0 0 18px; padding: 0;">
                                                        <li><b>[CONTACTO]</b>: ser√° reemplazado autom√°ticamente por el nombre del contacto del proveedor.</li>
                                                        <li><b>[PRODUCTOS]</b>: ser√° reemplazado por la lista de productos solicitados.</li>
                                                    </ul>
                                                    Ejemplo: <span style="font-family:monospace; background:#ffeeba; padding:2px 6px; border-radius:4px;">Hola [CONTACTO], necesito reponer: [PRODUCTOS]</span>
                                                </div>
                                            </div>
                                            <div style="margin-bottom: 18px; text-align: right;">
                                                <button class="btn-green" id="btn-nueva-plantilla"><span style="margin-right: 6px;"><img src="../assets/images/Iconos/mas_color.svg" class="icon-svg" alt="Productos"></span>Nueva Plantilla</button>
                                            </div>
                                            <div id="plantillas-lista"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Modal Alta/Edici√≥n Plantilla -->
                                <div id="modal-form-plantilla" class="modal" style="display: none;">
                                    <div class="modal-content" style="max-width: 480px;">
                                        <div class="modal-header">
                                            <h2 id="titulo-modal-plantilla">Nueva Plantilla</h2>
                                            <button class="modal-close" onclick="document.getElementById('modal-form-plantilla').style.display='none'">&times;</button>
                                        </div>
                                        <form id="form-plantilla" class="modal-form" autocomplete="off">
                                            <input type="hidden" id="plantilla-id" name="id_plantilla">
                                            <div class="form-group">
                                                <label for="plantilla-nombre">T√≠tulo de la plantilla</label>
                                                <input type="text" id="plantilla-nombre" name="nombre" maxlength="50" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="plantilla-contenido">Mensaje de la plantilla</label>
                                                <textarea id="plantilla-contenido" name="contenido" rows="4" maxlength="1000" required></textarea>
                                            </div>
                                            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                                <button type="button" class="btn-light" onclick="document.getElementById('modal-form-plantilla').style.display='none'">Cancelar</button>
                                                <button type="submit" class="btn-green">Guardar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                                <script src="../assets/js/dashboard/plantillas_manager.js"></script>
                            <button class="btn-purple" id="btn-enviar-pedido">
                                <span style="margin-right: 8px;">üì§</span>Enviar Pedido
                            </button>
                        </div>
                    </div>
                    
                    <!-- Cards de estad√≠sticas -->
                    <div class="proveedores-cards-row" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin: 16px 0;">
                        <div class="stats-card">
                            <div class="stats-icon" style="background: #e3f2fd;"><img src="../assets/images/Iconos/grafico_barras_color.svg" class="icon-svg" alt="Productos"></div>
                            <div class="stats-content">
                                <div class="stats-value" id="total-proveedores-activos">0</div>
                                <div class="stats-label">Proveedores Activos</div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-icon" style="background: #f3e5f5;"><img src="../assets/images/Iconos/caja_color.svg" class="icon-svg" alt="Productos"></div>
                            <div class="stats-content">
                                <div class="stats-value" id="productos-sin-proveedor">0</div>
                                <div class="stats-label">Productos sin Proveedor</div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-icon" style="background: #e8f5e8;">üì§</div>
                            <div class="stats-content">
                                <div class="stats-value" id="pedidos-mes">0</div>
                                <div class="stats-label">Pedidos este Mes</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Toolbar de filtros -->
                    <div class="proveedores-toolbar">
                        <input type="text" id="buscar-proveedor" placeholder="Buscar por nombre, contacto o CUIT...">
                        <select id="filtro-estado-proveedor">
                            <option value="all">Todos los estados</option>
                            <option value="1">Activos</option>
                            <option value="0">Inactivos</option>
                        </select>
                        <button class="btn-light" id="btn-limpiar-filtros">Limpiar</button>
                    </div>
                    
                    <!-- Lista de proveedores -->
                    <div class="proveedores-lista">
                        <table class="proveedores-table">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>Contacto</th>
                                    <th>CUIT</th>
                                    <th>Tel√©fono</th>
                                    <th>Productos</th>
                                    <th>√öltimo Pedido</th>
                                    <th>Estado</th>
                                    <th style="text-align: center;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="proveedores-tbody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 2rem; color: #666;">Cargando proveedores...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                
                <!-- Secci√≥n Configuraci√≥n -->
                <section class="seccion" id="configuracion-section" style="display:none">
                    <div class="section-header-row">
                        <div>
                            <h1>Configuraci√≥n del Sistema</h1>
                            <p>Personaliza y configura el sistema de t√≥tems</p>
                        </div>
                    </div>
                    <div class="config-tabs">
                        <button class="config-tab active">General</button>
                        <button class="config-tab">Pagos</button>
                        <button class="config-tab">Horarios</button>
                        <button class="config-tab">Seguridad</button>
                    </div>
                    <div class="config-panel">
                        <div class="config-panel-title">Configuraci√≥n General</div>

                        <!-- Modo Mantenimiento y Pantalla TV - lado a lado -->
                        <div class="modo-mantenimiento-section" style="margin-bottom: 24px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                <div class="modo-mantenimiento-metodo">
                                    <div>
                                        <span>üîß</span> Modo Mantenimiento<br>
                                        <span class="modo-mantenimiento-desc">Deshabilita temporalmente el acceso al sistema
                                            (tanto t√≥tem como m√≥vil) para mantenimiento</span>
                                    </div>
                                    <input type="checkbox" id="chk-modo-mantenimiento">
                                </div>
                                <div class="modo-mantenimiento-metodo">
                                    <div>
                                        <span>üì∫</span> Pantalla de Televisi√≥n<br>
                                        <span class="modo-mantenimiento-desc">Abre la vista de pedidos para mostrar en pantalla TV</span>
                                    </div>
                                    <button class="btn-secondary" onclick="window.open('tele.html', '_blank')" title="Abrir pantalla de televisi√≥n para pedidos">
                                        Abrir TV
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="config-general-grid"
                            style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:32px;align-items:end;">
                            <div class="config-form-group" style="width:25rem;">
                                <label for="mensaje-ticket"
                                    style="font-weight:600;display:block;margin-bottom:0.5rem;">Mensaje en el
                                    ticket</label>
                                <input type="text" id="mensaje-ticket" maxlength="80"
                                    placeholder="¬°Gracias por tu compra!"
                                    style="width:25rem;padding:0.625rem 0.875rem;border-radius:0.375rem;border:1px solid #ccc;font-size:1rem;">
                            </div>
                            <div class="config-form-group" style="width:25rem;">
                                <label for="max-unidades-carrito"
                                    style="font-weight:600;display:block;margin-bottom:0.5rem;">M√°ximo de unidades por
                                    producto en el carrito</label>
                                <input type="number" id="max-unidades-carrito" min="1" max="99" step="1"
                                    class="input-max-unidades-carrito"
                                    style="width:25rem;padding:0.625rem 0.875rem;border-radius:0.375rem;border:1px solid #ccc;font-size:1rem;">
                            </div>
                            <div class="config-form-group" style="width:25rem;">
                                <label for="tiempo-inactividad" 
                                    style="font-weight:600;display:block;margin-bottom:0.5rem;">Tiempo M√°ximo de Inactividad
                                    (segundos)</label>
                                <input type="number" id="tiempo-inactividad" min="10" max="300" value="60"
                                    style="width:25rem;padding:0.625rem 0.875rem;border-radius:0.375rem;border:1px solid #ccc;font-size:1rem;">
                            </div>
                        </div>
                        <script>
                            // --- MODO MANTENIMIENTO ---
                            async function cargarConfigGeneral() {
                                try {
                                    // Cargar configuraci√≥n desde el sistema Totem (principal)
                                    const res = await fetch('../../backend/admin/api/configuracion_horarios.php');
                                    const data = await res.json();
                                    if (data && data.success && data.config) {
                                        document.getElementById('chk-modo-mantenimiento').checked = !!data.config.modo_mantenimiento;
                                        if (typeof data.config.max_unidades_carrito !== 'undefined') {
                                            document.getElementById('max-unidades-carrito').value = data.config.max_unidades_carrito;
                                        } else {
                                            document.getElementById('max-unidades-carrito').value = 10;
                                        }
                                        if (typeof data.config.tiempo_inactividad !== 'undefined') {
                                            document.getElementById('tiempo-inactividad').value = data.config.tiempo_inactividad;
                                        } else {
                                            document.getElementById('tiempo-inactividad').value = 300;
                                        }
                                        
                                        console.log('üìã Configuraci√≥n general cargada desde sistema Totem:', data.config);
                                    }
                                } catch (e) { 
                                    console.error('Error cargando configuraci√≥n general:', e);
                                }
                                
                                // Cargar mensaje del ticket
                                await cargarMensajeTicket();
                            }

                            async function guardarConfigGeneral() {
                                // Tomar valores de los inputs
                                const chkMantenimiento = document.getElementById('chk-modo-mantenimiento');
                                const maxUnidadesInput = document.getElementById('max-unidades-carrito');
                                const tiempoInactividadInput = document.getElementById('tiempo-inactividad');
                                
                                console.log('üîß Guardando configuraci√≥n en ambos sistemas...');
                                console.log('üìù Valores del formulario:');
                                console.log('   - Modo mantenimiento:', chkMantenimiento.checked);
                                console.log('   - Max unidades carrito:', maxUnidadesInput.value);
                                console.log('   - Tiempo inactividad (original):', tiempoInactividadInput.value);
                                
                                let errores = [];
                                let exitos = 0;

                                // === GUARDAR EN SISTEMA TOTEM ===
                                try {
                                    let configTotem = {};
                                    const resTotem = await fetch('../../backend/admin/api/configuracion_horarios.php');
                                    const dataTotem = await resTotem.json();
                                    if (dataTotem && dataTotem.success && dataTotem.config) configTotem = dataTotem.config;
                                    
                                    configTotem.modo_mantenimiento = !!chkMantenimiento.checked;
                                    configTotem.max_unidades_carrito = Math.max(1, parseInt(maxUnidadesInput.value) || 10);
                                    configTotem.tiempo_inactividad = Math.max(1, parseInt(tiempoInactividadInput.value) || 300);
                                    
                                    const responseTotem = await fetch('../../backend/admin/api/configuracion_horarios.php', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(configTotem)
                                    });
                                    const resultTotem = await responseTotem.json();
                                    
                                    if (resultTotem.success) {
                                        console.log('‚úÖ Configuraci√≥n del sistema Totem guardada');
                                        exitos++;
                                    } else {
                                        errores.push('Error en sistema Totem: ' + (resultTotem.error || 'Error desconocido'));
                                    }
                                } catch (e) {
                                    console.error('Error al guardar configuraci√≥n del Totem:', e);
                                    errores.push('Error de conexi√≥n con sistema Totem');
                                }

                                // === GUARDAR EN SISTEMA M√ìVIL ===
                                try {
                                    let configMovil = {};
                                    const resMovil = await fetch('../../backend-checkoutpro/admin/api/configuracion_horarios.php');
                                    const dataMovil = await resMovil.json();
                                    if (dataMovil && dataMovil.success && dataMovil.config) configMovil = dataMovil.config;
                                    
                                    configMovil.modo_mantenimiento = !!chkMantenimiento.checked;
                                    configMovil.max_unidades_carrito = Math.max(1, parseInt(maxUnidadesInput.value) || 10);
                                    configMovil.tiempo_inactividad = Math.max(1, parseInt(tiempoInactividadInput.value) || 300);
                                    
                                    const responseMovil = await fetch('../../backend-checkoutpro/admin/api/configuracion_horarios.php', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(configMovil)
                                    });
                                    const resultMovil = await responseMovil.json();
                                    
                                    if (resultMovil.success) {
                                        console.log('‚úÖ Configuraci√≥n del sistema M√≥vil guardada');
                                        exitos++;
                                    } else {
                                        errores.push('Error en sistema M√≥vil: ' + (resultMovil.error || 'Error desconocido'));
                                    }
                                } catch (e) {
                                    console.error('Error al guardar configuraci√≥n del M√≥vil:', e);
                                    errores.push('Error de conexi√≥n con sistema M√≥vil');
                                }

                                // === MOSTRAR RESULTADO ===
                                if (exitos === 2) {
                                    mostrarConfirmacion('Configuraci√≥n guardada en ambos sistemas', 'success');
                                    console.log('‚úÖ Configuraci√≥n guardada en ambos sistemas con √©xito');
                                } else if (exitos === 1) {
                                    mostrarConfirmacion(`Configuraci√≥n parcialmente guardada. Errores: ${errores.join(', ')}`, 'warning');
                                    console.warn('‚ö†Ô∏è Guardado parcial:', errores);
                                } else {
                                    mostrarConfirmacion(`Error al guardar: ${errores.join(', ')}`, 'error');
                                    console.error('‚ùå Errores:', errores);
                                }
                            }

                            function mostrarConfirmacion(mensaje, tipo = 'success') {
                                // Remover notificaci√≥n anterior si existe
                                const notificationExistente = document.getElementById('notification-toast');
                                if (notificationExistente) {
                                    notificationExistente.remove();
                                }

                                // Crear nueva notificaci√≥n
                                const notification = document.createElement('div');
                                notification.id = 'notification-toast';
                                let bgColor = '#e74c3c'; // Error (rojo)
                                if (tipo === 'success') bgColor = '#27ae60'; // √âxito (verde)
                                if (tipo === 'warning') bgColor = '#f39c12'; // Advertencia (naranja)
                                
                                notification.style.cssText = `
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    padding: 15px 20px;
                                    border-radius: 8px;
                                    color: white;
                                    font-weight: bold;
                                    z-index: 10000;
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                    transform: translateX(100%);
                                    transition: transform 0.3s ease-out;
                                    max-width: 300px;
                                    background: ${bgColor};
                                `;
                                notification.textContent = mensaje;
                                
                                document.body.appendChild(notification);
                                
                                // Animar entrada
                                setTimeout(() => {
                                    notification.style.transform = 'translateX(0)';
                                }, 100);
                                
                                // Remover despu√©s de 3 segundos
                                setTimeout(() => {
                                    notification.style.transform = 'translateX(100%)';
                                    setTimeout(() => {
                                        if (notification.parentNode) {
                                            notification.remove();
                                        }
                                    }, 300);
                                }, 3000);
                            }

                            document.addEventListener('DOMContentLoaded', function () {
                                // Cargar config general al abrir panel general
                                const generalTab = Array.from(document.querySelectorAll('.config-tab')).find(t => t.textContent.trim().toLowerCase().includes('general'));
                                if (generalTab) {
                                    generalTab.addEventListener('click', function () {
                                        setTimeout(cargarConfigGeneral, 100);
                                    });
                                }
                                // Listener para checkbox modo mantenimiento y max unidades carrito
                                const chkMantenimiento = document.getElementById('chk-modo-mantenimiento');
                                const maxUnidadesInput = document.getElementById('max-unidades-carrito');
                                const tiempoInactividadInput = document.getElementById('tiempo-inactividad');
                                if (chkMantenimiento) {
                                    chkMantenimiento.addEventListener('change', guardarConfigGeneral);
                                }
                                if (maxUnidadesInput) {
                                    maxUnidadesInput.addEventListener('change', guardarConfigGeneral);
                                }
                                if (tiempoInactividadInput) {
                                    tiempoInactividadInput.addEventListener('change', guardarConfigGeneral);
                                }
                                
                                // Listener para mensaje del ticket
                                const mensajeTicketInput = document.getElementById('mensaje-ticket');
                                if (mensajeTicketInput) {
                                    mensajeTicketInput.addEventListener('blur', guardarMensajeTicket);
                                    mensajeTicketInput.addEventListener('keypress', function(e) {
                                        if (e.key === 'Enter') {
                                            e.target.blur(); // Dispara el evento blur que guarda
                                        }
                                    });
                                }
                                
                                // Cargar si panel general es el primero
                                if (document.querySelector('.config-panel:not([id])').style.display !== 'none') {
                                    setTimeout(cargarConfigGeneral, 100);
                                }
                            });
                            
                            // === FUNCIONES PARA MENSAJE DEL TICKET ===
                            async function cargarMensajeTicket() {
                                try {
                                    const response = await fetch('../../backend/admin/api/get_ticket_message.php');
                                    const data = await response.json();
                                    
                                    if (data.success && data.mensaje) {
                                        const input = document.getElementById('mensaje-ticket');
                                        if (input) {
                                            input.value = data.mensaje;
                                            console.log('üìù Mensaje del ticket cargado:', data.mensaje);
                                        }
                                    }
                                } catch (error) {
                                    console.error('Error al cargar mensaje del ticket:', error);
                                }
                            }
                            
                            async function guardarMensajeTicket() {
                                const input = document.getElementById('mensaje-ticket');
                                if (!input) return;
                                
                                const mensaje = input.value.trim();
                                
                                // Validaci√≥n b√°sica
                                if (mensaje.length > 80) {
                                    mostrarNotificacionMensaje('El mensaje no puede exceder 80 caracteres', 'error');
                                    return;
                                }
                                
                                if (mensaje === '') {
                                    mostrarNotificacionMensaje('El mensaje no puede estar vac√≠o', 'error');
                                    return;
                                }
                                
                                try {
                                    const response = await fetch('../../backend/admin/api/save_ticket_message.php', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ mensaje: mensaje })
                                    });
                                    
                                    const data = await response.json();
                                    
                                    if (data.success) {
                                        mostrarNotificacionMensaje('Mensaje del ticket guardado correctamente', 'success');
                                        console.log('‚úÖ Mensaje del ticket guardado:', mensaje);
                                    } else {
                                        mostrarNotificacionMensaje('Error: ' + (data.error || 'Error desconocido'), 'error');
                                    }
                                } catch (error) {
                                    console.error('Error al guardar mensaje del ticket:', error);
                                    mostrarNotificacionMensaje('Error de conexi√≥n al guardar mensaje', 'error');
                                }
                            }
                            
                            function mostrarNotificacionMensaje(mensaje, tipo = 'success') {
                                // Remover notificaci√≥n anterior del mensaje si existe
                                const notificationExistente = document.getElementById('notification-mensaje-ticket');
                                if (notificationExistente) {
                                    notificationExistente.remove();
                                }
                                
                                // Crear nueva notificaci√≥n
                                const notification = document.createElement('div');
                                notification.id = 'notification-mensaje-ticket';
                                notification.style.cssText = `
                                    position: fixed;
                                    top: 20px;
                                    right: 20px;
                                    padding: 12px 20px;
                                    border-radius: 6px;
                                    color: white;
                                    font-weight: 500;
                                    z-index: 10000;
                                    max-width: 350px;
                                    word-wrap: break-word;
                                    background: ${tipo === 'success' ? '#10b981' : tipo === 'error' ? '#ef4444' : '#f59e0b'};
                                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                                    transform: translateX(100%);
                                    transition: transform 0.3s ease;
                                `;
                                notification.textContent = mensaje;
                                
                                document.body.appendChild(notification);
                                
                                // Animar entrada
                                setTimeout(() => {
                                    notification.style.transform = 'translateX(0)';
                                }, 10);
                                
                                // Auto-remover despu√©s de 3 segundos
                                setTimeout(() => {
                                    if (notification.parentNode) {
                                        notification.style.transform = 'translateX(100%)';
                                        setTimeout(() => {
                                            if (notification.parentNode) {
                                                notification.remove();
                                            }
                                        }, 300);
                                    }
                                }, 3000);
                            }
                        </script>

                    </div>
                    <div class="config-panel" id="panel-pagos" style="display:none">
                        <div class="config-panel-title"><span style="font-size:1.2em"><img src="../assets/images/Iconos/etiqueta_color.svg" class="icon-svg" alt="Productos"></span> M√©todos de Pago</div>
                        <div style="margin-bottom:18px;color:#888;">Configura los m√©todos de pago disponibles</div>
                        <div class="pagos-metodos">
                            <div class="pago-metodo">
                                <span>üíµ</span> Efectivo<br><span class="pago-metodo-desc">Pago en efectivo en
                                    caja</span>
                                <input type="checkbox" id="chk-metodo-efectivo" style="float:right;" checked>
                            </div>
                            <div class="pago-metodo">
                                <span>üè¶</span> Transferencia Bancaria<br><span class="pago-metodo-desc">QR para
                                    transferencias</span>
                                <input type="checkbox" id="chk-metodo-qr" style="float:right;" checked>
                            </div>
                        </div>
                        <!-- Monto M√≠nimo para Sistema Totem (QR) -->
                        <div class="monto-minimo-group">
                            <label for="input-monto-minimo-mp-totem" class="monto-minimo-label">
                                <span class="monto-minimo-icon">üí∞</span> Monto M√≠nimo para Mercado Pago (Totem)
                            </label>
                            <div class="monto-minimo-input-row">
                                <input type="number" min="0" step="0.01" id="input-monto-minimo-mp-totem"
                                    class="monto-minimo-input" placeholder="Cargando...">
                                <button id="btn-guardar-monto-minimo-totem"
                                    class="btn-green monto-minimo-btn">Guardar</button>
                            </div>
                            <div id="monto-minimo-msg-totem" class="monto-minimo-msg">¬°Monto m√≠nimo guardado!</div>
                        </div>
                        
                        <!-- Monto M√≠nimo para Sistema M√≥vil (Checkout Pro) -->
                        <div class="monto-minimo-group">
                            <label for="input-monto-minimo-mp-movil" class="monto-minimo-label">
                                <span class="monto-minimo-icon">üì±</span> Monto M√≠nimo para Mercado Pago (M√≥vil)
                            </label>
                            <div class="monto-minimo-input-row">
                                <input type="number" min="0" step="0.01" id="input-monto-minimo-mp-movil"
                                    class="monto-minimo-input" placeholder="Cargando...">
                                <button id="btn-guardar-monto-minimo-movil"
                                    class="btn-green monto-minimo-btn">Guardar</button>
                            </div>
                            <div id="monto-minimo-msg-movil" class="monto-minimo-msg">¬°Monto m√≠nimo guardado!</div>
                        </div>
                        <script>
                            // --- L√≥gica de carga y guardado de monto m√≠nimo Mercado Pago ---

                            // Variable para prevenir sobrescritura durante edici√≥n
                            let userEditingInputs = {
                                totem: false,
                                movil: false
                            };

                            async function cargarConfigPagos() {
                                try {
                                    console.log('üîÑ Cargando configuraci√≥n de pagos...');
                                    console.log('üîó BACKEND_API detectado:', BACKEND_API);
                                    
                                    // Verificar que los elementos existan antes de continuar
                                    const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                    const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                    
                                    if (!inputTotem || !inputMovil) {
                                        console.error('‚ùå Elementos de input no encontrados, abortando carga');
                                        return;
                                    }
                                    
                                    // NO CARGAR si el usuario est√° escribiendo activamente
                                    if (userEditingInputs.totem || userEditingInputs.movil) {
                                        console.log('‚è∏Ô∏è Usuario editando inputs, saltando carga autom√°tica');
                                        return;
                                    }
                                    
                                    console.log('üîó Elementos encontrados, procediendo con la carga...');
                                    
                                    // Configurar URLs de ambos backends
                                    const backendTotem = BACKEND_API.includes('backend-checkoutpro') 
                                        ? BACKEND_API.replace('backend-checkoutpro', 'backend')
                                        : BACKEND_API;
                                    const backendMovil = BACKEND_API.includes('backend-checkoutpro') 
                                        ? BACKEND_API
                                        : BACKEND_API.replace('backend', 'backend-checkoutpro');
                                    
                                    const apiUrlTotem = `${backendTotem}/admin/api/configuracion_horarios.php`;
                                    const apiUrlMovil = `${backendMovil}/admin/api/configuracion_horarios.php`;
                                    
                                    console.log('üéØ URL API Totem:', apiUrlTotem);
                                    console.log('üéØ URL API M√≥vil:', apiUrlMovil);
                                    
                                    // Cargar configuraci√≥n del sistema Totem (QR)
                                    console.log('üì° Cargando desde sistema Totem...');
                                    try {
                                        const resTotem = await fetch(apiUrlTotem);
                                        const dataTotem = await resTotem.json();
                                        console.log('üì• Respuesta Totem:', dataTotem);
                                        
                                        if (dataTotem && dataTotem.success && dataTotem.config) {
                                            // Monto m√≠nimo Totem - Solo cargar si NO est√° siendo editado
                                            const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                            if (inputTotem && !userEditingInputs.totem) {
                                                if (typeof dataTotem.config.monto_minimo_mp !== 'undefined') {
                                                    inputTotem.value = parseFloat(dataTotem.config.monto_minimo_mp).toFixed(2);
                                                    console.log('üí∞ Monto m√≠nimo Totem cargado:', dataTotem.config.monto_minimo_mp);
                                                } else {
                                                    inputTotem.value = '0.00';
                                                    console.log('üí∞ Monto m√≠nimo Totem valor por defecto: 0.00');
                                                }
                                            } else if (userEditingInputs.totem) {
                                                console.log('‚è∏Ô∏è Saltando carga Totem - usuario editando');
                                            }
                                            
                                            // M√©todos de pago
                                            const chkEfectivo = document.getElementById('chk-metodo-efectivo');
                                            const chkQR = document.getElementById('chk-metodo-qr');
                                            
                                            if (dataTotem.config.metodos_pago) {
                                                if (chkEfectivo) chkEfectivo.checked = !!dataTotem.config.metodos_pago.efectivo;
                                                if (chkQR) chkQR.checked = !!dataTotem.config.metodos_pago.qr;
                                            } else {
                                                // Si no hay config, ambos activados
                                                if (chkEfectivo) chkEfectivo.checked = true;
                                                if (chkQR) chkQR.checked = true;
                                            }
                                        }
                                    } catch (e) {
                                        console.error('‚ùå Error cargando configuraci√≥n Totem:', e);
                                    }
                                    
                                    // Cargar configuraci√≥n del sistema M√≥vil (Checkout Pro)
                                    console.log('üì° Cargando desde sistema M√≥vil...');
                                    try {
                                        const resMovil = await fetch(apiUrlMovil);
                                        const dataMovil = await resMovil.json();
                                        console.log('üì• Respuesta M√≥vil:', dataMovil);
                                        
                                        if (dataMovil && dataMovil.success && dataMovil.config) {
                                            // Monto m√≠nimo M√≥vil - Solo cargar si NO est√° siendo editado
                                            const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                            if (inputMovil && !userEditingInputs.movil) {
                                                if (typeof dataMovil.config.monto_minimo_mp !== 'undefined') {
                                                    inputMovil.value = parseFloat(dataMovil.config.monto_minimo_mp).toFixed(2);
                                                    console.log('üì± Monto m√≠nimo M√≥vil cargado:', dataMovil.config.monto_minimo_mp);
                                                } else {
                                                    inputMovil.value = '0.00';
                                                    console.log('üì± Monto m√≠nimo M√≥vil valor por defecto: 0.00');
                                                }
                                            } else if (userEditingInputs.movil) {
                                                console.log('‚è∏Ô∏è Saltando carga M√≥vil - usuario editando');
                                            }
                                        }
                                    } catch (e) {
                                        console.error('‚ùå Error cargando configuraci√≥n M√≥vil:', e);
                                    }
                                    
                                    console.log('‚úÖ Configuraci√≥n de pagos cargada exitosamente');
                                } catch (e) {
                                    console.error('‚ùå Error general cargando configuraci√≥n de pagos:', e);
                                    // Si hay error, valores por defecto
                                    const chkEfectivo = document.getElementById('chk-metodo-efectivo');
                                    const chkQR = document.getElementById('chk-metodo-qr');
                                    const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                    const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                    
                                    if (chkEfectivo) chkEfectivo.checked = true;
                                    if (chkQR) chkQR.checked = true;
                                    if (inputTotem) inputTotem.value = '0.00';
                                    if (inputMovil) inputMovil.value = '0.00';
                                    
                                    console.log('‚ö†Ô∏è Valores por defecto asignados por error de conexi√≥n');
                                }
                            }

                            // Configurar protecci√≥n de inputs contra sobrescritura
                            function configurarProteccionInputs() {
                                console.log("üõ°Ô∏è Configurando protecci√≥n de inputs...");
                                
                                const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                
                                if (inputTotem) {
                                    // Cuando el usuario hace focus, marcar como editando
                                    inputTotem.addEventListener('focus', function() {
                                        userEditingInputs.totem = true;
                                        console.log('‚úèÔ∏è Usuario editando Totem - protecci√≥n ON');
                                    });
                                    
                                    // Cuando pierde focus, quitar protecci√≥n despu√©s de un breve delay
                                    inputTotem.addEventListener('blur', function() {
                                        setTimeout(() => {
                                            userEditingInputs.totem = false;
                                            console.log('‚úÖ Protecci√≥n Totem OFF - permitir carga');
                                        }, 100);
                                    });
                                    
                                    // Durante la escritura, mantener protecci√≥n
                                    inputTotem.addEventListener('input', function() {
                                        userEditingInputs.totem = true;
                                    });
                                }
                                
                                if (inputMovil) {
                                    // Cuando el usuario hace focus, marcar como editando
                                    inputMovil.addEventListener('focus', function() {
                                        userEditingInputs.movil = true;
                                        console.log('‚úèÔ∏è Usuario editando M√≥vil - protecci√≥n ON');
                                    });
                                    
                                    // Cuando pierde focus, quitar protecci√≥n despu√©s de un breve delay
                                    inputMovil.addEventListener('blur', function() {
                                        setTimeout(() => {
                                            userEditingInputs.movil = false;
                                            console.log('‚úÖ Protecci√≥n M√≥vil OFF - permitir carga');
                                        }, 100);
                                    });
                                    
                                    // Durante la escritura, mantener protecci√≥n
                                    inputMovil.addEventListener('input', function() {
                                        userEditingInputs.movil = true;
                                    });
                                }

                                // Funci√≥n de testing para verificar protecci√≥n
                                window.testearProteccion = function() {
                                    console.log('üß™ Testeando protecci√≥n de inputs...');
                                    console.log('Estado actual userEditingInputs:', userEditingInputs);
                                    
                                    // Simular carga mientras usuario edita
                                    const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                    if (inputTotem) {
                                        inputTotem.focus();
                                        setTimeout(() => {
                                            console.log('Llamando cargarConfigPagos() mientras usuario edita...');
                                            cargarConfigPagos();
                                        }, 1000);
                                    }
                                };
                            }


                            // Guardar configuraci√≥n para sistema Totem (QR)
                            async function guardarConfigTotem(esMetodoPago = false, metodoHabilitado = null) {
                                console.log('üíæ Guardando configuraci√≥n del sistema Totem...');
                                console.log('üîó Usando BACKEND_API:', BACKEND_API);
                                
                                // Tomar valores de los inputs
                                const input = document.getElementById('input-monto-minimo-mp-totem');
                                if (!input) {
                                    console.error('‚ùå No se encontr√≥ el input del monto m√≠nimo Totem');
                                    return;
                                }
                                
                                let monto = parseFloat(input.value);
                                if (isNaN(monto) || monto < 0) monto = 0;
                                console.log('üí∞ Monto a guardar:', monto);
                                
                                const chkEfectivo = document.getElementById('chk-metodo-efectivo');
                                const chkQR = document.getElementById('chk-metodo-qr');
                                
                                // Usar la API del backend correcto (siempre backend original para Totem)
                                const backendTotem = BACKEND_API.includes('backend-checkoutpro') 
                                    ? BACKEND_API.replace('backend-checkoutpro', 'backend')
                                    : BACKEND_API;
                                const apiUrl = `${backendTotem}/admin/api/configuracion_horarios.php`;
                                console.log('üéØ URL API Totem:', apiUrl);
                                
                                // Cargar config actual para no pisar horarios
                                let config = {};
                                try {
                                    const res = await fetch(apiUrl);
                                    const data = await res.json();
                                    if (data && data.success && data.config) {
                                        config = data.config;
                                        console.log('üì• Config actual cargada:', config);
                                    }
                                } catch (e) { 
                                    console.warn('‚ö†Ô∏è Error cargando config actual:', e);
                                }
                                
                                config.monto_minimo_mp = monto;
                                if (!esMetodoPago) {
                                    config.metodos_pago = {
                                        efectivo: !!chkEfectivo?.checked,
                                        qr: !!chkQR?.checked
                                    };
                                } else {
                                    config.metodos_pago = {
                                        efectivo: !!chkEfectivo?.checked,
                                        qr: !!chkQR?.checked
                                    };
                                }
                                
                                console.log('üì§ Enviando config:', config);
                                
                                try {
                                    const res = await fetch(apiUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(config)
                                    });
                                    const data = await res.json();
                                    console.log('üì• Respuesta del servidor:', data);
                                    
                                    if (data && data.success) {
                                        if (esMetodoPago) {
                                            mostrarMensajeMetodoPago(metodoHabilitado);
                                        } else {
                                            mostrarMensajeMontoMinimo('totem');
                                        }
                                        console.log('‚úÖ Configuraci√≥n Totem guardada exitosamente');
                                    } else {
                                        console.error('‚ùå Error del servidor:', data);
                                        alert('Error al guardar la configuraci√≥n de pagos del Totem: ' + (data.error || 'Error desconocido'));
                                    }
                                } catch (e) {
                                    console.error('‚ùå Error de conexi√≥n:', e);
                                    alert('Error de conexi√≥n al guardar configuraci√≥n de pagos del Totem: ' + e.message);
                                }
                            }

                            // Guardar configuraci√≥n para sistema M√≥vil (Checkout Pro)
                            async function guardarConfigMovil() {
                                console.log('üíæ Guardando configuraci√≥n del sistema M√≥vil...');
                                console.log('üîó Usando BACKEND_API:', BACKEND_API);
                                
                                // Tomar valores de los inputs
                                const input = document.getElementById('input-monto-minimo-mp-movil');
                                if (!input) {
                                    console.error('‚ùå No se encontr√≥ el input del monto m√≠nimo M√≥vil');
                                    return;
                                }
                                
                                let monto = parseFloat(input.value);
                                if (isNaN(monto) || monto < 0) monto = 0;
                                console.log('üí∞ Monto a guardar:', monto);
                                
                                // Usar la API del backend correcto (siempre backend-checkoutpro para M√≥vil)
                                const backendMovil = BACKEND_API.includes('backend-checkoutpro') 
                                    ? BACKEND_API
                                    : BACKEND_API.replace('backend', 'backend-checkoutpro');
                                const apiUrl = `${backendMovil}/admin/api/configuracion_horarios.php`;
                                console.log('üéØ URL API M√≥vil:', apiUrl);
                                
                                // Cargar config actual para no pisar horarios
                                let config = {};
                                try {
                                    const res = await fetch(apiUrl);
                                    const data = await res.json();
                                    if (data && data.success && data.config) {
                                        config = data.config;
                                        console.log('üì• Config actual cargada:', config);
                                    }
                                } catch (e) { 
                                    console.warn('‚ö†Ô∏è Error cargando config actual:', e);
                                }
                                
                                config.monto_minimo_mp = monto;
                                console.log('üì§ Enviando config:', config);
                                
                                try {
                                    const res = await fetch(apiUrl, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(config)
                                    });
                                    const data = await res.json();
                                    console.log('üì• Respuesta del servidor:', data);
                                    
                                    if (data && data.success) {
                                        mostrarMensajeMontoMinimo('movil');
                                        console.log('‚úÖ Configuraci√≥n M√≥vil guardada exitosamente');
                                    } else {
                                        console.error('‚ùå Error del servidor:', data);
                                        alert('Error al guardar la configuraci√≥n de pagos del sistema M√≥vil: ' + (data.error || 'Error desconocido'));
                                    }
                                } catch (e) {
                                    console.error('‚ùå Error de conexi√≥n:', e);
                                    alert('Error de conexi√≥n al guardar configuraci√≥n de pagos del sistema M√≥vil: ' + e.message);
                                }
                            }

                            function mostrarMensajeMontoMinimo(sistema = 'totem') {
                                const msgId = sistema === 'movil' ? 'monto-minimo-msg-movil' : 'monto-minimo-msg-totem';
                                const msg = document.getElementById(msgId);
                                
                                if (!msg) {
                                    console.error(`‚ùå No se encontr√≥ el elemento de mensaje: ${msgId}`);
                                    return;
                                }
                                
                                const sistemaTexto = sistema === 'movil' ? 'M√≥vil' : 'Totem';
                                msg.textContent = `¬°Monto m√≠nimo del sistema ${sistemaTexto} guardado!`;
                                msg.style.display = 'block';
                                msg.style.opacity = '1';
                                setTimeout(() => {
                                    msg.style.opacity = '0';
                                    setTimeout(() => { msg.style.display = 'none'; msg.style.opacity = '1'; }, 400);
                                }, 1800);
                                
                                console.log(`‚úÖ Mensaje mostrado para sistema ${sistemaTexto}`);
                            }

                            function mostrarMensajeMetodoPago(habilitado) {
                                const msg = document.getElementById('monto-minimo-msg-totem');
                                if (habilitado) {
                                    msg.textContent = '¬°M√©todo de pago habilitado!';
                                } else {
                                    msg.textContent = '¬°M√©todo de pago deshabilitado!';
                                }
                                msg.style.display = 'block';
                                msg.style.opacity = '1';
                                setTimeout(() => {
                                    msg.style.opacity = '0';
                                    setTimeout(() => { msg.style.display = 'none'; msg.style.opacity = '1'; }, 400);
                                }, 1800);
                            }

                            document.addEventListener('DOMContentLoaded', function () {
                                console.log('üöÄ DOMContentLoaded - Inicializando montos m√≠nimos...');
                                
                                // Verificar elementos clave
                                const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                const btnTotem = document.getElementById('btn-guardar-monto-minimo-totem');
                                const btnMovil = document.getElementById('btn-guardar-monto-minimo-movil');
                                
                                console.log('üîç Verificaci√≥n de elementos:');
                                console.log('   - Input Totem:', inputTotem ? 'OK' : 'FALTANTE');
                                console.log('   - Input M√≥vil:', inputMovil ? 'OK' : 'FALTANTE');
                                console.log('   - Bot√≥n Totem:', btnTotem ? 'OK' : 'FALTANTE');
                                console.log('   - Bot√≥n M√≥vil:', btnMovil ? 'OK' : 'FALTANTE');
                                
                                // Cargar config pagos al abrir panel pagos
                                const pagosTab = Array.from(document.querySelectorAll('.config-tab')).find(t => t.textContent.trim().toLowerCase().includes('pago'));
                                if (pagosTab) {
                                    pagosTab.addEventListener('click', function () {
                                        console.log('üéØ Click en pesta√±a de pagos - Cargando configuraci√≥n...');
                                        setTimeout(() => {
                                            cargarConfigPagos();
                                            // Doble verificaci√≥n despu√©s de un momento
                                            setTimeout(() => {
                                                const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                                const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                                if (inputTotem && inputMovil && (inputTotem.value === '' || inputTotem.placeholder === 'Cargando...')) {
                                                    console.log('üîÑ Segundo intento de carga despu√©s del click...');
                                                    cargarConfigPagos();
                                                }
                                            }, 1000);
                                        }, 100);
                                    });
                                    console.log('‚úÖ Event listener agregado para pesta√±a de pagos');
                                } else {
                                    console.warn('‚ö†Ô∏è No se encontr√≥ la pesta√±a de pagos');
                                }
                                // Listener guardar Totem
                                const btnGuardarTotem = document.getElementById('btn-guardar-monto-minimo-totem');
                                if (btnGuardarTotem) {
                                    btnGuardarTotem.addEventListener('click', function () {
                                        console.log('üéØ Click en bot√≥n guardar Totem');
                                        guardarConfigTotem();
                                    });
                                    console.log('‚úÖ Event listener agregado para bot√≥n guardar Totem');
                                } else {
                                    console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n guardar Totem');
                                }
                                
                                // Listener guardar M√≥vil
                                const btnGuardarMovil = document.getElementById('btn-guardar-monto-minimo-movil');
                                if (btnGuardarMovil) {
                                    btnGuardarMovil.addEventListener('click', function () {
                                        console.log('üéØ Click en bot√≥n guardar M√≥vil');
                                        guardarConfigMovil();
                                    });
                                    console.log('‚úÖ Event listener agregado para bot√≥n guardar M√≥vil');
                                } else {
                                    console.warn('‚ö†Ô∏è No se encontr√≥ el bot√≥n guardar M√≥vil');
                                }
                                
                                // Listener para checkboxes de m√©todos de pago (guardar al click)
                                const chkEfectivo = document.getElementById('chk-metodo-efectivo');
                                const chkQR = document.getElementById('chk-metodo-qr');
                                if (chkEfectivo) {
                                    chkEfectivo.addEventListener('change', function() {
                                        guardarConfigTotem(true, this.checked);
                                    });
                                }
                                if (chkQR) {
                                    chkQR.addEventListener('change', function() {
                                        guardarConfigTotem(true, this.checked);
                                    });
                                }
                                // Cargar si panel pagos es el primero o est√° activo
                                const panelPagos = document.getElementById('panel-pagos');
                                if (panelPagos && (panelPagos.style.display === '' || panelPagos.style.display !== 'none')) {
                                    console.log('üîÑ Panel de pagos ya activo - Cargando configuraci√≥n inicial...');
                                    setTimeout(cargarConfigPagos, 100);
                                } else {
                                    console.log('‚ÑπÔ∏è Panel de pagos no est√° activo inicialmente');
                                }
                                
                                // Tambi√©n cargar la configuraci√≥n cuando se detecte que est√° en la pesta√±a correcta
                                setTimeout(() => {
                                    const configTab = localStorage.getItem('configTab');
                                    console.log('üìã Pesta√±a guardada en localStorage:', configTab);
                                    
                                    if (configTab === 'pagos') {
                                        console.log('üîÑ Detectada pesta√±a pagos guardada - Cargando configuraci√≥n...');
                                        cargarConfigPagos();
                                    }
                                    
                                    // Tambi√©n verificar si la pesta√±a pagos est√° activa visualmente
                                    const activeTab = document.querySelector('.config-tab.active');
                                    if (activeTab && activeTab.textContent.trim().toLowerCase().includes('pago')) {
                                        console.log('üîÑ Detectada pesta√±a pagos activa visualmente - Cargando configuraci√≥n...');
                                        cargarConfigPagos();
                                    }
                                }, 500);

                                // CARGA FORZADA cada 3 segundos hasta que los valores se carguen correctamente
                                let intentos = 0;
                                const intervaloCarga = setInterval(() => {
                                    intentos++;
                                    const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                    const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                    
                                    if (inputTotem && inputMovil && (inputTotem.value === '' || inputTotem.placeholder === 'Cargando...')) {
                                        console.log(`üîÑ Intento ${intentos} de carga autom√°tica...`);
                                        cargarConfigPagos();
                                    } else if (inputTotem && inputMovil && inputTotem.value !== '' && inputMovil.value !== '') {
                                        console.log('‚úÖ Valores cargados correctamente, deteniendo intentos autom√°ticos');
                                        clearInterval(intervaloCarga);
                                    }
                                    
                                    // M√°ximo 10 intentos (30 segundos)
                                    if (intentos >= 10) {
                                        console.log('‚è∞ M√°ximo de intentos alcanzado');
                                        clearInterval(intervaloCarga);
                                    }
                                }, 3000);
                                
                                console.log('‚úÖ Inicializaci√≥n de montos m√≠nimos completada');
                                
                                // Funci√≥n de debug para probar manualmente
                                window.debugMontos = function() {
                                    console.log('üß™ Ejecutando debug de montos m√≠nimos...');
                                    cargarConfigPagos();
                                };
                                
                                // CARGA INMEDIATA: Intentar cargar los valores reales inmediatamente
                                console.log('üöÄ Intentando carga inmediata de configuraci√≥n...');
                                setTimeout(() => {
                                    cargarConfigPagos();
                                }, 100);
                                
                                // Probar despu√©s de 2 segundos si los elementos no se encontraron
                                setTimeout(() => {
                                    const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                    const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                    
                                    if (!inputTotem || !inputMovil) {
                                        console.log('üîÑ Reintentando carga - elementos no encontrados...');
                                        cargarConfigPagos();
                                    } else if (inputTotem.value === '' || inputMovil.value === '') {
                                        console.log('üîÑ Reintentando carga - valores vac√≠os detectados...');
                                        cargarConfigPagos();
                                    }
                                }, 2000);

                                // Configurar protecci√≥n de inputs
                                console.log('üõ°Ô∏è Configurando protecci√≥n contra sobrescritura...');
                                configurarProteccionInputs();
                            });

                            // CARGA ADICIONAL cuando la ventana est√© completamente cargada
                            window.addEventListener('load', function() {
                                console.log('üåê Window load event - Ejecutando carga final de configuraci√≥n...');
                                setTimeout(() => {
                                    const inputTotem = document.getElementById('input-monto-minimo-mp-totem');
                                    const inputMovil = document.getElementById('input-monto-minimo-mp-movil');
                                    
                                    if (inputTotem && inputMovil) {
                                        console.log('üîÑ Carga final de configuraci√≥n de pagos...');
                                        cargarConfigPagos();
                                    }
                                }, 500);
                            });
                        </script>
                    </div>
                    <div class="config-panel" id="panel-horarios" style="display:none">
                        <div class="config-panel-title"><span style="font-size:1.2em">‚è∞</span> Horarios de Atenci√≥n
                        </div>
                        <div style="margin-bottom:18px;color:#888;">Define los horarios en los que el t√≥tem estar√°
                            disponible
                        </div>
                        <div class="config-general-grid" style="margin-bottom:18px;">
                            <div id="horarios-inputs" style="display:flex;flex-direction:column;gap:12px;"></div>
                            <button id="btn-guardar-horarios" class="btn-green"
                                style="align-self:flex-end;margin-top:12px;max-width:220px;">Guardar Cambios</button>
                        </div>
                        <div id="horarios-guardado-msg"
                            style="display:none;color:green;margin-top:8px;font-weight:600;">
                            ¬°Horarios
                            guardados!</div>
                        <script>
                            // --- L√≥gica de carga y guardado de horarios ---
                            const diasSemana = [
                                'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'
                            ];
                            // Renderiza los inputs de horarios seg√∫n config
                            function renderHorariosInputs(config) {
                                const cont = document.getElementById('horarios-inputs');
                                cont.innerHTML = '';
                                if (!config) config = {};
                                // Checkbox general
                                const generalChecked = config.habilitar_horarios === false ? false : true;
                                const generalDiv = document.createElement('div');
                                generalDiv.style.display = 'flex';
                                generalDiv.style.alignItems = 'center';
                                generalDiv.style.gap = '10px';
                                generalDiv.innerHTML = `
                <label style="font-weight:600;min-width:120px;">Habilitar horarios</label>
                <input type="checkbox" id="chk-habilitar-horarios" ${generalChecked ? 'checked' : ''}>
                <span style="color:#888;font-size:14px;">(Si se desactiva, el t√≥tem estar√° siempre habilitado)</span>
              `;
                                cont.appendChild(generalDiv);
                                // Por cada d√≠a
                                diasSemana.forEach((dia, idx) => {
                                    const diaKey = dia.toLowerCase();
                                    const diaConf = (config.dias && config.dias[diaKey]) || { habilitado: true, desde: '07:30', hasta: '13:00' };
                                    const row = document.createElement('div');
                                    row.style.display = 'grid';
                                    row.style.gridTemplateColumns = 'minmax(90px,1fr) 40px 110px 30px 110px';
                                    row.style.alignItems = 'center';
                                    row.style.gap = '8px';
                                    row.innerHTML = `
                  <label style="font-weight:500;">${dia}</label>
                  <input type="checkbox" class="chk-dia-habilitado" data-dia="${diaKey}" ${diaConf.habilitado ? 'checked' : ''}>
                  <input type="time" class="input-hora-desde" data-dia="${diaKey}" value="${diaConf.desde || '07:30'}" ${diaConf.habilitado ? '' : 'disabled'}>
                  <span style="font-size:13px;">a</span>
                  <input type="time" class="input-hora-hasta" data-dia="${diaKey}" value="${diaConf.hasta || '13:00'}" ${diaConf.habilitado ? '' : 'disabled'}>
                `;
                                    cont.appendChild(row);
                                });
                                // Listeners para habilitar/deshabilitar inputs por d√≠a
                                cont.querySelectorAll('.chk-dia-habilitado').forEach(chk => {
                                    chk.addEventListener('change', function () {
                                        const dia = this.getAttribute('data-dia');
                                        const desde = cont.querySelector(`.input-hora-desde[data-dia="${dia}"]`);
                                        const hasta = cont.querySelector(`.input-hora-hasta[data-dia="${dia}"]`);
                                        desde.disabled = !this.checked;
                                        hasta.disabled = !this.checked;
                                    });
                                });
                            }

                            // Cargar config de horarios al abrir el panel
                            async function cargarConfigHorarios() {
                                try {
                                    const res = await fetch(BACKEND_API + '/admin/api/configuracion_horarios.php');
                                    const data = await res.json();
                                    if (data && data.success && data.config) {
                                        renderHorariosInputs(data.config);
                                    } else {
                                        renderHorariosInputs();
                                    }
                                } catch (e) {
                                    renderHorariosInputs();
                                }
                            }

                            // Guardar config de horarios
                            async function guardarConfigHorarios() {
                                const cont = document.getElementById('horarios-inputs');
                                const config = { habilitar_horarios: cont.querySelector('#chk-habilitar-horarios').checked, dias: {} };
                                diasSemana.forEach(dia => {
                                    const diaKey = dia.toLowerCase();
                                    const chk = cont.querySelector(`.chk-dia-habilitado[data-dia="${diaKey}"]`);
                                    const desde = cont.querySelector(`.input-hora-desde[data-dia="${diaKey}"]`);
                                    const hasta = cont.querySelector(`.input-hora-hasta[data-dia="${diaKey}"]`);
                                    config.dias[diaKey] = {
                                        habilitado: chk.checked,
                                        desde: desde.value,
                                        hasta: hasta.value
                                    };
                                });
                                try {
                                    const res = await fetch(BACKEND_API + '/admin/api/configuracion_horarios.php', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(config)
                                    });
                                    const data = await res.json();
                                    if (data && data.success) {
                                        mostrarMensajeGuardado();
                                    } else {
                                        alert('Error al guardar la configuraci√≥n de horarios.');
                                    }
                                } catch (e) {
                                    alert('Error de conexi√≥n al guardar horarios.');
                                }
                            }

                            // Mostrar mensaje de guardado
                            function mostrarMensajeGuardado() {
                                const msg = document.getElementById('horarios-guardado-msg');
                                msg.style.display = 'block';
                                setTimeout(() => { msg.style.display = 'none'; }, 1800);
                            }

                            // Listener para el bot√≥n Guardar
                            document.addEventListener('DOMContentLoaded', function () {
                                const btnGuardar = document.getElementById('btn-guardar-horarios');
                                if (btnGuardar) {
                                    btnGuardar.addEventListener('click', function () {
                                        guardarConfigHorarios();
                                    });
                                }
                            });

                            // Ya no se carga autom√°ticamente la config de horarios al cargar la p√°gina o cambiar de secci√≥n
                        </script>
                    </div>
                    <div class="config-panel" id="panel-seguridad" style="display:none">
                        <div class="config-panel-title"><span style="font-size:1.2em">üîí</span> Seguridad</div>
                        <div style="margin-bottom:18px;color:#888;">Opciones de seguridad para el uso del t√≥tem</div>
                        <div class="config-form-group" style="max-width:400px;">
                            <label for="admin-pin-input" style="font-weight:600;display:block;margin-bottom:8px;">PIN de
                                Administrador</label>
                            <input type="password" id="admin-pin-input" class="config-input" value=""
                                style="width:100%;padding:10px 14px;font-size:1em;border-radius:6px;border:1px solid #ccc;">
                            <button id="btn-guardar-admin-pin" class="btn-green"
                                style="margin-top:10px;min-width:120px;">Guardar PIN</button>
                        </div>
                    </div>
            </div>
    </div>
    </section>
    <script>
        // === CONFIGURACI√ìN DE PESTA√ëAS ===
        // Script para tabs de configuraci√≥n
        const configTabs = document.querySelectorAll('.config-tab');
        const configPanels = {
            general: document.querySelector('.config-panel:not([id])'),
            pagos: document.getElementById('panel-pagos'),
            horarios: document.getElementById('panel-horarios'),
            seguridad: document.getElementById('panel-seguridad')
        };

        function showConfigPanel(tab) {
            configTabs.forEach((t, i) => {
                if (t.textContent.trim().toLowerCase() === tab) {
                    t.classList.add('active');
                } else {
                    t.classList.remove('active');
                }
            });
            // Guardar la pesta√±a activa
            localStorage.setItem('configTab', tab);
            Object.keys(configPanels).forEach(key => {
                if (key === tab) {
                    if (configPanels[key]) {
                        configPanels[key].style.display = '';
                        // Solo cargar horarios si se entra a la pesta√±a de horarios
                        if (key === 'horarios') {
                            setTimeout(cargarConfigHorarios, 100);
                        }
                        // Cargar configuraci√≥n de pagos si se entra a la pesta√±a de pagos
                        if (key === 'pagos') {
                            setTimeout(cargarConfigPagos, 100);
                        }
                        // Cargar productos si se entra a la pesta√±a de productos
                        if (key === 'productos') {
                            setTimeout(inicializarProductos, 100);
                        }
                    }
                } else {
                    if (configPanels[key]) {
                        configPanels[key].style.display = 'none';
                    }
                }
            });

            // Mostrar/ocultar panel de pruebas solo en General
            const panelPruebas = document.getElementById('panel-pruebas-notificaciones');
            if (panelPruebas) {
                if (tab === 'general') {
                    panelPruebas.style.display = '';
                } else {
                    panelPruebas.style.display = 'none';
                }
            }
        }

        configTabs.forEach(tab => {
            tab.addEventListener('click', function () {
                showConfigPanel(this.textContent.trim().toLowerCase());
            });
        });

        // Cargar la pesta√±a guardada o mostrar General por defecto
        // (Se ejecutar√° en el listener consolidado principal)

        // === PANEL DE PRUEBAS DE NOTIFICACIONES ===
        // Crear panel de pruebas para incluir en General
        function crearPanelPruebas() {
            const panelGeneral = document.querySelector('.config-panel:not([id])');
            if (!panelGeneral) return;

            // Verificar si ya existe para evitar duplicados
            if (document.getElementById('panel-pruebas-notificaciones')) return;

            const panelPruebas = document.createElement('div');
            panelPruebas.id = 'panel-pruebas-notificaciones';
            panelPruebas.style.cssText = `
                        background: #f8f9fa;
                        border-radius: 12px;
                        padding: 24px;
                        margin-top: 32px;
                        border: 2px dashed #dee2e6;
                    `;

            panelPruebas.innerHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px; font-size: 1.1em; color: #495057;">
                                <span style="font-size:1.2em">üß™</span> Panel de Pruebas - Notificaciones
                            </h3>
                        </div>
                        <div style="margin-bottom: 16px; color: #6c757d; font-size: 14px;">
                            Utiliza estos botones para probar el sistema unificado de notificaciones:
                        </div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                            <button onclick="window.notificacionesManager.probarExito()" 
                                    style="background: #22c55e; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚úÖ Probar √âxito
                            </button>
                            <button onclick="window.notificacionesManager.probarError()" 
                                    style="background: #ef4444; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚ùå Probar Error
                            </button>
                            <button onclick="window.notificacionesManager.probarInfo()" 
                                    style="background: #3b82f6; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚ÑπÔ∏è Probar Info
                            </button>
                            <button onclick="window.notificacionesManager.probarAdvertencia()" 
                                    style="background: #f59e0b; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                ‚ö†Ô∏è Probar Advertencia
                            </button>
                            <button onclick="window.notificacionesManager.probarTodas()" 
                                    style="background: #8b5cf6; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                üéØ Probar Todas
                            </button>
                            <button onclick="window.notificacionesManager.probarModoOscuro()" 
                                    style="background: #1f2937; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                üåô Probar Modo Oscuro
                            </button>
                            <button onclick="window.notificacionesManager.limpiarTodas()" 
                                    style="background: #6b7280; color: white; border: none; padding: 10px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                                üßπ Limpiar Todas
                            </button>
                        </div>
                        <div style="margin-top: 16px; padding: 12px; background: #e0f2fe; border-radius: 6px; font-size: 13px; color: #0277bd;">
                            <strong>üí° Tip:</strong> Este panel solo aparece en la configuraci√≥n General. Las notificaciones ahora est√°n unificadas en todos los m√≥dulos del sistema.
                        </div>
                    `;

            // Insertar el panel al final del panel General
            panelGeneral.appendChild(panelPruebas);
        }

        // Crear panel de pruebas cuando se carga la p√°gina
        // (Se ejecutar√° en el listener consolidado principal)

        // === ESTAD√çSTICAS Y FILTROS ===
        let filtroActual = 'hoy';
        let tipoServicioActual = '';
        let mostrarTodosProductos = false;

        async function cargarEstadisticasFiltradas(filtro = 'hoy', tipoServicio = '') {
            try {
                let url = `${BACKEND_API}/admin/api/api_estadisticas.php?action=compras_totem&filtro=${filtro}`;
                if (tipoServicio) {
                    url += `&tipo_servicio=${tipoServicio}`;
                }
                const res = await fetch(url);
                const data = await res.json();

                if (data.success) {
                    // Verificar que los elementos existan antes de actualizar
                    const contadorTotem = document.getElementById('contador-totem');
                    const ingresosTotales = document.getElementById('ingresos-totales');
                    const ticketPromedio = document.getElementById('ticket-promedio');
                    const periodoActual = document.getElementById('periodo-actual');
                    const periodoActual2 = document.getElementById('periodo-actual2');
                    const periodoActual3 = document.getElementById('periodo-actual3');

                    if (contadorTotem) contadorTotem.textContent = data.data.total_compras;
                    if (ingresosTotales) ingresosTotales.textContent = `$${parseFloat(data.data.ingresos_totales).toLocaleString()}`;
                    if (ticketPromedio) ticketPromedio.textContent = `$${parseFloat(data.data.ticket_promedio).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                    // Actualizar los per√≠odos mostrados
                    let periodoTexto;
                    if (filtro === 'hoy') {
                        periodoTexto = 'Hoy';
                    } else if (filtro === 'semana') {
                        periodoTexto = 'Esta semana (Lun-Dom)';
                    } else if (filtro === 'mes') {
                        const nombreMes = new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                        periodoTexto = `${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}`;
                    } else if (filtro === '3meses') {
                        periodoTexto = '√öltimos 3 meses';
                    } else if (filtro.startsWith('personalizado')) {
                        const fechaInicio = document.getElementById('fecha-inicio').value;
                        const fechaFin = document.getElementById('fecha-fin').value;
                        if (fechaInicio && fechaFin) {
                            const inicio = new Date(fechaInicio).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            const fin = new Date(fechaFin).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                            periodoTexto = `${inicio} - ${fin}`;
                        } else {
                            periodoTexto = 'Per√≠odo personalizado';
                        }
                    } else {
                        periodoTexto = 'Per√≠odo actual';
                    }
                    if (periodoActual) periodoActual.textContent = periodoTexto;
                    if (periodoActual2) periodoActual2.textContent = periodoTexto;
                    if (periodoActual3) periodoActual3.textContent = periodoTexto;

                } else {
                    console.error('Error en respuesta de API:', data);
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas filtradas:', error);
            }
        }

        async function aplicarFiltroPersonalizado() {
            try {
                const fechaInicio = document.getElementById('fecha-inicio').value;
                const fechaFin = document.getElementById('fecha-fin').value;
                
                if (!fechaInicio || !fechaFin) {
                    alert('Por favor selecciona ambas fechas');
                    return;
                }
                
                if (new Date(fechaInicio) > new Date(fechaFin)) {
                    alert('La fecha de inicio debe ser anterior a la fecha fin');
                    return;
                }
                
                const filtroPersonalizado = `personalizado_${fechaInicio}_${fechaFin}`;
                filtroActual = filtroPersonalizado;
                
                // Remover active de todos los botones predefinidos
                document.querySelectorAll('.filtro-btn').forEach(btn => btn.classList.remove('active'));
                // Activar el bot√≥n de aplicar
                document.getElementById('btn-filtro-personalizado').classList.add('active');

                await recargarTodasLasEstadisticas();
            } catch (error) {
                console.error('Error al aplicar filtro personalizado:', error);
            }
        }

        async function cambiarFiltroEstadisticas(filtro) {
            try {
                filtroActual = filtro;
                document.querySelectorAll('.filtro-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('filtro-' + filtro).classList.add('active');

                await recargarTodasLasEstadisticas();
            } catch (error) {
                console.error('Error al cambiar filtro:', error);
            }
        }

        async function cambiarFiltroServicio(tipoServicio) {
            try {
                tipoServicioActual = tipoServicio;
                await recargarTodasLasEstadisticas();
            } catch (error) {
                console.error('Error al cambiar filtro de servicio:', error);
            }
        }

        async function cambiarVisualizacionProductos(mostrarTodos) {
            try {
                mostrarTodosProductos = mostrarTodos;
                // Solo recargar rentabilidad ya que es el √∫nico que se ve afectado por esta opci√≥n
                await cargarRentabilidad(filtroActual, tipoServicioActual, mostrarTodosProductos);
            } catch (error) {
                console.error('Error al cambiar visualizaci√≥n de productos:', error);
            }
        }

        async function recargarTodasLasEstadisticas() {
            try {
                // Primero actualizar los cuadros
                await cargarEstadisticasFiltradas(filtroActual, tipoServicioActual);

                // Luego actualizar los gr√°ficos
                await cargarVentasPorDia(filtroActual, tipoServicioActual);
                await cargarMetodosPago(filtroActual, tipoServicioActual);
                await cargarPedidosPorHora(filtroActual, tipoServicioActual);
                await cargarRentabilidad(filtroActual, tipoServicioActual, mostrarTodosProductos);
            } catch (error) {
                console.error('Error al recargar estad√≠sticas:', error);
            }
        }

        // === ACTUALIZACI√ìN AUTOM√ÅTICA ===
        setInterval(async () => {
            if (document.getElementById('estadisticas-section').style.display !== 'none') {
                try {
                    await cambiarFiltroEstadisticas(filtroActual);
                } catch (error) {
                    console.error('Error en actualizaci√≥n autom√°tica:', error);
                }
            }
        }, 5 * 60 * 1000); // 5 minutos

        // ...resto de funciones de estad√≠sticas (sin cambios)...
        let ventasPorDiaChart, metodosPagoChart, pedidosPorHoraChart;
        let chartsInitialized = false;

        async function cargarEstadisticas() {
            try {
                // Verificar que los elementos existan antes de intentar cargar
                const ventasChart = document.getElementById('ventasPorDiaChart');
                const metodosChart = document.getElementById('metodosPagoChart');
                const pedidosChart = document.getElementById('pedidosPorHoraChart');
                const top5List = document.getElementById('top5-list');

                if (!ventasChart || !metodosChart || !pedidosChart || !top5List) {
                    console.warn('Algunos elementos de estad√≠sticas no est√°n disponibles a√∫n');
                    return;
                }

                // Cargar datos de las tarjetas de resumen y gr√°ficos
                if (!chartsInitialized) {
                    await cargarVentasPorDia(filtroActual);
                    await cargarMetodosPago(filtroActual);
                    await cargarTopProductos(filtroActual);
                    await cargarPedidosPorHora(filtroActual);
                    await cargarRentabilidad(filtroActual);
                    chartsInitialized = true;
                } else {
                    await cargarEstadisticasFiltradas(filtroActual);
                    await cargarRentabilidad(filtroActual);
                }

            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
            }
        }

        async function actualizarDatosGraficos() {
            try {
                await recargarTodasLasEstadisticas();
            } catch (error) {
                console.error('Error al actualizar datos de gr√°ficos:', error);
            }
        }

        async function cargarResumenSemanal() {
            const response = await fetch(BACKEND_API + '/admin/api/api_estadisticas.php?action=resumen_semanal');
            const data = await response.json();

            if (data.success) {
                const stats = data.data;
                document.getElementById('ingresos-semana').textContent = `$${parseFloat(stats.ingresos_semana).toLocaleString()}`;
                document.getElementById('total-pedidos-semana').textContent = stats.total_pedidos_semana;
                document.getElementById('ticket-promedio-semana').textContent = `$${parseFloat(stats.ticket_promedio).toFixed(2)}`;
            }
        }

        async function cargarVentasPorDia(filtro = 'hoy', tipoServicio = '') {
            try {
                let url = `${BACKEND_API}/admin/api/api_estadisticas.php?action=ventas_por_dia&filtro=${filtro}`;
                if (tipoServicio) {
                    url += `&tipo_servicio=${tipoServicio}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    const ventasData = data.data;
                    let labels;
                    
                    // Funci√≥n para crear fecha local sin problemas de zona horaria
                    function crearFechaLocal(fechaString) {
                        const partes = fechaString.split('-');
                        return new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2]));
                    }
                    
                    // Formatear etiquetas seg√∫n el filtro
                    if (filtro === 'hoy') {
                        labels = ventasData.map(item => {
                            const fecha = crearFechaLocal(item.fecha);
                            return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                        });
                    } else if (filtro === 'semana') {
                        labels = ventasData.map(item => {
                            const fecha = crearFechaLocal(item.fecha);
                            return fecha.toLocaleDateString('es-ES', { weekday: 'short' });
                        });
                    } else if (filtro === 'mes') {
                        labels = ventasData.map(item => {
                            const fecha = crearFechaLocal(item.fecha);
                            return fecha.toLocaleDateString('es-ES', { day: '2-digit' });
                        });
                    } else if (filtro === '3meses' || filtro.startsWith('personalizado_')) {
                        labels = ventasData.map(item => {
                            const fecha = crearFechaLocal(item.fecha);
                            return fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' });
                        });
                    } else {
                        labels = ventasData.map(item => {
                            const fecha = crearFechaLocal(item.fecha);
                            return fecha.toLocaleDateString('es-ES', { weekday: 'short' });
                        });
                    }
                    
                    const valores = ventasData.map(item => parseFloat(item.total_ventas));

                    const chartElement = document.getElementById('ventasPorDiaChart');
                    if (!chartElement) {
                        console.warn('Elemento ventasPorDiaChart no encontrado');
                        return;
                    }

                    const ctx = chartElement.getContext('2d');
                    if (ventasPorDiaChart) ventasPorDiaChart.destroy();

                    ventasPorDiaChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ventas ($)',
                                data: valores,
                                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0
                            },
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function (value) {
                                            return '$' + value.toLocaleString();
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar ventas por d√≠a:', error);
            }
        }

        async function cargarMetodosPago(filtro = 'hoy', tipoServicio = '') {
            try {
                let url = `${BACKEND_API}/admin/api/api_estadisticas.php?action=metodos_pago&filtro=${filtro}`;
                if (tipoServicio) {
                    url += `&tipo_servicio=${tipoServicio}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    const metodosData = data.data;
                    const labels = metodosData.map(item => item.metodo_pago);
                    const valores = metodosData.map(item => parseInt(item.total_pedidos));
                    const colores = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

                    const chartElement = document.getElementById('metodosPagoChart');
                    if (!chartElement) {
                        console.warn('Elemento metodosPagoChart no encontrado');
                        return;
                    }

                    const ctx = chartElement.getContext('2d');
                    if (metodosPagoChart) metodosPagoChart.destroy();

                    metodosPagoChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: valores,
                                backgroundColor: colores.slice(0, valores.length),
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 10,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar m√©todos de pago:', error);
            }
        }

        async function cargarTopProductos() {
            try {
                const response = await fetch(BACKEND_API + '/admin/api/api_estadisticas.php?action=top_productos');
                const data = await response.json();

                if (data.success) {
                    const productos = data.data;
                    const top5List = document.getElementById('top5-list');

                    if (!top5List) {
                        console.warn('Elemento top5-list no encontrado');
                        return;
                    }

                    if (productos.length === 0) {
                        top5List.innerHTML = '<li class="no-data">No hay datos de productos vendidos</li>';
                        return;
                    }

                    top5List.innerHTML = `
                <table class="top5-table" style="width:100%;border-collapse:collapse;">
                  <thead>
                    <tr>
                      <th style="text-align:left;padding:4px 8px;">Producto</th>
                      <th style="text-align:left;padding:4px 8px;">Unidades</th>
                      <th style="text-align:left;padding:4px 8px;">Ingresos</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${productos.map(producto => `
                      <tr>
                        <td class="top5-nombre" style="padding:4px 8px;">${producto.nombre}</td>
                        <td class="top5-unidades" style="padding:4px 8px;">${producto.unidades_vendidas} unidades</td>
                        <td class="top5-ingresos" style="padding:4px 8px;">$${parseFloat(producto.ingresos_totales).toLocaleString()}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              `;
                }
            } catch (error) {
                console.error('Error al cargar top productos:', error);
            }
        }

        async function cargarDashboardTopProductos() {
            try {
                const response = await fetch(BACKEND_API + '/admin/api/api_estadisticas.php?action=top_productos');
                const data = await response.json();

                if (data.success) {
                    const productos = data.data;
                    const dashboardTop5List = document.getElementById('dashboard-top5-list');

                    if (!dashboardTop5List) {
                        console.warn('Elemento dashboard-top5-list no encontrado');
                        return;
                    }

                    if (productos.length === 0) {
                        dashboardTop5List.innerHTML = '<div class="no-data">No hay datos de productos vendidos</div>';
                        return;
                    }

                    dashboardTop5List.innerHTML = productos.map((producto, index) => `
                      <div class="top5-card order-card">
                        <div class="top5-rank">#${index + 1}</div>
                        <div class="top5-info">
                          <span class="top5-nombre">${producto.nombre}</span>
                          <span class="top5-unidades">${producto.unidades_vendidas} unidades</span>
                        </div>
                        <div class="top5-ingresos">$${parseFloat(producto.ingresos_totales).toLocaleString()}</div>
                      </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error al cargar top productos del dashboard:', error);
                const dashboardTop5List = document.getElementById('dashboard-top5-list');
                if (dashboardTop5List) {
                    dashboardTop5List.innerHTML = '<div class="error">Error al cargar datos</div>';
                }
            }
        }

        async function cargarPedidosPorHora(filtro = 'hoy', tipoServicio = '') {
            try {
                let url = `${BACKEND_API}/admin/api/api_estadisticas.php?action=pedidos_por_hora&filtro=${filtro}`;
                if (tipoServicio) {
                    url += `&tipo_servicio=${tipoServicio}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    const pedidosData = data.data;
                    const labels = pedidosData.map(item => `${item.hora}:00`);
                    const valores = pedidosData.map(item => parseInt(item.total_pedidos));

                    const chartElement = document.getElementById('pedidosPorHoraChart');
                    if (!chartElement) {
                        console.warn('Elemento pedidosPorHoraChart no encontrado');
                        return;
                    }

                    const ctx = chartElement.getContext('2d');
                    if (pedidosPorHoraChart) pedidosPorHoraChart.destroy();

                    pedidosPorHoraChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Pedidos',
                                data: valores,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0
                            },
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error al cargar pedidos por hora:', error);
            }
        }

        // Variables globales para rentabilidad
        let rentabilidadDataGlobal = [];
        let currentSort = { column: null, direction: 'asc' };
        let rentabilidadPaginacion = {
            paginaActual: 1,
            itemsPorPagina: 25,
            totalPaginas: 1,
            totalItems: 0
        };

        async function cargarRentabilidad(filtro = 'hoy', tipoServicio = '', mostrarTodos = false) {
            try {
                let url = `${BACKEND_API}/admin/api/api_estadisticas.php?action=rentabilidad&filtro=${filtro}`;
                if (tipoServicio) {
                    url += `&tipo_servicio=${tipoServicio}`;
                }
                if (mostrarTodos) {
                    url += `&mostrar_todos=1`;
                }
                const response = await fetch(url);
                
                // Verificar si la respuesta es exitosa
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos de rentabilidad recibidos:', data);

                if (data.success) {
                    rentabilidadDataGlobal = data.data;
                    renderRentabilidadTable();
                } else {
                    console.error('Error en respuesta de rentabilidad:', data);
                    const tbody = document.getElementById('rentabilidad-tbody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ef4444;">Error: ${data.error || data.message || 'Error desconocido'}</td></tr>`;
                    }
                }
            } catch (error) {
                console.error('Error al cargar rentabilidad:', error);
                const tbody = document.getElementById('rentabilidad-tbody');
                if (tbody) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #ef4444;">Error de conexi√≥n: ${error.message}</td></tr>`;
                }
            }
        }

        function renderRentabilidadTable() {
            const tbody = document.getElementById('rentabilidad-tbody');
            const searchInput = document.getElementById('search-producto');
            
            if (!tbody) {
                console.warn('Elemento rentabilidad-tbody no encontrado');
                return;
            }

            // Filtrar por b√∫squeda de producto
            let filteredData = [...rentabilidadDataGlobal];
            if (searchInput && searchInput.value.trim()) {
                const searchTerm = searchInput.value.toLowerCase().trim();
                filteredData = filteredData.filter(producto => 
                    producto.nombre.toLowerCase().includes(searchTerm)
                );
            }

            // Aplicar ordenamiento si existe
            if (currentSort.column) {
                filteredData.sort((a, b) => {
                    let valueA = a[currentSort.column];
                    let valueB = b[currentSort.column];
                    
                    // Convertir a n√∫meros si es necesario
                    if (typeof valueA === 'string' && !isNaN(valueA)) {
                        valueA = parseFloat(valueA);
                        valueB = parseFloat(valueB);
                    }
                    
                    if (currentSort.direction === 'asc') {
                        return valueA > valueB ? 1 : (valueA < valueB ? -1 : 0);
                    } else {
                        return valueA < valueB ? 1 : (valueA > valueB ? -1 : 0);
                    }
                });
            }

            // Actualizar informaci√≥n de paginaci√≥n
            rentabilidadPaginacion.totalItems = filteredData.length;
            rentabilidadPaginacion.totalPaginas = Math.ceil(rentabilidadPaginacion.totalItems / rentabilidadPaginacion.itemsPorPagina);

            // Aplicar paginaci√≥n
            const inicio = (rentabilidadPaginacion.paginaActual - 1) * rentabilidadPaginacion.itemsPorPagina;
            const fin = inicio + rentabilidadPaginacion.itemsPorPagina;
            const productosPaginados = filteredData.slice(inicio, fin);

            if (productosPaginados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #6c757d;">No se encontraron productos que coincidan con los filtros</td></tr>';
                actualizarInfoPaginacionRentabilidad();
                return;
            }

            tbody.innerHTML = '';
            
            productosPaginados.forEach(producto => {
                const margen = parseFloat(producto.margen_porcentaje);
                let margenClass = '';
                let margenIcon = '';
                
                // Clasificaci√≥n de rentabilidad seg√∫n los rangos definidos
                if (margen >= 50) {
                    margenClass = 'margen-alto'; // Verde para alta rentabilidad (>50%)
                    margenIcon = '‚óè';
                } else if (margen >= 20) {
                    margenClass = 'margen-medio'; // Naranja para media rentabilidad (20-50%)
                    margenIcon = '‚óè';
                } else {
                    margenClass = 'margen-bajo'; // Rojo para baja rentabilidad (<20%)
                    margenIcon = '‚óè';
                }

                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #f1f3f4';
                row.innerHTML = `
                    <td style="padding: 12px 8px; font-weight: 500;" class="producto-nombre">${producto.nombre}</td>
                    <td style="padding: 12px 8px; text-align: right;" class="precio-compra">$${parseFloat(producto.precio_compra || 0).toFixed(2)}</td>
                    <td style="padding: 12px 8px; text-align: right; font-weight: 500;" class="precio-venta">$${parseFloat(producto.precio_venta).toFixed(2)}</td>
                    <td style="padding: 12px 8px; text-align: right; font-weight: 600;" class="ganancia-unitaria">$${parseFloat(producto.ganancia_unitaria).toFixed(2)}</td>
                    <td style="padding: 12px 8px; text-align: right;" class="${margenClass}">${margenIcon} ${margen.toFixed(1)}%</td>
                    <td style="padding: 12px 8px; text-align: right;" class="unidades-vendidas">${parseInt(producto.unidades_vendidas)}</td>
                    <td style="padding: 12px 8px; text-align: right; font-weight: 600; font-size: 15px;" class="ganancia-total">$${parseFloat(producto.ganancia_total).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });

            actualizarInfoPaginacionRentabilidad();
        }

        function setupRentabilidadControls() {
            // Setup search input
            const searchInput = document.getElementById('search-producto');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    rentabilidadPaginacion.paginaActual = 1; // Reset p√°gina al buscar
                    renderRentabilidadTable();
                });
            }

            // Setup clear filters button
            const clearButton = document.getElementById('clear-filters');
            if (clearButton) {
                clearButton.addEventListener('click', function() {
                    // Clear search
                    if (searchInput) {
                        searchInput.value = '';
                    }
                    
                    // Clear sort
                    currentSort = { column: null, direction: 'asc' };
                    
                    // Reset pagination
                    rentabilidadPaginacion.paginaActual = 1;
                    
                    // Update header classes
                    document.querySelectorAll('.sortable-header').forEach(header => {
                        header.classList.remove('sort-asc', 'sort-desc');
                        const indicator = header.querySelector('.sort-indicator');
                        if (indicator) {
                            indicator.textContent = '‚áÖ';
                        }
                    });
                    
                    renderRentabilidadTable();
                });
            }

            // Setup sortable headers
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', function() {
                    const column = this.getAttribute('data-column');
                    
                    // Cycle through 3 states: default -> desc -> asc -> default
                    if (currentSort.column === column) {
                        if (currentSort.direction === 'desc') {
                            currentSort.direction = 'asc';
                        } else if (currentSort.direction === 'asc') {
                            // Reset to default (no sorting)
                            currentSort.column = null;
                            currentSort.direction = 'asc';
                        }
                    } else {
                        // New column, start with descending
                        currentSort.column = column;
                        currentSort.direction = 'desc';
                    }
                    
                    // Reset pagination when sorting
                    rentabilidadPaginacion.paginaActual = 1;
                    
                    // Update header classes
                    document.querySelectorAll('.sortable-header').forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                        const indicator = h.querySelector('.sort-indicator');
                        if (indicator) {
                            indicator.textContent = '‚áÖ';
                        }
                    });
                    
                    // Update current header only if there's an active sort
                    if (currentSort.column) {
                        this.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
                        const indicator = this.querySelector('.sort-indicator');
                        if (indicator) {
                            indicator.textContent = currentSort.direction === 'asc' ? '‚Üë' : '‚Üì';
                        }
                    }
                    
                    console.log(`Sorting column: ${currentSort.column}, direction: ${currentSort.direction}`);
                    renderRentabilidadTable();
                });
            });

            // Setup pagination controls
            document.getElementById('prev-page-rentabilidad')?.addEventListener('click', () => cambiarPaginaRentabilidad(rentabilidadPaginacion.paginaActual - 1));
            document.getElementById('next-page-rentabilidad')?.addEventListener('click', () => cambiarPaginaRentabilidad(rentabilidadPaginacion.paginaActual + 1));
        }

        function cambiarPaginaRentabilidad(nuevaPagina) {
            if (nuevaPagina >= 1 && nuevaPagina <= rentabilidadPaginacion.totalPaginas) {
                rentabilidadPaginacion.paginaActual = nuevaPagina;
                renderRentabilidadTable();
            }
        }

        function actualizarInfoPaginacionRentabilidad() {
            const inicio = (rentabilidadPaginacion.paginaActual - 1) * rentabilidadPaginacion.itemsPorPagina + 1;
            const fin = Math.min(inicio + rentabilidadPaginacion.itemsPorPagina - 1, rentabilidadPaginacion.totalItems);

            // Actualizar info de paginaci√≥n
            const pageInfo = document.getElementById('page-info-rentabilidad');
            const itemsInfo = document.getElementById('items-info-rentabilidad');
            const prevBtn = document.getElementById('prev-page-rentabilidad');
            const nextBtn = document.getElementById('next-page-rentabilidad');

            if (pageInfo) pageInfo.textContent = `P√°gina ${rentabilidadPaginacion.paginaActual} de ${rentabilidadPaginacion.totalPaginas}`;
            if (itemsInfo) itemsInfo.textContent = `Mostrando ${inicio}-${fin} de ${rentabilidadPaginacion.totalItems} productos`;
            if (prevBtn) prevBtn.disabled = rentabilidadPaginacion.paginaActual === 1;
            if (nextBtn) nextBtn.disabled = rentabilidadPaginacion.paginaActual === rentabilidadPaginacion.totalPaginas;
        }

        // === FUNCIONES DE EXPORTACI√ìN DE RENTABILIDAD ===
        
        function exportarRentabilidadPDF() {
            try {
                // Preparar datos filtrados para exportaci√≥n
                let datosExport = [...rentabilidadDataGlobal];
                
                // Aplicar filtro de b√∫squeda si existe
                const searchInput = document.getElementById('search-producto');
                if (searchInput && searchInput.value.trim()) {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    datosExport = datosExport.filter(producto => 
                        producto.nombre.toLowerCase().includes(searchTerm)
                    );
                }

                // Aplicar ordenamiento si existe
                if (currentSort.column) {
                    datosExport.sort((a, b) => {
                        let valueA = a[currentSort.column];
                        let valueB = b[currentSort.column];
                        
                        if (typeof valueA === 'string' && !isNaN(valueA)) {
                            valueA = parseFloat(valueA);
                            valueB = parseFloat(valueB);
                        }
                        
                        if (currentSort.direction === 'asc') {
                            return valueA > valueB ? 1 : (valueA < valueB ? -1 : 0);
                        } else {
                            return valueA < valueB ? 1 : (valueA > valueB ? -1 : 0);
                        }
                    });
                }

                if (datosExport.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Crear contenido HTML para el PDF
                const fechaReporte = new Date().toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const filtroTexto = obtenerTextoFiltroActual();
                
                let htmlContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <title>Reporte de Rentabilidad - Buffet Murialdino</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px; 
                                color: #333;
                                line-height: 1.4;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 30px; 
                                border-bottom: 2px solid #22c55e;
                                padding-bottom: 20px;
                            }
                            .header h1 { 
                                color: #22c55e; 
                                margin: 0;
                                font-size: 24px;
                            }
                            .header p { 
                                margin: 5px 0; 
                                color: #666;
                                font-size: 14px;
                            }
                            .summary {
                                background: #f8f9fa;
                                padding: 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                display: flex;
                                justify-content: space-around;
                                text-align: center;
                            }
                            .summary-item h3 {
                                margin: 0;
                                color: #22c55e;
                                font-size: 18px;
                            }
                            .summary-item p {
                                margin: 5px 0 0 0;
                                color: #666;
                                font-size: 12px;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse; 
                                margin-top: 20px;
                                font-size: 11px;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 8px; 
                                text-align: left;
                            }
                            th { 
                                background-color: #22c55e; 
                                color: white; 
                                font-weight: bold;
                                text-align: center;
                            }
                            .numero { text-align: right; }
                            .margen-alto { color: #22c55e; font-weight: bold; }
                            .margen-medio { color: #f59e0b; font-weight: bold; }
                            .margen-bajo { color: #ef4444; font-weight: bold; }
                            .footer {
                                margin-top: 30px;
                                text-align: center;
                                font-size: 10px;
                                color: #666;
                                border-top: 1px solid #ddd;
                                padding-top: 10px;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>üìä Reporte de Rentabilidad</h1>
                            <p><strong>Buffet Murialdino</strong></p>
                            <p>Per√≠odo: ${filtroTexto}</p>
                            <p>Generado el: ${fechaReporte}</p>
                        </div>

                        <div class="summary">
                            <div class="summary-item">
                                <h3>${datosExport.length}</h3>
                                <p>Productos</p>
                            </div>
                            <div class="summary-item">
                                <h3>$${datosExport.reduce((sum, p) => sum + parseFloat(p.ganancia_total), 0).toFixed(2)}</h3>
                                <p>Ganancia Total</p>
                            </div>
                            <div class="summary-item">
                                <h3>${datosExport.reduce((sum, p) => sum + parseInt(p.unidades_vendidas), 0)}</h3>
                                <p>Unidades Vendidas</p>
                            </div>
                            <div class="summary-item">
                                <h3>${(datosExport.reduce((sum, p) => sum + parseFloat(p.margen_porcentaje), 0) / datosExport.length).toFixed(1)}%</h3>
                                <p>Margen Promedio</p>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Producto</th>
                                    <th>P. Compra</th>
                                    <th>P. Venta</th>
                                    <th>Ganancia Unit.</th>
                                    <th>Margen %</th>
                                    <th>Unid. Vendidas</th>
                                    <th>Ganancia Total</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                datosExport.forEach(producto => {
                    const margen = parseFloat(producto.margen_porcentaje);
                    let margenClass = '';
                    if (margen >= 50) margenClass = 'margen-alto';
                    else if (margen >= 20) margenClass = 'margen-medio';
                    else margenClass = 'margen-bajo';

                    htmlContent += `
                        <tr>
                            <td>${producto.nombre}</td>
                            <td class="numero">$${parseFloat(producto.precio_compra || 0).toFixed(2)}</td>
                            <td class="numero">$${parseFloat(producto.precio_venta).toFixed(2)}</td>
                            <td class="numero">$${parseFloat(producto.ganancia_unitaria).toFixed(2)}</td>
                            <td class="numero ${margenClass}">${margen.toFixed(1)}%</td>
                            <td class="numero">${parseInt(producto.unidades_vendidas)}</td>
                            <td class="numero"><strong>$${parseFloat(producto.ganancia_total).toFixed(2)}</strong></td>
                        </tr>
                    `;
                });

                htmlContent += `
                            </tbody>
                        </table>
                        
                        <div class="footer">
                            <p>Reporte generado autom√°ticamente por el Sistema de Gesti√≥n Buffet Murialdino</p>
                            <p>Los datos reflejan la rentabilidad de productos en el per√≠odo seleccionado</p>
                        </div>
                    </body>
                    </html>
                `;

                // Crear y descargar PDF
                const ventana = window.open('', '_blank');
                ventana.document.write(htmlContent);
                ventana.document.close();
                
                setTimeout(() => {
                    ventana.print();
                    ventana.close();
                }, 500);

                if (window.notificacionesManager) {
                    window.notificacionesManager.mostrar('Reporte PDF generado exitosamente', 'success');
                }

            } catch (error) {
                console.error('Error exportando PDF:', error);
                if (window.notificacionesManager) {
                    window.notificacionesManager.mostrar('Error al generar PDF: ' + error.message, 'error');
                }
            }
        }

        function exportarRentabilidadExcel() {
            try {
                // Preparar datos filtrados para exportaci√≥n
                let datosExport = [...rentabilidadDataGlobal];
                
                // Aplicar filtro de b√∫squeda si existe
                const searchInput = document.getElementById('search-producto');
                if (searchInput && searchInput.value.trim()) {
                    const searchTerm = searchInput.value.toLowerCase().trim();
                    datosExport = datosExport.filter(producto => 
                        producto.nombre.toLowerCase().includes(searchTerm)
                    );
                }

                // Aplicar ordenamiento si existe
                if (currentSort.column) {
                    datosExport.sort((a, b) => {
                        let valueA = a[currentSort.column];
                        let valueB = b[currentSort.column];
                        
                        if (typeof valueA === 'string' && !isNaN(valueA)) {
                            valueA = parseFloat(valueA);
                            valueB = parseFloat(valueB);
                        }
                        
                        if (currentSort.direction === 'asc') {
                            return valueA > valueB ? 1 : (valueA < valueB ? -1 : 0);
                        } else {
                            return valueA < valueB ? 1 : (valueA > valueB ? -1 : 0);
                        }
                    });
                }

                if (datosExport.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Crear datos para Excel
                const fechaReporte = new Date().toLocaleDateString('es-ES');
                const filtroTexto = obtenerTextoFiltroActual();
                
                // Calcular totales y estad√≠sticas
                const totalGanancia = datosExport.reduce((sum, p) => sum + parseFloat(p.ganancia_total), 0);
                const totalUnidades = datosExport.reduce((sum, p) => sum + parseInt(p.unidades_vendidas), 0);
                const margenPromedio = datosExport.reduce((sum, p) => sum + parseFloat(p.margen_porcentaje), 0) / datosExport.length;

                // Crear contenido CSV compatible con Excel
                let csvContent = '';
                
                // Encabezado del reporte
                csvContent += '"REPORTE DE RENTABILIDAD - BUFFET MURIALDINO"\n';
                csvContent += `"Per√≠odo: ${filtroTexto}"\n`;
                csvContent += `"Fecha de generaci√≥n: ${fechaReporte}"\n`;
                csvContent += '\n';
                
                // Resumen ejecutivo
                csvContent += '"=== RESUMEN EJECUTIVO ==="\n';
                csvContent += `"Total de productos:","${datosExport.length}"\n`;
                csvContent += `"Ganancia total:","$${totalGanancia.toFixed(2)}"\n`;
                csvContent += `"Unidades vendidas:","${totalUnidades}"\n`;
                csvContent += `"Margen promedio:","${margenPromedio.toFixed(1)}%"\n`;
                csvContent += '\n';

                // Encabezados de la tabla
                csvContent += '"Producto","Precio Compra","Precio Venta","Ganancia Unitaria","Margen %","Unidades Vendidas","Ganancia Total","Clasificaci√≥n Margen"\n';

                // Datos de productos
                datosExport.forEach(producto => {
                    const margen = parseFloat(producto.margen_porcentaje);
                    let clasificacion = '';
                    if (margen >= 50) clasificacion = 'Alto';
                    else if (margen >= 20) clasificacion = 'Medio';
                    else clasificacion = 'Bajo';

                    csvContent += `"${producto.nombre}",`;
                    csvContent += `"${parseFloat(producto.precio_compra || 0).toFixed(2)}",`;
                    csvContent += `"${parseFloat(producto.precio_venta).toFixed(2)}",`;
                    csvContent += `"${parseFloat(producto.ganancia_unitaria).toFixed(2)}",`;
                    csvContent += `"${margen.toFixed(1)}%",`;
                    csvContent += `"${parseInt(producto.unidades_vendidas)}",`;
                    csvContent += `"${parseFloat(producto.ganancia_total).toFixed(2)}",`;
                    csvContent += `"${clasificacion}"\n`;
                });

                // Fila de totales
                csvContent += '\n';
                csvContent += '"=== TOTALES ==="\n';
                csvContent += `"TOTAL","","","","","${totalUnidades}","${totalGanancia.toFixed(2)}",""\n`;

                // Crear y descargar archivo
                const BOM = '\uFEFF'; // Byte Order Mark para UTF-8
                const blob = new Blob([BOM + csvContent], {
                    type: 'text/csv;charset=utf-8;'
                });
                
                const link = document.createElement('a');
                const filename = `rentabilidad_buffet_${filtroTexto.replace(/\s+/g, '_').toLowerCase()}_${new Date().toISOString().split('T')[0]}.csv`;
                
                if (navigator.msSaveBlob) {
                    // IE
                    navigator.msSaveBlob(blob, filename);
                } else {
                    // Otros navegadores
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                }

                if (window.notificacionesManager) {
                    window.notificacionesManager.mostrar('Archivo Excel generado exitosamente', 'success');
                }

            } catch (error) {
                console.error('Error exportando Excel:', error);
                if (window.notificacionesManager) {
                    window.notificacionesManager.mostrar('Error al generar Excel: ' + error.message, 'error');
                }
            }
        }

        function obtenerTextoFiltroActual() {
            if (filtroActual === 'hoy') {
                return 'Hoy';
            } else if (filtroActual === 'semana') {
                return 'Esta semana';
            } else if (filtroActual === 'mes') {
                const nombreMes = new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                return `${nombreMes.charAt(0).toUpperCase() + nombreMes.slice(1)}`;
            } else if (filtroActual === '3meses') {
                return '√öltimos 3 meses';
            } else if (filtroActual.startsWith('personalizado')) {
                const fechaInicio = document.getElementById('fecha-inicio').value;
                const fechaFin = document.getElementById('fecha-fin').value;
                if (fechaInicio && fechaFin) {
                    const inicio = new Date(fechaInicio).toLocaleDateString('es-ES');
                    const fin = new Date(fechaFin).toLocaleDateString('es-ES');
                    return `${inicio} - ${fin}`;
                } else {
                    return 'Per√≠odo personalizado';
                }
            } else {
                return 'Per√≠odo actual';
            }
        }
    </script>
    </section>
    </div>
    </main>
    </div>

    <!-- Modal de Productos -->
    <div id="producto-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-titulo">Nuevo Producto</h2>
                <button class="modal-close" onclick="productosManager.cerrarModal()">&times;</button>
            </div>
            <form id="producto-form" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre-input">Nombre del Producto *</label>
                        <input type="text" id="nombre-input" name="nombre" required>
                    </div>
                    <div class="form-group">
                        <label for="precio-venta-input">Precio de Venta *</label>
                        <input type="number" id="precio-venta-input" name="precio_venta" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="precio-lista-input">Precio de Lista</label>
                        <input type="number" id="precio-lista-input" name="precio_lista" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label for="punto-venta-select">Punto de Venta *</label>
                        <select id="punto-venta-select" name="id_punto_venta" required>
                            <option value="">Seleccionar punto de venta</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="categoria-select">Categor√≠a *</label>
                        <select id="categoria-select" name="id_categoria" required>
                            <option value="">Seleccionar categor√≠a</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <div class="personalizable-section" style="margin-bottom: 10px; margin-top: 22px;">
                            <div class="personalizable-metodo">
                                <div>
                                    <span>Es Personalizable</span> 
                                </div>
                                <input type="checkbox" id="personalizable-checkbox" name="es_personalizable" value="1">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="imagen-input">Imagen del Producto</label>
                    <input type="file" id="imagen-input" name="imagen" accept="image/*">
                    <img id="imagen-preview"
                        style="max-width: 200px; max-height: 200px; margin-top: 10px; display: none;">
                </div>

                <div class="form-group" id="opciones-personalizacion" style="display: none;">
                    <label>Opciones de Personalizaci√≥n</label>
                    <div id="opciones-container"></div>
                    <button type="button" id="agregar-opcion-btn" class="btn-secondary">+ Agregar Opci√≥n</button>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-light" onclick="productosManager.cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn-green">Guardar Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Importar -->
    <div id="importar-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Importar Productos</h2>
                <button class="modal-close" onclick="productosManager.cerrarModalImportar()">&times;</button>
            </div>
            <div class="modal-form">
                <div class="importar-info">
                    <p>Selecciona un archivo Excel (.xlsx) o CSV (.csv) con la estructura:</p>
                    <div class="estructura-ejemplo">
                        <strong>Columnas requeridas:</strong> nombre, precio_venta, categoria, punto_venta<br>
                        <strong>Columnas opcionales:</strong> precio_lista, es_personalizable
                    </div>
                </div>

                <div class="form-group">
                    <label for="archivo-importar">Seleccionar Archivo</label>
                    <input type="file" id="archivo-importar" accept=".xlsx,.csv"
                        onchange="productosManager.previsualizarImport(this)">
                </div>

                <div id="preview-import" style="display: none;">
                    <h4>Vista Previa (primeras 5 filas):</h4>
                    <div id="preview-table"></div>
                    <div class="import-stats">
                        <span id="import-count">0 productos detectados</span>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-light"
                        onclick="productosManager.cerrarModalImportar()">Cancelar</button>
                    <button type="button" class="btn-secondary" onclick="productosManager.descargarPlantilla()">üì•
                        Descargar
                        Plantilla</button>
                    <button type="button" class="btn-green" id="btn-confirmar-import" disabled
                        onclick="productosManager.confirmarImport()">Importar Productos</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n de Categor√≠as -->
    <div id="categorias-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gesti√≥n de Categor√≠as</h2>
                <button class="modal-close" onclick="categoriasManager.cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="categorias-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="total-categorias">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="categorias-activas">0</div>
                        <div class="stat-label">Activas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="categorias-inactivas">0</div>
                        <div class="stat-label">Inactivas</div>
                    </div>
                </div>
                <div class="categorias-toolbar">
                    <button class="btn-green" onclick="categoriasManager.abrirModalCrear()">+ Nueva Categor√≠a</button>
                    <div class="toolbar-right">
                        <select id="filtro-punto-venta" class="filtro-select" style="margin-right: 15px;">
                            <option value="">Todos los puntos de venta</option>
                            <option value="1">Buffet</option>
                            <option value="2">Kiosco</option>
                            <option value="3">Ambos</option>
                        </select>
                        <label class="checkbox-label">
                            <input type="checkbox" id="mostrar-categorias-inactivas">
                            <span class="checkbox-text">Mostrar inactivas</span>
                        </label>
                    </div>
                </div>
                <div class="categorias-lista" id="categorias-lista">
                    <div class="categorias-lista-header">
                        <div class="col-nombre">Nombre</div>
                        <div class="col-punto-venta">Punto de Venta</div>
                        <div class="col-productos">Productos</div>
                        <div class="col-estado">Estado</div>
                        <div class="col-acciones">Acciones</div>
                    </div>
                    <div class="categorias-lista-body" id="categorias-lista-body">
                        <!-- Las categor√≠as se cargar√°n aqu√≠ din√°micamente (sin columna descripci√≥n) -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Categor√≠a -->
    <div id="categoria-form-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="categoria-form-title">Nueva Categor√≠a</h2>
                <button class="modal-close" onclick="categoriasManager.cerrarModalForm()">&times;</button>
            </div>
            <form id="categoria-form" class="modal-form">
                <input type="hidden" id="categoria-id" name="id_categoria">

                <div class="form-row">
                    <div class="form-group">
                        <label for="categoria-nombre">Nombre *</label>
                        <input type="text" id="categoria-nombre" name="nombre" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="categoria-punto-venta">Punto de Venta *</label>
                        <select id="categoria-punto-venta" name="id_punto_venta" required>
                            <option value="">Seleccione...</option>
                            <option value="1">Buffet</option>
                            <option value="2">Kiosco</option>
                            <option value="3">Ambos</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="categoria-icono-file">Icono SVG</label>
                    <div class="icono-upload-container">
                        <input type="hidden" id="categoria-icono" name="icono" value="Icono_Snacks.svg">
                        <input type="file" id="categoria-icono-file" accept=".svg" style="display: none;">
                        
                        <div class="icono-preview-container">
                            <div id="icono-preview" class="icono-preview">
                                <img src="../assets/images/Iconos/Icono_Snacks.svg" alt="Icono" id="icono-preview-img">
                            </div>
                            <div class="icono-upload-actions">
                                <button type="button" class="btn-upload-icono" onclick="document.getElementById('categoria-icono-file').click()">
                                    üìÅ Seleccionar SVG
                                </button>
                                <small style="display: block; margin-top: 8px; color: #6b7280;">
                                    Solo archivos SVG, m√°ximo 500KB
                                </small>
                                <span id="icono-file-name" style="display: block; margin-top: 4px; font-size: 0.875rem; color: #3b82f6;"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label style="margin-bottom: 12px; font-weight: 600;">Visibilidad</label>
                    <div class="categoria-visible-container">
                        <div class="categoria-metodo">
                            Visible en t√≥tem<br><span class="categoria-metodo-desc">La categor√≠a
                                aparecer√° en el t√≥tem para los clientes</span>
                            <input type="checkbox" id="categoria-visible" name="visible" checked>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="categoria-descripcion">Descripci√≥n</label>
                    <textarea id="categoria-descripcion" name="descripcion" rows="3" maxlength="255"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-light"
                        onclick="categoriasManager.cerrarModalForm()">Cancelar</button>
                    <button type="submit" class="btn-green">Guardar Categor√≠a</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader" style="display: none;">
        <div class="loader-spinner"></div>
        <div class="loader-text">Cargando...</div>
    </div>

    <!-- Overlay para detalle de pedido -->
    <div id="pedido-overlay" class="pedido-overlay" style="display: none;">
        <div class="pedido-overlay-content">
            <div class="pedido-overlay-header">
                <h3 id="pedido-overlay-titulo">Detalle del Pedido</h3>
                <button onclick="cerrarDetallePedido()" class="pedido-overlay-close">&times;</button>
            </div>
            <div id="pedido-overlay-body" class="pedido-overlay-body">
                <!-- El contenido se cargar√° din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Modal para agregar usuario -->
    <div id="modal-agregar-usuario" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Agregar Usuario</h2>
                <button class="modal-close" id="close-modal-x">&times;</button>
            </div>
            <form id="form-agregar-usuario" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="usuario">Usuario:</label>
                        <input type="text" id="usuario" name="usuario" required>
                    </div>
                    <div class="form-group">
                        <label for="nombre_completo">Nombre Completo:</label>
                        <input type="text" id="nombre_completo" name="nombre_completo" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="contrase√±a">Contrase√±a:</label>
                        <input type="password" id="contrase√±a" name="contrase√±a" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_rol">Rol:</label>
                    <select id="id_rol" name="id_rol" required>
                        <option value="1">Administrador</option>
                        <option value="2">Supervisor</option>
                        <option value="3">Empleado</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-light" id="close-modal-agregar">Cancelar</button>
                    <button type="submit" class="btn-green">Agregar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Proveedor -->
    <div id="modal-proveedor" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-proveedor-titulo">Nuevo Proveedor</h2>
                <button class="modal-close" onclick="proveedoresManager.cerrarModal()">&times;</button>
            </div>
            <form id="form-proveedor" class="modal-form">
                <input type="hidden" id="proveedor-id" name="id_proveedor">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombre_empresa">Nombre de la Empresa *</label>
                        <input type="text" id="nombre_empresa" name="nombre_empresa" required maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="persona_contacto">Persona de Contacto</label>
                        <input type="text" id="persona_contacto" name="persona_contacto" maxlength="100">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cuit">CUIT</label>
                        <input type="text" id="cuit" name="cuit" placeholder="XX-XXXXXXXX-X" maxlength="13">
                    </div>
                    <div class="form-group">
                        <label for="telefono">Tel√©fono/WhatsApp</label>
                        <input type="text" id="telefono" name="telefono" maxlength="20">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" maxlength="100">
                    </div>
                    <div class="form-group">
                        <label for="estado">Estado</label>
                        <select id="estado" name="estado">
                            <option value="1">Activo</option>
                            <option value="0">Inactivo</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="direccion">Direcci√≥n</label>
                    <textarea id="direccion" name="direccion" rows="2" maxlength="255"></textarea>
                </div>

                <div class="form-group">
                    <label for="notas">Notas/Observaciones</label>
                    <textarea id="notas" name="notas" rows="3" maxlength="500"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-light" onclick="proveedoresManager.cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn-green">Guardar Proveedor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Asignar Productos -->
    <div id="modal-asignar-productos" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Asignar Productos a Proveedor</h2>
                <button class="modal-close" onclick="proveedoresManager.cerrarModalAsignar()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="select-proveedor-productos">Seleccionar Proveedor</label>
                    <select id="select-proveedor-productos">
                        <option value="">Seleccione un proveedor...</option>
                    </select>
                </div>
                
                <div id="productos-asignacion" style="display: none; margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3>Productos Disponibles</h3>
                        <input type="text" id="buscar-productos-asignar" placeholder="Buscar productos...">
                    </div>
                    
                    <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align: left;">
                                        <input type="checkbox" id="select-all-productos-asignar"> Producto
                                    </th>
                                    <th style="text-align: left;">Categor√≠a</th>
                                    <th style="text-align: left;">Precio Lista</th>
                                </tr>
                            </thead>
                            <tbody id="lista-productos-asignar">
                                <!-- Se carga din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-light" onclick="proveedoresManager.cerrarModalAsignar()">Cancelar</button>
                    <button type="button" class="btn-green" id="btn-guardar-asignacion" disabled>Guardar Asignaci√≥n</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Enviar Pedido -->
    <div id="modal-enviar-pedido" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Enviar Pedido a Proveedor</h2>
                <button class="modal-close" onclick="proveedoresManager.cerrarModalPedido()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="select-proveedor-pedido">Seleccionar Proveedor</label>
                    <select id="select-proveedor-pedido">
                        <option value="">Seleccione un proveedor...</option>
                    </select>
                </div>
                
                <div id="productos-pedido" style="display: none; margin-top: 20px;">
                    <h3>Productos del Proveedor</h3>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; margin-bottom: 16px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th style="padding: 8px; text-align: left;">
                                        <input type="checkbox" id="select-all-productos-pedido"> Producto
                                    </th>
                                    <th style="padding: 8px; text-align: left;">Categor√≠a</th>
                                    <th style="padding: 8px; text-align: center; width: 120px;">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody id="lista-productos-pedido">
                                <!-- Se carga din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="form-group">
                        <label for="plantilla-mensaje">Plantilla de Mensaje</label>
                        <select id="plantilla-mensaje">
                            <option value="">Seleccione una plantilla...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="mensaje-pedido">Mensaje</label>
                        <textarea id="mensaje-pedido" rows="6" placeholder="Escriba su mensaje aqu√≠..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="via-envio">V√≠a de Env√≠o</label>
                        <select id="via-envio">
                            <option value="whatsapp">WhatsApp</option>
                            <option value="email">Email</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-light" onclick="proveedoresManager.cerrarModalPedido()">Cancelar</button>
                    <button type="button" class="btn-green" id="btn-enviar-pedido-final" disabled>Enviar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial de Pedidos -->
    <div id="modal-historial-pedidos" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="titulo-historial-proveedor">Historial de Pedidos</h2>
                <button class="modal-close" onclick="proveedoresManager.cerrarModalHistorial()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="historial-pedidos-lista">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        Cargando historial...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n para Eliminar Proveedor -->
    <div id="modal-confirmar-eliminar-proveedor" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Confirmar Eliminaci√≥n</h2>
                <button class="modal-close" onclick="proveedoresManager.cerrarModalConfirmar()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <p><strong>¬øEst√°s seguro de que quieres eliminar este proveedor?</strong></p>
                    <div id="info-productos-asignados" style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                        <p style="margin: 0; color: #856404;">
                            <strong>‚ö†Ô∏è Advertencia:</strong> <span id="mensaje-productos-asignados"></span>
                        </p>
                        <p style="margin: 10px 0 0 0; color: #856404; font-size: 14px;">
                            Al eliminar este proveedor, tambi√©n se eliminar√°n todas las asignaciones de productos. Los productos seguir√°n existiendo pero ya no tendr√°n este proveedor asignado.
                        </p>
                    </div>
                    <p>Esta acci√≥n no se puede deshacer.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-light" onclick="proveedoresManager.cerrarModalConfirmar()">Cancelar</button>
                <button type="button" class="btn-red" onclick="proveedoresManager.confirmarEliminarProveedor()">S√≠, Eliminar Proveedor</button>
            </div>
        </div>
    </div>

    <!-- Scripts din√°micos basados en el backend detectado -->
    <script>
        // === DETECCI√ìN AUTOM√ÅTICA DE BACKEND ===
        // Detectar desde qu√© frontend se est√° accediendo para usar el backend correcto
        function detectarBackend() {
            const currentPath = window.location.pathname;
            const currentUrl = window.location.href;
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('source');
            
            // Detectar por par√°metro URL (desde redirecciones)
            if (source === 'qr') {
                return '/Totem_Murialdo/backend-qr';
            }
            else if (source === 'checkoutpro') {
                return '/Totem_Murialdo/backend-checkoutpro';
            }
            // Si viene desde frontend-qr, usar backend-qr
            else if (currentPath.includes('/frontend-qr/') || currentUrl.includes('/frontend-qr/')) {
                return '/Totem_Murialdo/backend-qr';
            }
            // Si viene desde frontend-checkoutpro, usar backend-checkoutpro  
            else if (currentPath.includes('/frontend-checkoutpro/') || currentUrl.includes('/frontend-checkoutpro/')) {
                return '/Totem_Murialdo/backend-checkoutpro';
            }
            // Por defecto, usar backend original
            else {
                return '/Totem_Murialdo/backend';
            }
        }

        // Variable global para el backend API
        const BACKEND_API = detectarBackend();
        
        console.log('üéØ ConfigDash.html - Backend detectado:', BACKEND_API);

        // Mostrar indicador de sistema activo
        function mostrarIndicadorSistema() {
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('source');
            
            let sistemaActivo = 'Sistema Original';
            let colorIndicador = '#6c757d';
            
            if (BACKEND_API.includes('backend-qr')) {
                sistemaActivo = 'üîÑ Sistema QR Din√°mico';
                colorIndicador = '#667eea';
            } else if (BACKEND_API.includes('backend-checkoutpro')) {
                sistemaActivo = 'üí≥ Sistema CheckoutPro';
                colorIndicador = '#43cea2';
            }
            
            // Crear indicador en el header
            setTimeout(() => {
                const header = document.querySelector('.header');
                if (header) {
                    const indicador = document.createElement('div');
                    indicador.innerHTML = `
                        <div style="
                            position: fixed;
                            top: 10px;
                            right: 10px;
                            background: ${colorIndicador};
                            color: white;
                            padding: 8px 15px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: bold;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                            z-index: 9999;
                        ">
                            ${sistemaActivo}
                        </div>
                    `;
                    document.body.appendChild(indicador);
                }
            }, 100);
        }

        // Cargar scripts din√°micamente seg√∫n el backend
        function cargarScriptsDinamicos() {
            // Construir la ruta relativa correctamente
            let scriptBase = BACKEND_API.replace('/Totem_Murialdo', '../../');
            // Asegurar que no haya dobles slashes
            scriptBase = scriptBase.replace(/\/+/g, '/') + '/admin/js/';
            
            // Cargar config.js primero
            const configScript = document.createElement('script');
            configScript.src = scriptBase + 'config.js';
            configScript.onload = function() {
                console.log('‚úÖ config.js cargado correctamente');
                
                // Una vez cargado config.js, cargar productos.js
                const productosScript = document.createElement('script');
                productosScript.src = scriptBase + 'productos.js';
                productosScript.onload = function() {
                    console.log('‚úÖ productos.js cargado correctamente');
                    // Inicializar ProductosManager si no existe y la clase est√° disponible
                    setTimeout(() => {
                        if (typeof ProductosManager !== 'undefined' && !window.productosManager) {
                            window.productosManager = new ProductosManager();
                            console.log('‚úÖ ProductosManager inicializado autom√°ticamente');
                        }
                    }, 100);
                };
                productosScript.onerror = function() {
                    console.error('‚ùå Error cargando productos.js desde:', scriptBase + 'productos.js');
                };
                document.head.appendChild(productosScript);
            };
            configScript.onerror = function() {
                console.error('‚ùå Error cargando config.js desde:', scriptBase + 'config.js');
            };
            document.head.appendChild(configScript);
            
            console.log('üìÅ Scripts cargados desde:', scriptBase);
        }

        // Ejecutar cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                cargarScriptsDinamicos();
                mostrarIndicadorSistema();
            });
        } else {
            cargarScriptsDinamicos();
            mostrarIndicadorSistema();
        }

        // === VARIABLES GLOBALES ===
        let intervalComandas = null;
        let intervalPedidos = null;
        let intervalDashboard = null;
        let intervalos = [];
        let dashboardCargado = false;
        let productos = [];
        
        // Variables para paginaci√≥n de pedidos
        let pedidosDataGlobal = [];
        let pedidosPaginacion = {
            paginaActual: 1,
            itemsPorPagina: 100,
            totalPaginas: 1,
            totalItems: 0
        };

        // === LISTENER PRINCIPAL CONSOLIDADO ===
        document.addEventListener('DOMContentLoaded', function () {
            // Asegurar que el overlay de pedidos est√© oculto al cargar
            const pedidoOverlay = document.getElementById('pedido-overlay');
            if (pedidoOverlay) {
                pedidoOverlay.style.display = 'none';
            }

            // Verificar si el objeto empleado existe, si no, crear uno por defecto
            if (typeof empleado === 'undefined') {
                window.empleado = {
                    nombre_completo: 'Administrador',
                    usuario: 'admin',
                    id_rol: 1
                };
            }

            const pinInput = document.getElementById('admin-pin-input');
            const btnGuardar = document.getElementById('btn-guardar-admin-pin');

            // Solo ejecutar l√≥gica del PIN si existen los elementos
            if (pinInput && btnGuardar) {
                // Cargar PIN actual
                fetch(BACKEND_API + '/admin/api/pin_admin.php')
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status}`);
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data.success && typeof data.pin !== 'undefined') {
                            pinInput.value = data.pin;
                        } else {
                            console.warn('No se pudo cargar el PIN:', data.error || 'Error desconocido');
                        }
                    })
                    .catch(err => {
                        console.error('Error cargando PIN:', err);
                        // No mostrar error al usuario, solo log
                    });

                // Guardar PIN
                btnGuardar.addEventListener('click', async function () {
                    const nuevoPin = pinInput.value.trim();

                    if (nuevoPin === '') {
                        alert('Por favor ingrese un PIN v√°lido');
                        return;
                    }

                    btnGuardar.disabled = true;
                    btnGuardar.textContent = 'Guardando...';

                    try {
                        const res = await fetch(BACKEND_API + '/admin/api/pin_admin.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({ pin: nuevoPin })
                        });

                        if (!res.ok) {
                            throw new Error(`HTTP error! status: ${res.status} - ${res.statusText}`);
                        }

                        const result = await res.json();

                        if (result.success) {
                            btnGuardar.textContent = 'Guardado ‚úî';
                            setTimeout(() => {
                                btnGuardar.textContent = 'Guardar PIN';
                                btnGuardar.disabled = false;
                            }, 1200);
                        } else {
                            btnGuardar.textContent = 'Error';
                            btnGuardar.disabled = false;
                            alert('Error al guardar PIN: ' + (result.error || 'Error desconocido'));
                        }
                    } catch (error) {
                        console.error('Error guardando PIN:', error);
                        btnGuardar.textContent = 'Error';
                        btnGuardar.disabled = false;
                        alert('Error de conexi√≥n: ' + error.message);
                    }
                });
            }

            // Configurar theme toggle
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                const body = document.body;
                const savedTheme = localStorage.getItem('theme') || 'light';
                body.setAttribute('data-theme', savedTheme);
                themeToggle.checked = savedTheme === 'dark';

                themeToggle.addEventListener('change', function () {
                    const theme = this.checked ? 'dark' : 'light';
                    body.setAttribute('data-theme', theme);
                    localStorage.setItem('theme', theme);
                });
            }

            // Actualizar UI con info del usuario
            const nameEl = document.getElementById('user-name');
            if (nameEl) {
                nameEl.textContent = empleado.nombre_completo || empleado.usuario || 'Usuario';
            }

            // Configurar bot√≥n de logout
            const btnLogout = document.getElementById('btn-logout');
            if (btnLogout) {
                btnLogout.addEventListener('click', function () {
                    if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                        // Limpiar datos de sesi√≥n
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('empleado');
                        // Redirigir al login
                        window.location.href = 'login.html';
                    }
                });
            }

            // Verificar permisos b√°sicos (comentado para evitar redirecci√≥n)
            // if (![1, 2, 3].includes(empleado.id_rol)) {
            //     console.error('Rol no autorizado:', empleado.id_rol);
            //     window.location.href = 'login.html';
            //     return;
            // }

            // === CONFIGURACI√ìN DE NAVEGACI√ìN SPA ===
            // Eliminar flag de autorizaci√≥n, siempre se pide PIN
            const menuItems = document.querySelectorAll('#sidebar-menu li');
            const sections = {
                dashboard: document.getElementById('dashboard-section'),
                productos: document.getElementById('productos-section'),
                pedidos: document.getElementById('pedidos-section'),
                comandas: document.getElementById('comandas-section'),
                estadisticas: document.getElementById('estadisticas-section'),
                usuarios: document.getElementById('usuarios-section'),
                proveedores: document.getElementById('proveedores-section'),
                configuracion: document.getElementById('configuracion-section')
            };
            const breadcrumb = document.getElementById('breadcrumb');

            // === FUNCIONES PARA MANEJO DE URL CON PAR√ÅMETROS ===
            function obtenerSeccionDesdURL() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('section') || 'dashboard';
            }

            function actualizarURL(section) {
                const url = new URL(window.location);
                url.searchParams.set('section', section);
                window.history.pushState({ section }, '', url);
            }

            function navegarASeccion(section, skipURLUpdate = false, skipPermissionCheck = false) {
                // Verificar permisos por rol solo si no se especifica omitir y authManager est√° disponible
                if (!skipPermissionCheck && window.authManager && typeof window.authManager.tienePermiso === 'function') {
                    const permisosPorSeccion = {
                        'dashboard': [1, 2],    // Admin y Supervisor
                        'productos': [1, 2],    // Admin y Supervisor
                        'pedidos': [1, 2],      // Admin y Supervisor
                        'comandas': [1, 2, 3],  // Todos los roles
                        'estadisticas': [1, 2], // Admin y Supervisor
                        'usuarios': [1],        // Solo Admin
                        'proveedores': [1],     // Solo Admin
                        'configuracion': [1]    // Solo Admin
                    };

                    const rolesPermitidos = permisosPorSeccion[section] || [1, 2, 3];
                    if (!window.authManager.tienePermiso(rolesPermitidos)) {
                        alert('No tienes permisos para acceder a esta secci√≥n.');
                        return false;
                    }
                }

                // Cambiar activo en men√∫
                menuItems.forEach(i => i.classList.remove('active'));
                const menuItem = document.querySelector(`#sidebar-menu li[data-section="${section}"]`);
                if (menuItem) {
                    menuItem.classList.add('active');
                    console.log('‚úÖ Menu item activado para:', section);
                } else {
                    console.warn('‚ö†Ô∏è No se encontr√≥ menu item para secci√≥n:', section);
                }

                // Mostrar la secci√≥n correspondiente
                let sectionFound = false;
                Object.keys(sections).forEach(key => {
                    if (sections[key]) {
                        if (key === section) {
                            sections[key].style.display = '';
                            sectionFound = true;
                            console.log('‚úÖ Secci√≥n mostrada:', section);
                        } else {
                            sections[key].style.display = 'none';
                        }
                    }
                });

                if (!sectionFound) {
                    console.warn('‚ö†Ô∏è No se pudo mostrar la secci√≥n:', section);
                }

                // Cambiar el breadcrumb
                if (breadcrumb && menuItem) {
                    breadcrumb.innerHTML = `Buffet Murialdino <span class="breadcrumb-sep">/</span> ${menuItem.textContent.trim()}`;
                }

                // Actualizar URL solo si no se especifica lo contrario
                if (!skipURLUpdate) {
                    actualizarURL(section);
                }

                // L√≥gica espec√≠fica por secci√≥n
                if (typeof handleSectionChange === 'function') {
                    handleSectionChange(section);
                }

                return true;
            }

            function mostrarModalPinAdmin(callback) {
                const modal = document.getElementById('modal-pin-admin');
                const input = document.getElementById('input-pin-admin');
                const error = document.getElementById('pin-admin-error');

                if (!modal || !input || !error) {
                    console.error('Elementos del modal PIN no encontrados');
                    if (typeof callback === 'function') callback();
                    return;
                }

                modal.style.display = 'flex';
                input.value = '';
                error.style.display = 'none';
                input.focus();

                function cerrar() {
                    modal.style.display = 'none';
                    input.value = '';
                    error.style.display = 'none';
                    // Remover listeners al cerrar
                    document.removeEventListener('keydown', handleEscKey);
                    modal.removeEventListener('click', handleClickOutside);
                }

                // Funci√≥n para manejar la tecla ESC
                function handleEscKey(e) {
                    if (e.key === 'Escape') {
                        cerrar();
                    }
                }

                // Funci√≥n para manejar click fuera del modal
                function handleClickOutside(e) {
                    // Solo cerrar si se hace click en el fondo del modal, no en el contenido
                    if (e.target === modal) {
                        cerrar();
                    }
                }

                // Agregar listeners
                document.addEventListener('keydown', handleEscKey);
                modal.addEventListener('click', handleClickOutside);

                document.getElementById('btn-pin-admin-cancelar').onclick = cerrar;
                document.getElementById('btn-pin-admin-confirmar').onclick = async function () {
                    const pinIngresado = input.value.trim();
                    
                    if (pinIngresado === '') {
                        error.textContent = 'Ingrese un PIN';
                        error.style.display = 'block';
                        input.focus();
                        return;
                    }
                    
                    try {
                        // Obtener el PIN actual de la base de datos
                        const response = await fetch(BACKEND_API + '/admin/api/pin_admin.php');
                        const data = await response.json();
                        
                        if (data.success) {
                            const pinActual = data.pin || '1233'; // PIN por defecto si no existe
                            
                            if (pinIngresado === pinActual) {
                                cerrar();
                                if (typeof callback === 'function') callback();
                            } else {
                                error.textContent = 'PIN incorrecto';
                                error.style.display = 'block';
                                input.value = '';
                                input.focus();
                            }
                        } else {
                            error.textContent = 'Error al verificar PIN';
                            error.style.display = 'block';
                            input.value = '';
                            input.focus();
                        }
                    } catch (err) {
                        console.error('Error verificando PIN:', err);
                        error.textContent = 'Error de conexi√≥n';
                        error.style.display = 'block';
                        input.value = '';
                        input.focus();
                    }
                };

                input.onkeydown = function (e) {
                    if (e.key === 'Enter') {
                        document.getElementById('btn-pin-admin-confirmar').click();
                    }
                };
            }

            // Interceptar navegaci√≥n a usuarios y configuraci√≥n
            menuItems.forEach(item => {
                item.addEventListener('click', function (e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');

                    console.log('Navegando a secci√≥n:', section); // Debug

                    if (section === 'usuarios' || section === 'configuracion' || section === 'proveedores') {
                        mostrarModalPinAdmin(() => {
                            navegarASeccion(section);
                        });
                    } else {
                        // Navegaci√≥n normal para otras secciones
                        navegarASeccion(section);
                    }
                });
            });

            // === INICIALIZACI√ìN DESDE URL ===
            // Cargar la secci√≥n desde la URL al inicializar
            function inicializarSeccionDesdeURL() {
                const seccionURL = obtenerSeccionDesdURL();
                console.log('üîç Inicializando secci√≥n desde URL:', seccionURL);
                console.log('üìã Secciones disponibles:', Object.keys(sections));
                console.log('üîê AuthManager disponible:', !!window.authManager);
                
                // Verificar que la secci√≥n existe
                if (sections[seccionURL]) {
                    console.log('‚úÖ Secci√≥n encontrada, navegando a:', seccionURL);
                    if (seccionURL === 'usuarios' || seccionURL === 'configuracion' || seccionURL === 'proveedores') {
                        // Para secciones protegidas, mostrar modal PIN
                        console.log('üîí Secci√≥n protegida, mostrando PIN...');
                        mostrarModalPinAdmin(() => {
                            navegarASeccion(seccionURL, true, true); // true para no actualizar URL y omitir permisos
                        });
                    } else {
                        // Para secciones normales, navegar directamente omitiendo verificaci√≥n de permisos inicial
                        navegarASeccion(seccionURL, true, true); // true para no actualizar URL y omitir permisos
                    }
                } else {
                    // Si la secci√≥n no existe, ir al dashboard
                    console.log('‚ùå Secci√≥n no encontrada, redirigiendo a dashboard');
                    navegarASeccion('dashboard', true, true);
                }
            }

            // Manejar navegaci√≥n del navegador (botones atr√°s/adelante)
            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.section) {
                    navegarASeccion(event.state.section, true, true); // Omitir verificaci√≥n de permisos en navegaci√≥n del navegador
                } else {
                    inicializarSeccionDesdeURL();
                }
            });

            // Inicializar la secci√≥n correcta al cargar la p√°gina
            setTimeout(() => {
                inicializarSeccionDesdeURL();
            }, 500); // Aumentado el tiempo para permitir que se carguen los scripts de auth

            // Verificaci√≥n adicional en caso de que la primera falle
            setTimeout(() => {
                const activeMenuItem = document.querySelector('#sidebar-menu li.active');
                if (!activeMenuItem) {
                    console.log('Reintentando inicializaci√≥n desde URL...');
                    inicializarSeccionDesdeURL();
                }
            }, 1500);

            // === CONFIGURACI√ìN DE PESTA√ëAS ===

            // Cargar la pesta√±a guardada solo si la secci√≥n de configuraci√≥n est√° visible
            const lastConfigTab = localStorage.getItem('configTab') || 'general';
            if (typeof showConfigPanel === 'function') {
                // Solo restaurar la pesta√±a si estamos en la secci√≥n de configuraci√≥n
                const configSection = document.getElementById('configuracion-section');
                if (configSection && configSection.style.display !== 'none') {
                    showConfigPanel(lastConfigTab);
                }
            }

            // === CONFIGURACI√ìN DEL SIDEBAR M√ìVIL ===

            const menuBtn = document.querySelector('.menu-btn');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');

            if (menuBtn && sidebar && sidebarOverlay) {
                function toggleSidebar() {
                    sidebar.classList.toggle('show');
                    sidebarOverlay.classList.toggle('show');
                }

                menuBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    toggleSidebar();
                });

                sidebarOverlay.addEventListener('click', function (e) {
                    e.preventDefault();
                    toggleSidebar();
                });

                sidebar.addEventListener('click', function (e) {
                    if (e.target.closest('.sidebar-nav li')) {
                        toggleSidebar();
                    }
                });
            }

            // === INICIALIZACI√ìN DE COMANDAS ===

            const comandasMenuItem = document.querySelector('[data-section="comandas"]');
            if (comandasMenuItem) {
                comandasMenuItem.addEventListener('click', function () {
                    // Cargar pedidos inmediatamente al abrir comandas
                    setTimeout(() => {
                        if (typeof cargarPedidosComandas === 'function') {
                            cargarPedidosComandas();
                        }
                    }, 100);

                    // Iniciar actualizaci√≥n autom√°tica cada 15 segundos
                    if (intervalComandas) clearInterval(intervalComandas);
                    intervalComandas = setInterval(() => {
                        if (typeof cargarPedidosComandas === 'function') {
                            cargarPedidosComandas();
                        }
                    }, 15000);
                });
            }

            // === CONFIGURACI√ìN DE INTERVALOS ===

            // Detener actualizaci√≥n autom√°tica al cambiar de secci√≥n
            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    const currentSection = this.getAttribute('data-section');

                    // Detener intervalos seg√∫n la secci√≥n
                    if (currentSection !== 'comandas' && intervalComandas) {
                        clearInterval(intervalComandas);
                        intervalComandas = null;
                    }

                    if (currentSection !== 'pedidos' && intervalPedidos) {
                        clearInterval(intervalPedidos);
                        intervalPedidos = null;
                    }

                    if (currentSection !== 'dashboard' && intervalDashboard) {
                        clearInterval(intervalDashboard);
                        intervalDashboard = null;
                    }
                });
            });

            // === PANEL DE PRUEBAS ===

            setTimeout(() => {
                if (typeof crearPanelPruebas === 'function') {
                    crearPanelPruebas();
                }
            }, 1000);

            // === VERIFICACI√ìN INICIAL DEL DASHBOARD ===
            // Comentado para evitar interferencia con navegaci√≥n por URL
            // La verificaci√≥n del dashboard ahora se hace desde handleSectionChange

            // // Verificar inmediatamente
            // setTimeout(() => {
            //     verificarYCargarDashboard();
            // }, 100);

            // // Verificaci√≥n adicional despu√©s de 500ms
            // setTimeout(() => {
            //     verificarYCargarDashboard();
            // }, 500);

            // === INICIALIZACI√ìN DE MODALES ===

            // Modal usuario
            const modalUsuario = document.getElementById('modal-agregar-usuario');
            if (modalUsuario) {
                // Cerrar modal al hacer clic fuera
                modalUsuario.addEventListener('click', (e) => {
                    if (e.target.id === 'modal-agregar-usuario') {
                        e.target.style.display = 'none';
                    }
                });

                // Cerrar modal con Escape
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (modalUsuario.style.display === 'block' || modalUsuario.style.display === 'flex') {
                            modalUsuario.style.display = 'none';
                        }
                    }
                });
            }

            // === LISTENER PARA FILTRADO DE CATEGOR√çAS POR PUNTO DE VENTA ===
            const puntoVentaSelect = document.getElementById('punto-venta-select');
            if (puntoVentaSelect) {
                puntoVentaSelect.addEventListener('change', (e) => {
                    const puntoVentaId = e.target.value;
                    const categoriaSelect = document.getElementById('categoria-select');
                    
                    if (categoriaSelect) {
                        // Limpiar categor√≠as
                        categoriaSelect.innerHTML = '<option value="">Seleccionar categor√≠a</option>';
                        
                        // Si hay punto de venta seleccionado, filtrar categor√≠as
                        if (puntoVentaId && window.productosManager && window.productosManager.categorias) {
                            const categoriasFiltradas = window.productosManager.categorias.filter(cat => 
                                cat.id_punto_venta == puntoVentaId
                            );
                            
                            categoriasFiltradas.forEach(categoria => {
                                const option = document.createElement('option');
                                option.value = categoria.id_categoria;
                                option.textContent = categoria.nombre;
                                categoriaSelect.appendChild(option);
                            });
                            
                            // Mensaje si no hay categor√≠as para este punto de venta
                            if (categoriasFiltradas.length === 0) {
                                const option = document.createElement('option');
                                option.value = '';
                                option.textContent = 'No hay categor√≠as para este punto de venta';
                                option.disabled = true;
                                categoriaSelect.appendChild(option);
                            }
                        }
                        
                        // Resetear la categor√≠a seleccionada
                        categoriaSelect.value = '';
                    }
                });
            }

        }); // Cierre del listener DOMContentLoaded principal

        // Tambi√©n verificar cuando la ventana est√© completamente cargada
        // Comentado para evitar interferencia con navegaci√≥n por URL
        // window.addEventListener('load', function () {
        //     setTimeout(() => {
        //         verificarYCargarDashboard();
        //     }, 100);
        // });

        // === FUNCI√ìN PARA MANEJAR CAMBIOS DE SECCI√ìN ===
        function handleSectionChange(section) {
            // Limpiar intervalos cuando se cambia de secci√≥n
            if (section !== 'dashboard' && intervalDashboard) {
                clearInterval(intervalDashboard);
                intervalDashboard = null;
            }
            if (section !== 'pedidos' && intervalPedidos) {
                clearInterval(intervalPedidos);
                intervalPedidos = null;
            }
            if (section !== 'comandas' && intervalComandas) {
                clearInterval(intervalComandas);
                intervalComandas = null;
            }

            // Ocultar todos los paneles de configuraci√≥n cuando se sale de la secci√≥n de configuraci√≥n
            if (section !== 'configuracion') {
                const configPanels = document.querySelectorAll('.config-panel');
                configPanels.forEach(panel => {
                    panel.style.display = 'none';
                });
            }

            // Restaurar la pesta√±a de configuraci√≥n guardada cuando se entra a configuraci√≥n
            if (section === 'configuracion') {
                const lastConfigTab = localStorage.getItem('configTab') || 'general';
                if (typeof showConfigPanel === 'function') {
                    setTimeout(() => showConfigPanel(lastConfigTab), 100);
                }
            }

            // Recargar datos del dashboard si se navega a √©l
            if (section === 'dashboard') {
                setTimeout(() => {
                    if (typeof cargarDashboardData === 'function') {
                        cargarDashboardData();
                        dashboardCargado = true;
                    }
                    // Tambi√©n ejecutar verificarYCargarDashboard para compatibilidad
                    if (typeof verificarYCargarDashboard === 'function') {
                        verificarYCargarDashboard();
                    }
                }, 100);

                if (intervalDashboard) clearInterval(intervalDashboard);
                intervalDashboard = setInterval(() => {
                    if (typeof cargarDashboardData === 'function') {
                        cargarDashboardData();
                    }
                }, 25000);
            }

            // Cargar pedidos si se navega a la secci√≥n de pedidos
            if (section === 'pedidos') {
                setTimeout(async () => {
                    // Cargar datos primero
                    if (window.pedidosManager) {
                        await window.pedidosManager.cargarPedidos();
                    } else if (typeof cargarPedidos === 'function') {
                        await cargarPedidos();
                    }
                    
                    // Luego inicializar controles de paginaci√≥n
                    setTimeout(() => {
                        if (typeof setupPedidosControls === 'function') {
                            setupPedidosControls();
                        }
                    }, 200);
                    
                }, 100);

                if (intervalPedidos) clearInterval(intervalPedidos);
                intervalPedidos = setInterval(() => {
                    if (window.pedidosManager) {
                        window.pedidosManager.cargarPedidos();
                    } else if (typeof cargarPedidos === 'function') {
                        cargarPedidos();
                    }
                }, 20000);
            }

            // Cargar estad√≠sticas si se navega a la secci√≥n de estad√≠sticas
            if (section === 'estadisticas') {
                setTimeout(async () => {
                    try {
                        if (typeof chartsInitialized !== 'undefined') {
                            chartsInitialized = false;
                        }

                        // Cargar datos de estad√≠sticas
                        if (typeof cargarEstadisticasFiltradas === 'function') {
                            await cargarEstadisticasFiltradas(filtroActual || 'hoy');
                        }

                        // Inicializar gr√°ficos
                        if (typeof cargarVentasPorDia === 'function') {
                            await cargarVentasPorDia(filtroActual || 'hoy');
                        }
                        if (typeof cargarMetodosPago === 'function') {
                            await cargarMetodosPago(filtroActual || 'hoy');
                        }
                        if (typeof cargarTopProductos === 'function') {
                            await cargarTopProductos();
                        }
                        if (typeof cargarPedidosPorHora === 'function') {
                            await cargarPedidosPorHora(filtroActual || 'hoy');
                        }
                        if (typeof cargarRentabilidad === 'function') {
                            await cargarRentabilidad(filtroActual || 'hoy');
                        }

                        // Setup rentability controls after loading data
                        if (typeof setupRentabilidadControls === 'function') {
                            setupRentabilidadControls();
                        }

                        if (typeof chartsInitialized !== 'undefined') {
                            chartsInitialized = true;
                        }
                    } catch (error) {
                        console.error('Error cargando estad√≠sticas inicial:', error);
                    }
                }, 200);
            }
            
            // Cargar proveedores si se navega a la secci√≥n de proveedores
            if (section === 'proveedores') {
                setTimeout(() => {
                    if (window.proveedoresManager && typeof window.proveedoresManager.init === 'function') {
                        // Solo inicializar si no se ha hecho antes
                        const seccionProveedores = document.getElementById('proveedores-section');
                        if (seccionProveedores && !seccionProveedores.dataset.initialized) {
                            seccionProveedores.dataset.initialized = 'true';
                            window.proveedoresManager.init();
                        }
                    }
                }, 100);
            }

            // Cargar usuarios si se navega a la secci√≥n de usuarios
            if (section === 'usuarios') {
                setTimeout(() => {
                    console.log('Navegando a secci√≥n usuarios, inicializando manager...');
                    if (typeof inicializarUsuariosManager === 'function') {
                        inicializarUsuariosManager();
                    } else if (typeof window.getUsuariosManager === 'function') {
                        window.getUsuariosManager();
                    }
                }, 100);
            }

            // Cargar comandas si se navega a la secci√≥n de comandas
            if (section === 'comandas') {
                setTimeout(() => {
                    console.log('Navegando a secci√≥n comandas, cargando pedidos...');
                    if (typeof cargarPedidosComandas === 'function') {
                        cargarPedidosComandas();
                        console.log('‚úÖ Comandas cargadas correctamente');
                    } else {
                        console.log('‚ö†Ô∏è Funci√≥n cargarPedidosComandas no disponible');
                    }
                }, 100);

                // Configurar intervalo para actualizaci√≥n autom√°tica
                if (intervalComandas) clearInterval(intervalComandas);
                intervalComandas = setInterval(() => {
                    if (typeof cargarPedidosComandas === 'function') {
                        cargarPedidosComandas();
                    }
                }, 30000); // Actualizar cada 30 segundos
            }

            // Cargar productos si se navega a la secci√≥n de productos
            if (section === 'productos') {
                setTimeout(() => {
                    console.log('Navegando a secci√≥n productos, inicializando manager...');
                    if (!window.productosManager && typeof ProductosManager !== 'undefined') {
                        // Si la clase est√° disponible pero no hay instancia, crear una
                        window.productosManager = new ProductosManager();
                        console.log('‚úÖ ProductosManager inicializado correctamente');
                    } else if (window.productosManager && typeof window.productosManager.cargarProductos === 'function') {
                        // Si ya existe, solo recargar los productos
                        window.productosManager.cargarProductos();
                        console.log('üîÑ Productos recargados desde manager existente');
                    } else {
                        console.log('‚ö†Ô∏è ProductosManager no disponible a√∫n, reintentando...');
                        // Reintentar despu√©s de un momento por si el script a√∫n se est√° cargando
                        setTimeout(() => {
                            if (typeof ProductosManager !== 'undefined' && !window.productosManager) {
                                window.productosManager = new ProductosManager();
                                console.log('‚úÖ ProductosManager inicializado correctamente (segundo intento)');
                            }
                        }, 500);
                    }
                }, 100);
            }
        }

        // === FUNCIONES DEFINIDAS FUERA DE LISTENERS ===

        // Funci√≥n para cargar productos desde el API
        async function cargarProductos() {
            try {
                const response = await fetch('../../backend/api/api_kiosco.php?action=get_productos');
                const data = await response.json();
                if (data.success && data.productos) {
                    productos = data.productos;
                } else {
                    console.warn('No se pudieron cargar productos:', data);
                    productos = []; // Array vac√≠o como fallback
                }
            } catch (error) {
                console.error('Error cargando productos:', error);
                productos = []; // Array vac√≠o como fallback
            }
        }

        // Simulaci√≥n de productos (esto debe reemplazarse por la carga real)
        function renderProductos() {
            const tbody = document.getElementById('productos-tbody');
            if (!tbody) return;

            tbody.innerHTML = '';

            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #666;">No hay productos registrados</td></tr>';
                return;
            }

            productos.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${producto.nombre}</td>
          <td>${producto.categoria}</td>
          <td>$${producto.precio}</td>
          <td>${producto.stock}</td>
          <td class="estado-col">${producto.estado ? '<span class="estado-green">Activo</span>' : '<span class="estado-red">Inactivo</span>'}</td>
          <td>
            <button class="btn-icon" onclick="toggleEstadoProducto(${producto.id})">${producto.estado ? 'Desactivar' : 'Activar'}</button>
            <!-- Otros botones de acciones -->
          </td>
        `;
                tbody.appendChild(tr);
            });
        }

        window.toggleEstadoProducto = function (id) {
            const prod = productos.find(p => p.id === id);
            if (prod) {
                prod.estado = prod.estado ? 0 : 1;
                renderProductos();
            }
        };

        // Funci√≥n para inicializar productos
        async function inicializarProductos() {
            await cargarProductos();
            renderProductos();
        }

        // Render inicial - ahora se llama despu√©s de cargar productos
        // Se llamar√° desde showConfigPanel cuando se seleccione la pesta√±a de productos

        function cerrarDetallePedido() {
            document.getElementById('pedido-overlay').style.display = 'none';
        }

        function generarEstadoBadge(estado) {
            const estadoLower = estado.toLowerCase();
            let background, color, icon, text;

            if (estadoLower === 'pendiente' || estadoLower === 'esperando') {
                background = '#fff3cd';
                color = '#856404';
                icon = '<svg width=18 height=18 viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx=10 cy=10 r=10 fill="#856404"/><path d="M10 6v4l3 3" stroke="#fff" stroke-width=2 stroke-linecap="round"/></svg>';
                text = estadoLower;
            } else if (estadoLower === 'preparacion' || estadoLower === 'preparando') {
                background = '#d1ecf1';
                color = '#0c5460';
                icon = '<svg width=18 height=18 viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx=10 cy=10 r=10 fill="#0c5460"/><path d="M6 10l3 3 5-5" stroke="#fff" stroke-width=2 stroke-linecap="round"/></svg>';
                text = estadoLower;
            } else if (estadoLower === 'preparado' || estadoLower === 'listo') {
                background = '#d4edda';
                color = '#155724';
                icon = '<svg width=18 height=18 viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx=10 cy=10 r=10 fill="#155724"/><path d="M6 10l3 3 5-5" stroke="#fff" stroke-width=2 stroke-linecap="round"/></svg>';
                text = estadoLower;
            } else if (estadoLower === 'entregado' || estadoLower === 'completado' || estadoLower === 'pago') {
                background = '#e6f9ed';
                color = '#1a7f37';
                icon = '<svg width=18 height=18 viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx=10 cy=10 r=10 fill="#1a7f37"/><path d="M6 10.5L9 13.5L14 8.5" stroke="#fff" stroke-width=2 stroke-linecap="round" stroke-linejoin="round"/></svg>';
                text = estadoLower;
            } else if (estadoLower === 'cancelado') {
                background = '#f8d7da';
                color = '#721c24';
                icon = '<svg width=18 height=18 viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx=10 cy=10 r=10 fill="#721c24"/><path d="M6 6l8 8m0-8l-8 8" stroke="#fff" stroke-width=2 stroke-linecap="round"/></svg>';
                text = estadoLower;
            } else {
                // Estado desconocido
                background = '#f8f9fa';
                color = '#6c757d';
                icon = '<svg width=18 height=18 viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx=10 cy=10 r=10 fill="#6c757d"/><path d="M10 6v4l3 3" stroke="#fff" stroke-width=2 stroke-linecap="round"/></svg>';
                text = estadoLower;
            }

            return `<span style="display:inline-flex;align-items:center;gap:6px;background:${background};color:${color};font-weight:600;padding:4px 14px;border-radius:16px;font-size:15px;">${icon} ${text}</span>`;
        }


        // Despu√©s de renderizar, agrega los listeners para los botones de ojo:
        document.querySelectorAll('.btn-abrir-overlay').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const idx = this.getAttribute('data-idx');
                mostrarDetallePedido(data.pedidos[idx]);
            });
        });

        // Cargar datos del dashboard al cargar la p√°gina



        // Funci√≥n para verificar y cargar dashboard si es necesario
        function verificarYCargarDashboard() {
            const activeMenuItem = document.querySelector('#sidebar-menu li.active');
            const activeSection = activeMenuItem ? activeMenuItem.getAttribute('data-section') : null;
            const dashboardSection = document.getElementById('dashboard-section');
            const ordersListElement = document.getElementById('orders-list');

            if (activeSection === 'dashboard' && dashboardSection && ordersListElement) {
                if (!dashboardCargado) {
                    cargarDashboardData();
                    dashboardCargado = true;
                    // Iniciar actualizaci√≥n autom√°tica
                    if (intervalDashboard) clearInterval(intervalDashboard);
                    intervalDashboard = setInterval(cargarDashboardData, 25000);
                }
            }
        }

        // Cargar datos inicialmente cuando se carga la p√°gina
        // (Se ejecutar√° en el listener consolidado principal)

        // Tambi√©n verificar cuando la ventana est√© completamente cargada
        // (Se ejecutar√° en el listener consolidado principal)
    </script>

    <script>
        // --- Definir cargarPedidos antes de los listeners SPA ---
        async function cargarPedidos() {
            const tbody = document.querySelector('.pedidos-table tbody');
            const listCount = document.querySelector('.pedidos-lista-count');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">Cargando...</td></tr>';

            try {
                const res = await fetch(BACKEND_API + '/admin/api/api_pedidos.php');
                const data = await res.json();

                if (data.success && data.pedidos) {
                    // Guardar todos los pedidos globalmente
                    pedidosDataGlobal = data.pedidos;
                    pedidosPaginacion.totalItems = pedidosDataGlobal.length;
                    pedidosPaginacion.totalPaginas = Math.ceil(pedidosPaginacion.totalItems / pedidosPaginacion.itemsPorPagina);
                    
                    // Renderizar los pedidos paginados
                    renderPedidosTable();
                    
                    // FORZAR CORRECCI√ìN DE ESTILOS DESPU√âS DE CARGAR
                    setTimeout(() => {
                        limpiarEstilosEstados();
                    }, 100);
                    
                } else {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No hay pedidos registrados.</td></tr>';
                    if (listCount) listCount.textContent = '0 pedidos encontrados';
                    actualizarInfoPaginacionPedidos();
                }
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #ef4444;">Error de conexi√≥n</td></tr>';
                if (listCount) listCount.textContent = '0 pedidos encontrados';
                console.error('Error de conexi√≥n:', e);
            }
        }

        function renderPedidosTable() {
            const tbody = document.querySelector('.pedidos-table tbody');
            const listCount = document.querySelector('.pedidos-lista-count');
            
            if (!tbody) {
                console.error('No se encontr√≥ el tbody de la tabla de pedidos');
                return;
            }

            // Verificar si hay datos globales disponibles
            if (!pedidosDataGlobal || pedidosDataGlobal.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No hay pedidos disponibles</td></tr>';
                if (listCount) {
                    listCount.textContent = '0 pedidos encontrados';
                }
                actualizarInfoPaginacionPedidos();
                return;
            }

            // Calcular √≠ndices de paginaci√≥n
            const inicio = (pedidosPaginacion.paginaActual - 1) * pedidosPaginacion.itemsPorPagina;
            const fin = inicio + pedidosPaginacion.itemsPorPagina;
            const pedidosPaginados = pedidosDataGlobal.slice(inicio, fin);

            console.log(`Renderizando p√°gina ${pedidosPaginacion.paginaActual}: ${inicio}-${fin} de ${pedidosDataGlobal.length} pedidos`);

            if (pedidosPaginados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem;">No hay pedidos en esta p√°gina</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // Limpiar completamente el tbody antes de agregar nuevo contenido
            tbody.innerHTML = '';
            
            pedidosPaginados.forEach(pedido => {
                const fecha = new Date(pedido.creado_en);
                const hora = fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                // Generar estado badge sin iconos para consistencia visual
                const estadoLower = pedido.estado.toLowerCase();
                let estadoClass = '';
                
                if (estadoLower === 'pendiente' || estadoLower === 'esperando') {
                    estadoClass = 'estado-pendiente';
                } else if (estadoLower === 'preparacion' || estadoLower === 'preparando') {
                    estadoClass = 'estado-preparacion';
                } else if (estadoLower === 'preparado' || estadoLower === 'listo') {
                    estadoClass = 'estado-preparado';
                } else if (estadoLower === 'entregado' || estadoLower === 'completado' || estadoLower === 'pago') {
                    estadoClass = 'estado-entregado';
                } else if (estadoLower === 'cancelado') {
                    estadoClass = 'estado-cancelado';
                } else {
                    estadoClass = 'estado-pendiente'; // Fallback
                }
                
                const estadoBadge = `<span class="${estadoClass}">${pedido.estado}</span>`;

                // Crear row element en lugar de innerHTML para mantener estilos
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="pedido-id">${pedido.numero_pedido}</span></td>
                    <td><span style="font-weight:500;">${pedido.cantidad_items} items</span></td>
                    <td>$${parseFloat(pedido.monto_total).toLocaleString()}</td>
                    <td>${estadoBadge}</td>
                    <td>${pedido.metodo_pago || 'N/A'}</td>
                    <td>${pedido.punto_venta || 'N/A'}</td>
                    <td>${hora}</td>
                    <td><button class="btn-icon btn-abrir-overlay" type="button" data-pedido-id="${pedido.id_pedido}" title="Ver detalles">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button></td>
                `;
                
                // Agregar event listener espec√≠fico para este bot√≥n
                const btnVer = row.querySelector('.btn-abrir-overlay');
                if (btnVer) {
                    btnVer.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        mostrarDetallePedido(Number(pedido.id_pedido));
                    });
                }
                
                tbody.appendChild(row);
            });

            // Actualizar contador y paginaci√≥n
            if (listCount) {
                listCount.textContent = `${pedidosPaginacion.totalItems} pedidos encontrados`;
            }
            
            actualizarInfoPaginacionPedidos();
            
            // FORZAR CORRECCI√ìN DE ESTILOS DESPU√âS DEL RENDERIZADO
            setTimeout(() => {
                limpiarEstilosEstados();
            }, 50);
        }

        function cambiarPaginaPedidos(nuevaPagina) {
            if (nuevaPagina >= 1 && nuevaPagina <= pedidosPaginacion.totalPaginas) {
                pedidosPaginacion.paginaActual = nuevaPagina;
                renderPedidosTable();
            }
        }

        function actualizarInfoPaginacionPedidos() {
            // Asegurar que las p√°ginas est√©n calculadas correctamente
            if (pedidosPaginacion.totalItems > 0) {
                pedidosPaginacion.totalPaginas = Math.ceil(pedidosPaginacion.totalItems / pedidosPaginacion.itemsPorPagina);
            } else {
                pedidosPaginacion.totalPaginas = 1;
                pedidosPaginacion.paginaActual = 1;
            }
            
            const inicio = pedidosPaginacion.totalItems > 0 
                ? (pedidosPaginacion.paginaActual - 1) * pedidosPaginacion.itemsPorPagina + 1 
                : 0;
            const fin = Math.min(inicio + pedidosPaginacion.itemsPorPagina - 1, pedidosPaginacion.totalItems);

            // Actualizar info de paginaci√≥n
            const pageInfo = document.getElementById('page-info-pedidos');
            const itemsInfo = document.getElementById('items-info-pedidos');
            const prevBtn = document.getElementById('prev-page-pedidos');
            const nextBtn = document.getElementById('next-page-pedidos');

            if (pageInfo) {
                pageInfo.textContent = pedidosPaginacion.totalItems > 0 
                    ? `P√°gina ${pedidosPaginacion.paginaActual} de ${pedidosPaginacion.totalPaginas}`
                    : 'Sin datos';
            }
            
            if (itemsInfo) {
                itemsInfo.textContent = pedidosPaginacion.totalItems > 0 
                    ? `Mostrando ${inicio}-${fin} de ${pedidosPaginacion.totalItems} pedidos`
                    : 'No hay pedidos para mostrar';
            }
            
            if (prevBtn) {
                prevBtn.disabled = pedidosPaginacion.paginaActual === 1 || pedidosPaginacion.totalItems === 0;
            }
            
            if (nextBtn) {
                nextBtn.disabled = pedidosPaginacion.paginaActual === pedidosPaginacion.totalPaginas || pedidosPaginacion.totalItems === 0;
            }
        }

        function setupPedidosControls() {
            // Setup selector de items por p√°gina
            const itemsPorPaginaSelect = document.getElementById('pedidos-por-pagina');
            if (itemsPorPaginaSelect) {
                // Remover listeners previos
                const newSelect = itemsPorPaginaSelect.cloneNode(true);
                itemsPorPaginaSelect.parentNode.replaceChild(newSelect, itemsPorPaginaSelect);
                
                newSelect.addEventListener('change', async function() {
                    const newValue = parseInt(this.value);
                    if (newValue && newValue > 0) {
                        pedidosPaginacion.itemsPorPagina = newValue;
                        pedidosPaginacion.paginaActual = 1; // Resetear a la primera p√°gina
                        
                        console.log('Cambiando items por p√°gina a:', newValue);
                        console.log('Datos disponibles:', pedidosDataGlobal.length);
                        
                        // Verificar si hay datos disponibles
                        if (!pedidosDataGlobal || pedidosDataGlobal.length === 0) {
                            console.log('No hay datos disponibles, recargando...');
                            // Si no hay datos, cargarlos primero
                            try {
                                await cargarPedidos();
                            } catch (error) {
                                console.error('Error al cargar pedidos:', error);
                                return;
                            }
                        } else {
                            // Si hay datos, actualizar paginaci√≥n y renderizar
                            pedidosPaginacion.totalItems = pedidosDataGlobal.length;
                            pedidosPaginacion.totalPaginas = Math.ceil(pedidosPaginacion.totalItems / pedidosPaginacion.itemsPorPagina);
                            
                            console.log('Total items:', pedidosPaginacion.totalItems);
                            console.log('Total p√°ginas:', pedidosPaginacion.totalPaginas);
                            
                            // Re-renderizar con los datos existentes
                            renderPedidosTable();
                        }
                    }
                });
            }

            // Setup botones de navegaci√≥n
            const prevBtn = document.getElementById('prev-page-pedidos');
            const nextBtn = document.getElementById('next-page-pedidos');
            
            if (prevBtn) {
                const newPrevBtn = prevBtn.cloneNode(true);
                prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
                newPrevBtn.addEventListener('click', () => cambiarPaginaPedidos(pedidosPaginacion.paginaActual - 1));
            }
            
            if (nextBtn) {
                const newNextBtn = nextBtn.cloneNode(true);
                nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
                newNextBtn.addEventListener('click', () => cambiarPaginaPedidos(pedidosPaginacion.paginaActual + 1));
            }
        }

        // === FUNCI√ìN PARA LIMPIAR ESTILOS DE ESTADOS ===
        function limpiarEstilosEstados() {
            // Buscar todos los spans dentro de la tabla de pedidos que puedan tener estilos inconsistentes
            const tablaPedidos = document.querySelector('.pedidos-table tbody');
            if (!tablaPedidos) return;
            
            // Encontrar todos los spans con estilos inline que contengan gap
            const spanEstados = tablaPedidos.querySelectorAll('span[style*="gap"], span[style*="inline-flex"]');
            
            spanEstados.forEach(span => {
                const texto = span.textContent.toLowerCase().trim();
                let nuevaClase = '';
                
                // Determinar la clase correcta basada en el texto
                if (texto.includes('pendiente') || texto.includes('esperando')) {
                    nuevaClase = 'estado-pendiente';
                } else if (texto.includes('preparacion') || texto.includes('preparando')) {
                    nuevaClase = 'estado-preparacion';
                } else if (texto.includes('preparado') || texto.includes('listo')) {
                    nuevaClase = 'estado-preparado';
                } else if (texto.includes('entregado') || texto.includes('completado') || texto.includes('pago')) {
                    nuevaClase = 'estado-entregado';
                } else if (texto.includes('cancelado')) {
                    nuevaClase = 'estado-cancelado';
                }
                
                if (nuevaClase) {
                    // Remover estilos inline problem√°ticos
                    span.removeAttribute('style');
                    
                    // Remover clases existentes que puedan interferir
                    span.className = '';
                    
                    // Aplicar la clase correcta
                    span.classList.add(nuevaClase);
                    
                    // Remover cualquier SVG/icono
                    const svgs = span.querySelectorAll('svg');
                    svgs.forEach(svg => svg.remove());
                    
                    // Asegurar que solo tenga el texto del estado
                    span.textContent = span.textContent.replace(/\s+/g, ' ').trim();
                    
                    console.log(`üîß Corregido estado: "${texto}" -> clase: ${nuevaClase}`);
                }
            });
        }

        // Funciones para el manejo del overlay de pedidos
        async function mostrarDetallePedido(idPedido) {
            const overlay = document.getElementById('pedido-overlay');
            const overlayBody = document.getElementById('pedido-overlay-body');

            try {
                overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">Cargando detalles...</div>';
                overlay.style.display = 'block';

                // Obtener datos generales del pedido
                const response = await fetch(`${BACKEND_API}/admin/api/api_pedidos.php`);
                const data = await response.json();

                if (data.success && data.pedidos) {
                    idPedido = Number(idPedido);
                    const pedido = data.pedidos.find(p => Number(p.id_pedido) === idPedido);

                    if (!pedido) {
                        overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">No se encontr√≥ el pedido solicitado.</div>';
                        return;
                    }

                    // Obtener los items del pedido con una segunda petici√≥n
                    let items = [];
                    try {
                        const itemsRes = await fetch(`${BACKEND_API}/admin/api/api_pedidos.php?detalle=${idPedido}`);
                        const itemsData = await itemsRes.json();
                        if (itemsData.success && Array.isArray(itemsData.items)) {
                            items = itemsData.items;
                        }
                    } catch (e) {
                        // Si falla, items queda vac√≠o
                    }

                    const fecha = new Date(pedido.creado_en);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES');
                    const horaFormateada = fecha.toLocaleTimeString('es-ES');


                    let detalleHTML = `
            <div class="pedido-detalle">
              <div class="pedido-info">
                <p><strong>N√∫mero de Pedido:</strong> ${pedido.numero_pedido}</p>
                <p><strong>Fecha:</strong> ${fechaFormateada} ${horaFormateada}</p>
                <p><strong>Estado:</strong> <span class="estado-${pedido.estado.toLowerCase()}">${pedido.estado}</span></p>
                <p><strong>M√©todo de Pago:</strong> ${pedido.metodo_pago}</p>
                <p><strong>Total:</strong> $${parseFloat(pedido.monto_total).toLocaleString()}</p>
              </div>
              <div class="pedido-items">
                <h4>Items del Pedido</h4>
                <table class="items-table">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad</th>
                      <th>Precio Unit.</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

                    if (items.length > 0) {
                        // Agrupar items por producto y personalizaciones
                        const itemsAgrupados = {};
                        
                        items.forEach(item => {
                            // Crear clave √∫nica: nombre + personalizaciones ordenadas
                            const personalizacionesOrdenadas = item.personalizaciones ? 
                                [...item.personalizaciones].sort().join('|') : '';
                            const clave = `${item.nombre || item.nombre_producto || '-'}||${personalizacionesOrdenadas}`;
                            
                            if (itemsAgrupados[clave]) {
                                itemsAgrupados[clave].cantidad += parseInt(item.cantidad);
                            } else {
                                itemsAgrupados[clave] = {
                                    nombre: item.nombre || item.nombre_producto || '-',
                                    cantidad: parseInt(item.cantidad),
                                    personalizaciones: item.personalizaciones || [],
                                    precio_unitario: item.precio_unitario
                                };
                            }
                        });
                        
                        Object.values(itemsAgrupados).forEach(item => {
                            detalleHTML += `
                <tr>
                  <td>
                    ${item.nombre}`;
                            
                            // Agregar personalizaciones si existen
                            if (item.personalizaciones && item.personalizaciones.length > 0) {
                                detalleHTML += `<br><small style="color:#666;margin-left:10px;">`;
                                item.personalizaciones.forEach(pers => {
                                    detalleHTML += `- ${pers}<br>`;
                                });
                                detalleHTML += `</small>`;
                            }
                            
                            detalleHTML += `
                  </td>
                  <td>${item.cantidad}</td>
                  <td>${item.precio_unitario !== undefined ? '$' + parseFloat(item.precio_unitario).toLocaleString() : '-'}</td>
                </tr>
              `;
                        });
                    } else {
                        detalleHTML += `
              <tr>
                <td colspan="3" style="text-align: center;">No hay items disponibles para este pedido</td>
              </tr>
            `;
                    }

                    detalleHTML += `
                  </tbody>
                </table>
              </div>
            </div>
          `;

                    overlayBody.innerHTML = detalleHTML;
                } else {
                    overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">Error: No se pudieron cargar los detalles del pedido.</div>';
                }
            } catch (error) {
                console.error('Error al cargar detalles del pedido:', error);
                overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">Error de conexi√≥n al cargar los detalles.</div>';
            }
        }

        function cerrarDetallePedido() {
            const overlay = document.getElementById('pedido-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Agregar event listener para cerrar el overlay al hacer clic fuera del contenido
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('pedido-overlay');
            if (e.target === overlay) {
                cerrarDetallePedido();
            }
        });

        // === DASHBOARD DATA LOADING ===
        async function cargarDashboardData() {
            try {
                const res = await fetch(BACKEND_API + '/admin/api/api_pedidos.php');
                const data = await res.json();

                if (data.success && data.pedidos) {
                    // Calcular estad√≠sticas del d√≠a
                    // Obtener la fecha de hoy en formato local YYYY-MM-DD para coincidir con creado_en
                    const hoy = new Date().toLocaleDateString('sv-SE'); // 'sv-SE' da 'YYYY-MM-DD'
                    // Mostrar los formatos reales de creado_en
                    const pedidosHoy = data.pedidos.filter(p => p.creado_en.startsWith(hoy));

                    // Ventas del d√≠a
                    const ventasDia = pedidosHoy.reduce((sum, p) => sum + parseFloat(p.monto_total), 0);
                    const ventasDiaElement = document.getElementById('ventas-dia');
                    if (ventasDiaElement) {
                        ventasDiaElement.textContent = `$${ventasDia.toLocaleString()}`;
                    }

                    // Pedidos en curso (pendientes y en preparaci√≥n)
                    const pedidosEnCurso = pedidosHoy.filter(p =>
                        p.estado.toLowerCase() === 'pendiente' ||
                        p.estado.toLowerCase() === 'preparacion' ||
                        p.estado.toLowerCase() === 'preparado'
                    );

                    // Pedidos pendientes para tarjeta amarilla (pago pendiente + preparaci√≥n)
                    const pedidosPendientesYPreparacion = pedidosHoy.filter(p => {
                        const estado = p.estado.toLowerCase();
                        return estado === 'pendiente' || estado === 'preparacion';
                    });

                    const pedidosCursoElement = document.getElementById('pedidos-curso');
                    const pedidosPendientesElement = document.getElementById('pedidos-pendientes');

                    if (pedidosCursoElement) {
                        pedidosCursoElement.textContent = pedidosEnCurso.length;
                    }
                    if (pedidosPendientesElement) {
                        pedidosPendientesElement.textContent = `${pedidosPendientesYPreparacion.length} pend/prep`;
                    }

                    // M√©todo de pago m√°s usado
                    const metodosPago = {};
                    pedidosHoy.forEach(p => {
                        const metodo = p.metodo_pago || 'No especificado';
                        metodosPago[metodo] = (metodosPago[metodo] || 0) + 1;
                    });
                    const metodoMasUsado = Object.keys(metodosPago).reduce((a, b) =>
                        metodosPago[a] > metodosPago[b] ? a : b, 'No especificado'
                    );
                    document.getElementById('metodo-mas-usado').textContent = metodoMasUsado;

                    // Cargar pedidos recientes (√∫ltimos 5)
                    const pedidosRecientes = data.pedidos.slice(0, 5);
                    const ordersList = document.getElementById('orders-list');

                    if (pedidosRecientes.length === 0) {
                        ordersList.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No hay pedidos recientes</div>';
                    } else {
                        ordersList.innerHTML = '';
                        pedidosRecientes.forEach((pedido, index) => {
                            const hora = pedido.creado_en.split(' ')[1]?.slice(0, 5) || '';
                            const estadoClass = getEstadoClass(pedido.estado);
                            const estadoText = pedido.estado.toLowerCase();
                            const puntoVenta = pedido.punto_venta || 'Kiosco';

                            const orderCard = document.createElement('div');
                            orderCard.className = `order-card ${estadoClass}`;
                            orderCard.innerHTML = `
              <div class="order-id">#${pedido.numero_pedido}</div>
              <div class="order-info">
                <span class="order-name">${puntoVenta}</span>
                <span class="order-details">${pedido.cantidad_items || 0} items ‚Ä¢ ${hora}</span>
              </div>
              <div class="order-amount">$${Number(pedido.monto_total).toLocaleString()}</div>
              <div class="order-status status-${estadoClass}">${estadoText}</div>
            `;
                            ordersList.appendChild(orderCard);
                        });
                    }

                    // Actualizar tambi√©n las estad√≠sticas del resumen de ventas
                    const totalPedidos = pedidosHoy.length;
                    const ticketPromedio = totalPedidos > 0 ? (ventasDia / totalPedidos) : 0;

                    // Buscar elementos del resumen de ventas si existen
                    const totalPedidosElement = document.querySelector('.summary-box.summary-green .summary-value');
                    const ingresosElement = document.querySelector('.summary-box.summary-blue .summary-value');
                    const ticketPromedioElement = document.querySelector('.summary-box.summary-purple .summary-value');

                    if (totalPedidosElement) totalPedidosElement.textContent = totalPedidos;
                    if (ingresosElement) ingresosElement.textContent = `$${ventasDia.toLocaleString()}`;
                    if (ticketPromedioElement) ticketPromedioElement.textContent = `$${ticketPromedio.toFixed(2)}`;

                    // Cargar top 5 productos para el dashboard
                    await cargarDashboardTopProductos();

                } else {
                    // Si no hay datos, mostrar valores por defecto
                    document.getElementById('ventas-dia').textContent = '$0';
                    document.getElementById('pedidos-curso').textContent = '0';
                    document.getElementById('pedidos-pendientes').textContent = '0 pend/prep';
                    document.getElementById('metodo-mas-usado').textContent = '-';
                    document.getElementById('orders-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No hay pedidos registrados</div>';

                    // Cargar top 5 productos vac√≠o
                    const dashboardTop5List = document.getElementById('dashboard-top5-list');
                    if (dashboardTop5List) {
                        dashboardTop5List.innerHTML = '<div class="no-data">No hay datos de productos vendidos</div>';
                    }
                }
            } catch (error) {
                console.error('Error cargando datos del dashboard:', error);
                // Mostrar valores por defecto en caso de error
                document.getElementById('ventas-dia').textContent = 'Error';
                document.getElementById('pedidos-curso').textContent = 'Error';
                document.getElementById('pedidos-pendientes').textContent = 'Error';
                document.getElementById('metodo-mas-usado').textContent = 'Error';
                document.getElementById('orders-list').innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">Error cargando pedidos</div>';

                // Error en top 5 productos del dashboard
                const dashboardTop5List = document.getElementById('dashboard-top5-list');
                if (dashboardTop5List) {
                    dashboardTop5List.innerHTML = '<div class="error">Error al cargar datos</div>';
                }
            }
        }

        function getEstadoClass(estado) {
            const estadoLower = estado.toLowerCase();
            if (estadoLower === 'entregado' || estadoLower === 'completado' || estadoLower === 'pago') return 'delivered';
            if (estadoLower === 'preparacion' || estadoLower === 'preparando') return 'preparing';
            if (estadoLower === 'preparado' || estadoLower === 'listo') return 'preparing';
            if (estadoLower === 'pendiente' || estadoLower === 'esperando') return 'pending';
            if (estadoLower === 'cancelado' || estadoLower === 'cancelado') return 'cancelled';
            return 'pending';
        }

        // Funci√≥n para ir a la secci√≥n de pedidos
        function irASeccionPedidos() {
            navegarASeccion('pedidos');
        }

        // Funci√≥n para ir a la secci√≥n de estad√≠sticas
        function irASeccionEstadisticas() {
            navegarASeccion('estadisticas');
        }

        // --- Final del listener consolidado ---

    </script>

    <script>
        // === FUNCIONES INDEPENDIENTES QUE NO REQUIEREN DOM ===
    </script>

    <script>
        // El manejo de usuarios ya est√° consolidado en el listener principal

    </script>

    <script>
        // === L√ìGICA DE COMANDAS ===
        const btnActivosComandas = document.getElementById('btn-activos-comandas');
        const btnFinalizadosComandas = document.getElementById('btn-finalizados-comandas');
        const panelActivosComandas = document.getElementById('panel-activos-comandas');
        const panelFinalizadosComandas = document.getElementById('panel-finalizados-comandas');

        if (btnActivosComandas && btnFinalizadosComandas) {
            btnActivosComandas.onclick = function () {
                btnActivosComandas.classList.add('active');
                btnFinalizadosComandas.classList.remove('active');
                panelActivosComandas.style.display = '';
                panelFinalizadosComandas.style.display = 'none';
            };

            btnFinalizadosComandas.onclick = function () {
                btnFinalizadosComandas.classList.add('active');
                btnActivosComandas.classList.remove('active');
                panelActivosComandas.style.display = 'none';
                panelFinalizadosComandas.style.display = '';
            };
        }

        async function cargarPedidosComandas() {
            // Columnas Activos
            const listosCol = document.getElementById('listos-col');
            const preparacionCol = document.getElementById('preparacion-col');
            const pendienteCol = document.getElementById('pendiente-col');
            // Columnas Finalizados
            const completadosCol = document.getElementById('completados-col');
            const canceladosCol = document.getElementById('cancelados-col');

            // Totales
            const listosTotal = document.getElementById('listos-total');
            const preparacionTotal = document.getElementById('preparacion-total');
            const pendienteTotal = document.getElementById('pendiente-total');
            const completadosTotal = document.getElementById('completados-total');
            const canceladosTotal = document.getElementById('cancelados-total');

            if (!listosCol || !preparacionCol || !pendienteCol) return;

            // üîÑ GUARDAR POSICIONES DE SCROLL ANTES DE ACTUALIZAR
            const scrollPositions = {};
            const columnas = [
                { element: listosCol, key: 'listos' },
                { element: preparacionCol, key: 'preparacion' },
                { element: pendienteCol, key: 'pendiente' },
                { element: completadosCol, key: 'completados' },
                { element: canceladosCol, key: 'cancelados' }
            ];

            // Buscar contenedores con scroll (pueden ser los padres de las columnas)
            columnas.forEach(({ element, key }) => {
                if (element) {
                    // Buscar el contenedor con scroll m√°s cercano
                    let scrollContainer = element;
                    while (scrollContainer && scrollContainer !== document.body) {
                        const computedStyle = window.getComputedStyle(scrollContainer);
                        if (computedStyle.overflowY === 'auto' || computedStyle.overflowY === 'scroll' || 
                            scrollContainer.classList.contains('comandas-col-content') ||
                            scrollContainer.scrollHeight > scrollContainer.clientHeight) {
                            break;
                        }
                        scrollContainer = scrollContainer.parentElement;
                    }
                    
                    if (scrollContainer) {
                        scrollPositions[key] = scrollContainer.scrollTop;
                        console.log(`üìç Guardada posici√≥n scroll ${key}:`, scrollPositions[key]);
                    }
                }
            });

            // Limpia columnas
            [listosCol, preparacionCol, pendienteCol, completadosCol, canceladosCol].forEach(col => {
                if (col) col.innerHTML = '<div style="text-align:center;color:#888;padding:1.5rem;">Cargando...</div>';
            });

            try {
                const res = await fetch(BACKEND_API + '/admin/api/api_pedidos.php');
                const data = await res.json();

                // Limpia columnas
                [listosCol, preparacionCol, pendienteCol, completadosCol, canceladosCol].forEach(col => {
                    if (col) col.innerHTML = '';
                });

                // Contadores
                let cListos = 0, cPreparacion = 0, cPendiente = 0, cCompletados = 0, cCancelados = 0;

                if (data.success && Array.isArray(data.pedidos)) {
                    // Ordenar pedidos del m√°s antiguo al m√°s nuevo (por fecha y hora de creaci√≥n)
                    const pedidosOrdenados = data.pedidos.sort((a, b) => {
                        // Convertir fechas a objetos Date para comparar correctamente
                        const fechaA = new Date(a.creado_en);
                        const fechaB = new Date(b.creado_en);
                        return fechaA - fechaB; // M√°s antiguo primero (ascendente)
                    });
                    
                    pedidosOrdenados.forEach(pedido => {
                        let estado = (pedido.estado || '').toLowerCase();
                        let destino = null, totalEl = null, acciones = '';

                        // Botones seg√∫n estado
                        if (estado === 'preparado' || estado === 'listo') {
                            destino = listosCol; totalEl = listosTotal; cListos++;
                            acciones = `<button class='btn-continuar'>Finalizar</button> <button class='btn-cancelar'>Cancelar</button>`;
                        } else if (estado === 'preparacion') {
                            destino = preparacionCol; totalEl = preparacionTotal; cPreparacion++;
                            acciones = `<button class='btn-continuar'>Continuar</button> <button class='btn-cancelar'>Cancelar</button>`;
                        } else if (estado === 'pendiente' || estado === 'esperando' || estado === 'pago pendiente') {
                            destino = pendienteCol; totalEl = pendienteTotal; cPendiente++;
                            acciones = `<button class='btn-continuar'>Continuar</button> <button class='btn-cancelar'>Cancelar</button>`;
                        } else if (estado === 'entregado' || estado === 'completado' || estado === 'pago') {
                            destino = completadosCol; totalEl = completadosTotal; cCompletados++;
                            acciones = '';
                        } else if (estado === 'cancelado') {
                            destino = canceladosCol; totalEl = canceladosTotal; cCancelados++;
                            acciones = '';
                        }

                        if (!destino) return;

                        // Determinar si es una comanda finalizada (no debe tener checkbox)
                        const esComandaFinalizada = estado === 'entregado' || estado === 'completado' || estado === 'pago' || estado === 'cancelado';
                        
                        let pedidoHTML = `
              <div class="comanda-card" data-id-pedido="${pedido.id_pedido}" data-estado="${estado}">
                ${!esComandaFinalizada ? `<input type="checkbox" class="comanda-checkbox" data-id-pedido="${pedido.id_pedido}">` : ''}
                <button class="btn-icon btn-ver-detalle-comanda" data-id-pedido="${pedido.id_pedido}" title="Ver detalles">üëÅÔ∏è</button>
                <div class="num" data-estado="${pedido.estado}">N¬∫ ${pedido.numero_pedido}</div>
                <div class="items" id="items-detalle-${pedido.id_pedido}">${pedido.cantidad_items} items</div>
                <div class="precio">PRECIO: $${parseFloat(pedido.monto_total).toLocaleString()}</div>
                <div class="acciones">${acciones}</div>
              </div>
            `;
                        destino.innerHTML += pedidoHTML;

                        // Si es columna de preparacion, cargar detalle de items
                        if (destino === preparacionCol) {
                            // Guardar posici√≥n antes de cargar detalles
                            const currentScrollPos = scrollPositions['preparacion'] || 0;
                            
                            fetch(`${BACKEND_API}/admin/api/api_pedidos.php?detalle=${pedido.id_pedido}`)
                                .then(r => r.json())
                                .then(det => {
                                    if (det.success && Array.isArray(det.items) && det.items.length > 0) {
                                        // Agrupar items por producto y personalizaciones
                                        const itemsAgrupados = {};
                                        
                                        det.items.forEach(item => {
                                            // Crear clave √∫nica: nombre + personalizaciones ordenadas
                                            const personalizacionesOrdenadas = item.personalizaciones ? 
                                                [...item.personalizaciones].sort().join('|') : '';
                                            const clave = `${item.nombre}||${personalizacionesOrdenadas}`;
                                            
                                            if (itemsAgrupados[clave]) {
                                                itemsAgrupados[clave].cantidad += parseInt(item.cantidad);
                                            } else {
                                                itemsAgrupados[clave] = {
                                                    nombre: item.nombre,
                                                    cantidad: parseInt(item.cantidad),
                                                    personalizaciones: item.personalizaciones || [],
                                                    notas: item.notas
                                                };
                                            }
                                        });
                                        
                                        const itemsList = Object.values(itemsAgrupados).map(item => {
                                            let itemHTML = `<li>${item.cantidad}x ${item.nombre}`;
                                            if (item.notas) {
                                                itemHTML += ` <span style='color:#888;font-size:0.95em'>(${item.notas})</span>`;
                                            }
                                            // Agregar personalizaciones si existen
                                            if (item.personalizaciones && item.personalizaciones.length > 0) {
                                                const personalizacionesHTML = item.personalizaciones.map(pers => 
                                                    `<div style='margin-left:20px;color:#666;font-size:0.9em;'>-${pers}</div>`
                                                ).join('');
                                                itemHTML += personalizacionesHTML;
                                            }
                                            itemHTML += `</li>`;
                                            return itemHTML;
                                        }).join('');
                                        
                                        const itemsEl = document.getElementById(`items-detalle-${pedido.id_pedido}`);
                                        if (itemsEl) {
                                            itemsEl.innerHTML = `<ul style='margin:6px 0 0 0;padding-left:18px;'>${itemsList}</ul>`;
                                            
                                            // Restaurar scroll despu√©s de actualizar detalles (si es necesario)
                                            if (currentScrollPos > 0) {
                                                setTimeout(() => {
                                                    let scrollContainer = preparacionCol;
                                                    while (scrollContainer && scrollContainer !== document.body) {
                                                        const computedStyle = window.getComputedStyle(scrollContainer);
                                                        if (computedStyle.overflowY === 'auto' || computedStyle.overflowY === 'scroll' || 
                                                            scrollContainer.classList.contains('comandas-col-content') ||
                                                            scrollContainer.scrollHeight > scrollContainer.clientHeight) {
                                                            break;
                                                        }
                                                        scrollContainer = scrollContainer.parentElement;
                                                    }
                                                    if (scrollContainer) {
                                                        scrollContainer.scrollTop = currentScrollPos;
                                                    }
                                                }, 50);
                                            }
                                        }
                                    }
                                })
                                .catch(() => { });
                        }
                    });
                }

                // Actualiza totales
                if (listosTotal) listosTotal.textContent = `Total: ${cListos} Pedido${cListos !== 1 ? 's' : ''}`;
                if (preparacionTotal) preparacionTotal.textContent = `Total: ${cPreparacion} Pedido${cPreparacion !== 1 ? 's' : ''}`;
                if (pendienteTotal) pendienteTotal.textContent = `Total: ${cPendiente} Pedido${cPendiente !== 1 ? 's' : ''}`;
                if (completadosTotal) completadosTotal.textContent = `Total: ${cCompletados} Pedido${cCompletados !== 1 ? 's' : ''}`;
                if (canceladosTotal) canceladosTotal.textContent = `Total: ${cCancelados} Pedido${cCancelados !== 1 ? 's' : ''}`;

                // üîÑ RESTAURAR POSICIONES DE SCROLL DESPU√âS DE ACTUALIZAR
                setTimeout(() => {
                    columnas.forEach(({ element, key }) => {
                        if (element && scrollPositions[key] !== undefined) {
                            // Buscar el contenedor con scroll m√°s cercano (mismo algoritmo que antes)
                            let scrollContainer = element;
                            while (scrollContainer && scrollContainer !== document.body) {
                                const computedStyle = window.getComputedStyle(scrollContainer);
                                if (computedStyle.overflowY === 'auto' || computedStyle.overflowY === 'scroll' || 
                                    scrollContainer.classList.contains('comandas-col-content') ||
                                    scrollContainer.scrollHeight > scrollContainer.clientHeight) {
                                    break;
                                }
                                scrollContainer = scrollContainer.parentElement;
                            }
                            
                            if (scrollContainer && scrollPositions[key] > 0) {
                                scrollContainer.scrollTop = scrollPositions[key];
                                console.log(`üéØ Restaurada posici√≥n scroll ${key}:`, scrollPositions[key]);
                            }
                        }
                    });
                }, 100); // Peque√±o delay para que el DOM se actualice completamente

            } catch (e) {
                [listosCol, preparacionCol, pendienteCol, completadosCol, canceladosCol].forEach(col => {
                    if (col) col.innerHTML = '<div style="text-align:center;color:#888;padding:1.5rem;">Error de conexi√≥n</div>';
                });
                console.error('Error de conexi√≥n comandas:', e);
            }
        }

        // === FUNCI√ìN PARA MOSTRAR DETALLE DE COMANDA ===
        async function mostrarDetalleComanda(idPedido) {
            const overlay = document.getElementById('pedido-overlay');
            const overlayBody = document.getElementById('pedido-overlay-body');

            try {
                overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">Cargando detalles...</div>';
                overlay.style.display = 'block';

                // Obtener datos generales del pedido
                const response = await fetch(`${BACKEND_API}/admin/api/api_pedidos.php`);
                const data = await response.json();

                if (data.success && data.pedidos) {
                    idPedido = Number(idPedido);
                    const pedido = data.pedidos.find(p => Number(p.id_pedido) === idPedido);

                    if (!pedido) {
                        overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">No se encontr√≥ la comanda solicitada.</div>';
                        return;
                    }

                    // Obtener los items del pedido con una segunda petici√≥n
                    let items = [];
                    try {
                        const itemsRes = await fetch(`${BACKEND_API}/admin/api/api_pedidos.php?detalle=${idPedido}`);
                        const itemsData = await itemsRes.json();
                        if (itemsData.success && Array.isArray(itemsData.items)) {
                            items = itemsData.items;
                        }
                    } catch (e) {
                        console.error('Error al cargar items:', e);
                    }

                    const fecha = new Date(pedido.creado_en);
                    const fechaFormateada = fecha.toLocaleDateString('es-ES');
                    const horaFormateada = fecha.toLocaleTimeString('es-ES');

                    let detalleHTML = `
            <div class="pedido-detalle">
              <div class="pedido-info">
                <p><strong>N√∫mero de Comanda:</strong> ${pedido.numero_pedido}</p>
                <p><strong>Fecha:</strong> ${fechaFormateada} ${horaFormateada}</p>
                <p><strong>Estado:</strong> ${generarEstadoBadge(pedido.estado)}</p>
                <p><strong>M√©todo de Pago:</strong> ${pedido.metodo_pago || 'N/A'}</p>
                <p><strong>Total:</strong> $${parseFloat(pedido.monto_total).toLocaleString()}</p>
              </div>
              <div class="pedido-items">
                <h4>Items de la Comanda</h4>
                <table class="items-table">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th>Cantidad</th>
                      <th>Precio Unit.</th>
                      <th>Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

                    if (items.length > 0) {
                        // Agrupar items por producto y personalizaciones
                        const itemsAgrupados = {};
                        
                        items.forEach(item => {
                            // Crear clave √∫nica: nombre + personalizaciones ordenadas
                            const personalizacionesOrdenadas = item.personalizaciones ? 
                                [...item.personalizaciones].sort().join('|') : '';
                            const clave = `${item.nombre || item.nombre_producto || '-'}||${personalizacionesOrdenadas}`;
                            
                            if (itemsAgrupados[clave]) {
                                itemsAgrupados[clave].cantidad += parseInt(item.cantidad);
                            } else {
                                itemsAgrupados[clave] = {
                                    nombre: item.nombre || item.nombre_producto || '-',
                                    cantidad: parseInt(item.cantidad),
                                    personalizaciones: item.personalizaciones || [],
                                    notas: item.notas || '',
                                    precio_unitario: item.precio_unitario || 0
                                };
                            }
                        });
                        
                        Object.values(itemsAgrupados).forEach(item => {
                            const subtotal = item.cantidad * parseFloat(item.precio_unitario);
                            detalleHTML += `
                <tr>
                  <td>
                    <strong>${item.nombre}</strong>`;
                            
                            // Agregar personalizaciones si existen
                            if (item.personalizaciones && item.personalizaciones.length > 0) {
                                detalleHTML += `<br><small style="color:#666;margin-left:10px;display:block;margin-top:4px;">`;
                                item.personalizaciones.forEach(pers => {
                                    detalleHTML += `‚Ä¢ ${pers}<br>`;
                                });
                                detalleHTML += `</small>`;
                            }
                            
                            // Agregar notas si existen
                            if (item.notas) {
                                detalleHTML += `<br><small style="color:#f59e0b;margin-left:10px;display:block;margin-top:4px;">üìù ${item.notas}</small>`;
                            }
                            
                            detalleHTML += `
                  </td>
                  <td style="text-align:center;font-weight:600;">${item.cantidad}</td>
                  <td style="text-align:right;">$${parseFloat(item.precio_unitario).toLocaleString()}</td>
                  <td style="text-align:right;font-weight:600;">$${subtotal.toLocaleString()}</td>
                </tr>
              `;
                        });
                    } else {
                        detalleHTML += `
              <tr>
                <td colspan="4" style="text-align: center;color:#888;padding:2rem;">No hay items disponibles para esta comanda</td>
              </tr>
            `;
                    }

                    detalleHTML += `
                  </tbody>
                </table>
              </div>
            </div>
          `;

                    overlayBody.innerHTML = detalleHTML;
                } else {
                    overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">Error: No se pudieron cargar los detalles de la comanda.</div>';
                }
            } catch (error) {
                console.error('Error al cargar detalles de la comanda:', error);
                overlayBody.innerHTML = '<div style="text-align: center; padding: 2rem;">Error de conexi√≥n al cargar los detalles.</div>';
            }
        }

        // Delegar eventos para botones de comandas
        document.addEventListener('click', async function (e) {
            // Bot√≥n para ver detalle de comanda
            if (e.target.classList.contains('btn-ver-detalle-comanda')) {
                const idPedido = e.target.getAttribute('data-id-pedido');
                if (idPedido) {
                    mostrarDetalleComanda(idPedido);
                }
                return;
            }

            if (e.target.classList.contains('btn-cancelar') && e.target.closest('#comandas-section')) {
                const card = e.target.closest('.comanda-card');
                if (!card) return;
                const id_pedido = card.getAttribute('data-id-pedido');
                if (!id_pedido) return alert('No se pudo identificar el pedido');
                if (!confirm('¬øSeguro que deseas cancelar este pedido?')) return;

                e.target.disabled = true;
                e.target.textContent = 'Cancelando...';

                try {
                    const res = await fetch(BACKEND_API + '/admin/api/cancelar_pedido.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_pedido })
                    });
                    const data = await res.json();

                    if (data.success) {
                        cargarPedidosComandas();
                    } else {
                        alert(data.error || 'Error al cancelar');
                        console.error('Error cancelar:', data);
                        e.target.disabled = false;
                        e.target.textContent = 'Cancelar';
                    }
                } catch (err) {
                    alert('Error de conexi√≥n');
                    console.error('Error de conexi√≥n cancelar:', err);
                    e.target.disabled = false;
                    e.target.textContent = 'Cancelar';
                }
            }

            if (e.target.classList.contains('btn-continuar') && e.target.closest('#comandas-section')) {
                const card = e.target.closest('.comanda-card');
                if (!card) return;
                const id_pedido = card.getAttribute('data-id-pedido');
                const estado_actual = (card.querySelector('.num')?.getAttribute('data-estado') || '').toLowerCase();
                if (!id_pedido || !estado_actual) return alert('No se pudo identificar el pedido o su estado');

                e.target.disabled = true;
                e.target.textContent = 'Avanzando...';

                try {
                    const res = await fetch(BACKEND_API + '/admin/api/avanzar_estado_pedido.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id_pedido, estado_actual })
                    });
                    const data = await res.json();

                    if (data.success) {
                        cargarPedidosComandas();
                    } else {
                        alert(data.error || 'Error al avanzar estado');
                        console.error('Error avanzar:', data);
                        e.target.disabled = false;
                        e.target.textContent = 'Continuar';
                    }
                } catch (err) {
                    alert('Error de conexi√≥n');
                    console.error('Error de conexi√≥n avanzar:', err);
                    e.target.disabled = false;
                    e.target.textContent = 'Continuar';
                }
            }
        });

        // === FUNCIONES DE SELECCI√ìN MASIVA DE COMANDAS ===
        
        // Event listener para bot√≥n de continuar masivo
        document.addEventListener('DOMContentLoaded', function() {
            const btnContinuarMasivo = document.getElementById('btn-continuar-masivo');
            const btnCancelarMasivo = document.getElementById('btn-cancelar-masivo');

            if (btnContinuarMasivo) {
                btnContinuarMasivo.addEventListener('click', async function() {
                    const checkboxes = document.querySelectorAll('.comanda-checkbox:checked');
                    
                    if (checkboxes.length === 0) {
                        if (window.notificacionesManager) {
                            window.notificacionesManager.mostrar('Por favor, selecciona al menos una comanda', 'alerta-info');
                        } else {
                            alert('Por favor, selecciona al menos una comanda');
                        }
                        return;
                    }

                    const comandasSeleccionadas = Array.from(checkboxes).map(cb => {
                        const card = cb.closest('.comanda-card');
                        return {
                            id_pedido: cb.getAttribute('data-id-pedido'),
                            estado: card.getAttribute('data-estado')
                        };
                    });

                    if (!confirm(`¬øDeseas avanzar ${comandasSeleccionadas.length} comanda${comandasSeleccionadas.length > 1 ? 's' : ''} seleccionada${comandasSeleccionadas.length > 1 ? 's' : ''}?`)) {
                        return;
                    }

                    btnContinuarMasivo.disabled = true;
                    btnContinuarMasivo.innerHTML = '‚è≥ Procesando...';

                    let exitosos = 0;
                    let fallidos = 0;

                    for (const comanda of comandasSeleccionadas) {
                        try {
                            const res = await fetch(BACKEND_API + '/admin/api/avanzar_estado_pedido.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    id_pedido: comanda.id_pedido, 
                                    estado_actual: comanda.estado 
                                })
                            });
                            const data = await res.json();

                            if (data.success) {
                                exitosos++;
                            } else {
                                fallidos++;
                                console.error('Error al avanzar pedido:', comanda.id_pedido, data.error);
                            }
                        } catch (err) {
                            fallidos++;
                            console.error('Error de conexi√≥n al avanzar pedido:', comanda.id_pedido, err);
                        }
                    }

                    btnContinuarMasivo.disabled = false;
                    btnContinuarMasivo.innerHTML = '‚ñ∂Ô∏è Continuar';

                    // Mostrar resultado
                    if (exitosos > 0) {
                        if (window.notificacionesManager) {
                            window.notificacionesManager.mostrar(
                                `${exitosos} comanda${exitosos > 1 ? 's avanzadas' : ' avanzada'} correctamente${fallidos > 0 ? `. ${fallidos} fallaron.` : ''}`, 
                                'alerta-success'
                            );
                        }
                        // Limpiar selecciones guardadas
                        if (typeof comandasSeleccionadas !== 'undefined') {
                            comandasSeleccionadas.clear();
                        }
                        cargarPedidosComandas();
                    } else {
                        if (window.notificacionesManager) {
                            window.notificacionesManager.mostrar('No se pudo avanzar ninguna comanda', 'alerta-error');
                        }
                    }
                });
            }

            if (btnCancelarMasivo) {
                btnCancelarMasivo.addEventListener('click', async function() {
                    const checkboxes = document.querySelectorAll('.comanda-checkbox:checked');
                    
                    if (checkboxes.length === 0) {
                        if (window.notificacionesManager) {
                            window.notificacionesManager.mostrar('Por favor, selecciona al menos una comanda', 'alerta-info');
                        } else {
                            alert('Por favor, selecciona al menos una comanda');
                        }
                        return;
                    }

                    const comandasSeleccionadas = Array.from(checkboxes).map(cb => cb.getAttribute('data-id-pedido'));

                    if (!confirm(`¬øEst√°s seguro de cancelar ${comandasSeleccionadas.length} comanda${comandasSeleccionadas.length > 1 ? 's' : ''} seleccionada${comandasSeleccionadas.length > 1 ? 's' : ''}?`)) {
                        return;
                    }

                    btnCancelarMasivo.disabled = true;
                    btnCancelarMasivo.innerHTML = '‚è≥ Procesando...';

                    let exitosos = 0;
                    let fallidos = 0;

                    for (const id_pedido of comandasSeleccionadas) {
                        try {
                            const res = await fetch(BACKEND_API + '/admin/api/cancelar_pedido.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ id_pedido })
                            });
                            const data = await res.json();

                            if (data.success) {
                                exitosos++;
                            } else {
                                fallidos++;
                                console.error('Error al cancelar pedido:', id_pedido, data.error);
                            }
                        } catch (err) {
                            fallidos++;
                            console.error('Error de conexi√≥n al cancelar pedido:', id_pedido, err);
                        }
                    }

                    btnCancelarMasivo.disabled = false;
                    btnCancelarMasivo.innerHTML = '‚ùå Cancelar';

                    // Mostrar resultado
                    if (exitosos > 0) {
                        if (window.notificacionesManager) {
                            window.notificacionesManager.mostrar(
                                `${exitosos} comanda${exitosos > 1 ? 's canceladas' : ' cancelada'} correctamente${fallidos > 0 ? `. ${fallidos} fallaron.` : ''}`, 
                                'alerta-success'
                            );
                        }
                        // Limpiar selecciones guardadas
                        if (typeof comandasSeleccionadas !== 'undefined') {
                            comandasSeleccionadas.clear();
                        }
                        cargarPedidosComandas();
                    } else {
                        if (window.notificacionesManager) {
                            window.notificacionesManager.mostrar('No se pudo cancelar ninguna comanda', 'alerta-error');
                        }
                    }
                });
            }
        });

        // === FUNCIONALIDAD DE SELECCIONAR TODOS POR COLUMNA ===
        
        // Variable para guardar las selecciones antes de recargar
        let comandasSeleccionadas = new Set();
        
        // Event listener para checkboxes de "Seleccionar todos"
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('select-all-checkbox')) {
                const columna = e.target.getAttribute('data-columna');
                const isChecked = e.target.checked;
                
                // Seleccionar/deseleccionar todos los checkboxes de esa columna
                const columnContainer = document.getElementById(`${columna}-col`);
                if (columnContainer) {
                    const checkboxes = columnContainer.querySelectorAll('.comanda-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = isChecked;
                        const idPedido = checkbox.getAttribute('data-id-pedido');
                        if (isChecked && idPedido) {
                            comandasSeleccionadas.add(idPedido);
                        } else if (idPedido) {
                            comandasSeleccionadas.delete(idPedido);
                        }
                    });
                }
            }
            
            // Sincronizaci√≥n: actualizar checkbox de "seleccionar todos" cuando se marca/desmarca una comanda individual
            if (e.target.classList.contains('comanda-checkbox') && !e.target.classList.contains('select-all-checkbox')) {
                const idPedido = e.target.getAttribute('data-id-pedido');
                if (e.target.checked && idPedido) {
                    comandasSeleccionadas.add(idPedido);
                } else if (idPedido) {
                    comandasSeleccionadas.delete(idPedido);
                }
                actualizarEstadoSelectAll();
            }
        });
        
        // Funci√≥n para actualizar el estado de los checkboxes "Seleccionar todos"
        function actualizarEstadoSelectAll() {
            const columnas = ['listos', 'preparacion', 'pendiente'];
            
            columnas.forEach(columna => {
                const columnContainer = document.getElementById(`${columna}-col`);
                const selectAllCheckbox = document.querySelector(`.select-all-checkbox[data-columna="${columna}"]`);
                
                if (columnContainer && selectAllCheckbox) {
                    const checkboxes = columnContainer.querySelectorAll('.comanda-checkbox');
                    const checkedCheckboxes = columnContainer.querySelectorAll('.comanda-checkbox:checked');
                    
                    // Si todos est√°n marcados, marcar "seleccionar todos"
                    // Si ninguno est√° marcado o algunos est√°n marcados, desmarcar "seleccionar todos"
                    if (checkboxes.length > 0) {
                        selectAllCheckbox.checked = checkboxes.length === checkedCheckboxes.length;
                    } else {
                        selectAllCheckbox.checked = false;
                    }
                }
            });
        }
        
        // Funci√≥n para restaurar las selecciones despu√©s de recargar
        function restaurarSelecciones() {
            setTimeout(() => {
                // Restaurar checkboxes de comandas individuales
                comandasSeleccionadas.forEach(idPedido => {
                    const checkbox = document.querySelector(`.comanda-checkbox[data-id-pedido="${idPedido}"]`);
                    if (checkbox && !checkbox.classList.contains('select-all-checkbox')) {
                        checkbox.checked = true;
                    }
                });
                
                // Actualizar estado de checkboxes "seleccionar todos"
                actualizarEstadoSelectAll();
            }, 100);
        }
        
        // Modificar la funci√≥n cargarPedidosComandas para que restaure las selecciones despu√©s de cargar
        const cargarPedidosComandasOriginal = cargarPedidosComandas;
        cargarPedidosComandas = async function() {
            await cargarPedidosComandasOriginal();
            // Restaurar las selecciones despu√©s de recargar
            restaurarSelecciones();
        };

        // Los event listeners de comandas ahora est√°n en el listener principal consolidado
    </script>

    <div class="alertas-container" id="alertas-container"></div>
    <script src="../assets/js/dashboard/notificaciones.js"></script>

    <script src="../assets/js/dashboard/precio_masivo.js"></script>
    <script src="../assets/js/dashboard/categorias.js"></script>
    <script src="../assets/js/dashboard/proveedores.js"></script>
    <script src="../../backend/admin/js/config_mp.js"></script>

    <!-- Script para dashboard independiente -->
    <script>
        // === CARGA AUTOM√ÅTICA DEL DASHBOARD ===

        // Funci√≥n para verificar si estamos en la secci√≥n dashboard
        function estaEnDashboard() {
            const activeMenuItem = document.querySelector('#sidebar-menu li.active');
            const activeSection = activeMenuItem ? activeMenuItem.getAttribute('data-section') : null;
            const dashboardSection = document.getElementById('dashboard-section');
            const dashboardVisible = dashboardSection && dashboardSection.style.display !== 'none';

            return activeSection === 'dashboard' && dashboardVisible;
        }

        // Funci√≥n para cargar dashboard si es necesario
        function cargarDashboardSiEsNecesario() {
            if (estaEnDashboard()) {
                if (typeof cargarDashboardData === 'function' && !dashboardCargado) {
                    cargarDashboardData();
                    dashboardCargado = true;
                }
            }
        }

        // La carga del dashboard ya est√° manejada en el listener principal consolidado
        
        // === OBSERVER PARA MONITOREAR CAMBIOS EN LA TABLA DE PEDIDOS ===
        document.addEventListener('DOMContentLoaded', function() {
            const tablaPedidos = document.querySelector('#pedidos-tbody');
            if (tablaPedidos) {
                // Crear un observer para detectar cambios en el contenido de la tabla
                const observer = new MutationObserver(function(mutations) {
                    let needsCleaning = false;
                    
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'childList' || mutation.type === 'subtree') {
                            // Verificar si hay nuevos spans con estilos problem√°ticos
                            const newSpans = tablaPedidos.querySelectorAll('span[style*="gap"]');
                            if (newSpans.length > 0) {
                                needsCleaning = true;
                            }
                        }
                    });
                    
                    if (needsCleaning) {
                        console.log('üîç Detectados cambios en tabla de pedidos, limpiando estilos...');
                        setTimeout(() => {
                            limpiarEstilosEstados();
                        }, 10);
                    }
                });
                
                // Configurar el observer
                observer.observe(tablaPedidos, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
                
                console.log('üëÄ Observer de estilos de pedidos activado');
            }
        });
    </script>
    
    <style>
        /* Estilos para paginaci√≥n de rentabilidad */
        #prev-page-rentabilidad:disabled,
        #next-page-rentabilidad:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            color: #9ca3af !important;
        }
        
        #prev-page-rentabilidad:hover:not(:disabled),
        #next-page-rentabilidad:hover:not(:disabled) {
            background-color: #f3f4f6;
            border-color: #9ca3af;
        }
        
        #prev-page-rentabilidad:active:not(:disabled),
        #next-page-rentabilidad:active:not(:disabled) {
            background-color: #e5e7eb;
        }

        /* === MEJORAS PARA OVERLAY DE PEDIDOS === */
        .pedido-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background-color: rgba(0, 0, 0, 0.6) !important;
            z-index: 10000 !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 20px !important;
            box-sizing: border-box !important;
            display: none !important; /* Oculto por defecto */
        }

        /* Solo mostrar como flex cuando est√© activo */
        .pedido-overlay[style*="display: block"] {
            display: flex !important;
        }

        /* Asegurar que est√© oculto por defecto */
        .pedido-overlay[style*="display: none"] {
            display: none !important;
        }

        .pedido-overlay-content {
            background-color: white !important;
            border-radius: 12px !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25) !important;
            width: 100% !important;
            max-width: 700px !important;
            max-height: 85vh !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            position: relative !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .pedido-overlay-header {
            background: #f8f9fa !important;
            padding: 20px 24px !important;
            border-bottom: 1px solid #e9ecef !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            flex-shrink: 0 !important;
            margin: 0 !important;
            border-radius: 12px 12px 0 0 !important;
        }

        .pedido-overlay-header h3 {
            margin: 0 !important;
            font-size: 1.25rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
        }

        .pedido-overlay-close {
            background: none !important;
            border: none !important;
            font-size: 28px !important;
            cursor: pointer !important;
            color: #6b7280 !important;
            padding: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border-radius: 6px !important;
            transition: all 0.2s ease !important;
            width: 40px !important;
            height: 40px !important;
        }

        .pedido-overlay-close:hover {
            background-color: #f3f4f6 !important;
            color: #ef4444 !important;
        }

        .pedido-overlay-body {
            flex: 1 !important;
            overflow-y: auto !important;
            padding: 24px !important;
            background: white !important;
        }

        .pedido-detalle {
            padding: 0 !important;
        }

        .pedido-info {
            background: #f8f9fa !important;
            padding: 20px !important;
            border-radius: 8px !important;
            margin-bottom: 24px !important;
        }

        .pedido-info p {
            margin: 8px 0 !important;
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
        }

        .pedido-info strong {
            color: #374151 !important;
            font-weight: 600 !important;
            min-width: 140px !important;
        }

        .pedido-items h4 {
            margin: 0 0 16px 0 !important;
            font-size: 1.1rem !important;
            font-weight: 600 !important;
            color: #374151 !important;
        }

        .items-table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-top: 16px !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
        }

        .items-table thead th {
            background: #f3f4f6 !important;
            padding: 14px 12px !important;
            text-align: left !important;
            font-weight: 600 !important;
            color: #374151 !important;
            border-bottom: 2px solid #e5e7eb !important;
        }

        .items-table tbody td {
            padding: 14px 12px !important;
            border-bottom: 1px solid #f3f4f6 !important;
            vertical-align: top !important;
        }

        .items-table tbody tr:last-child td {
            border-bottom: none !important;
        }

        .items-table tbody tr:hover {
            background-color: #f9fafb !important;
        }

        /* Estilos responsivos para m√≥viles */
        @media (max-width: 768px) {
            .pedido-overlay {
                padding: 10px !important;
            }

            .pedido-overlay-content {
                max-width: 100% !important;
                max-height: 95vh !important;
            }

            .pedido-overlay-header {
                padding: 16px 20px !important;
            }

            .pedido-overlay-header h3 {
                font-size: 1.1rem !important;
            }

            .pedido-overlay-body {
                padding: 20px !important;
            }

            .pedido-info p {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 4px !important;
            }

            .pedido-info strong {
                min-width: unset !important;
            }

            .items-table {
                font-size: 14px !important;
            }

            .items-table thead th,
            .items-table tbody td {
                padding: 10px 8px !important;
            }
        }

        /* Estados de pedido mejorados */
        .estado-pendiente { color: #f59e0b !important; background: #fef3c7 !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-preparacion { color: #3b82f6 !important; background: #dbeafe !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-preparado { color: #10b981 !important; background: #d1fae5 !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-listo { color: #10b981 !important; background: #d1fae5 !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-entregado { color: #059669 !important; background: #ecfdf5 !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-completado { color: #059669 !important; background: #ecfdf5 !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-pago { color: #059669 !important; background: #ecfdf5 !important; padding: 4px 8px !important; border-radius: 4px !important; }
        .estado-cancelado { color: #ef4444 !important; background: #fee2e2 !important; padding: 4px 8px !important; border-radius: 4px !important; }

        /* === ESTILOS PARA BOT√ìN VER DETALLE EN COMANDAS === */
        .btn-ver-detalle-comanda {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn-ver-detalle-comanda:hover {
            background: #3b82f6;
            border-color: #3b82f6;
            transform: scale(1.1);
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.3);
        }

        .btn-ver-detalle-comanda:active {
            transform: scale(0.95);
        }

        /* Ajustar posici√≥n del checkbox para que no se superponga con el bot√≥n de ojo */
        .comanda-card .comanda-checkbox {
            position: absolute;
            top: 8px;
            left: 8px;
            z-index: 10;
        }

        /* Ajustar el n√∫mero de pedido para que no quede tapado por el checkbox */
        .comanda-card .num {
            margin-left: 30px; /* Espacio para el checkbox */
        }

        /* Asegurar que la comanda-card tenga position relative */
        .comanda-card {
            position: relative;
        }

        /* === MODO OSCURO PARA MODAL DE PEDIDOS/COMANDAS === */
        [data-theme="dark"] .pedido-overlay {
            background-color: rgba(0, 0, 0, 0.85) !important;
        }

        [data-theme="dark"] .pedido-overlay-content {
            background-color: #1f2937 !important;
        }

        [data-theme="dark"] .pedido-overlay-header {
            background: #374151 !important;
            border-bottom: 1px solid #4b5563 !important;
        }

        [data-theme="dark"] .pedido-overlay-header h3 {
            color: #f3f4f6 !important;
        }

        [data-theme="dark"] .pedido-overlay-close {
            color: #9ca3af !important;
        }

        [data-theme="dark"] .pedido-overlay-close:hover {
            background-color: #4b5563 !important;
            color: #ef4444 !important;
        }

        [data-theme="dark"] .pedido-overlay-body {
            background: #1f2937 !important;
        }

        [data-theme="dark"] .pedido-info {
            background: #374151 !important;
        }

        [data-theme="dark"] .pedido-info p {
            color: #e5e7eb !important;
        }

        [data-theme="dark"] .pedido-info strong {
            color: #f3f4f6 !important;
        }

        [data-theme="dark"] .pedido-items h4 {
            color: #f3f4f6 !important;
        }

        [data-theme="dark"] .items-table {
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
        }

        [data-theme="dark"] .items-table thead th {
            background: #374151 !important;
            color: #f3f4f6 !important;
            border-bottom: 2px solid #4b5563 !important;
        }

        [data-theme="dark"] .items-table tbody td {
            border-bottom: 1px solid #374151 !important;
            color: #e5e7eb !important;
        }

        [data-theme="dark"] .items-table tbody tr:hover {
            background-color: #374151 !important;
        }

        /* Estados en modo oscuro */
        [data-theme="dark"] .estado-pendiente {
            background: rgba(251, 191, 36, 0.2) !important;
            color: #fbbf24 !important;
        }

        [data-theme="dark"] .estado-preparacion {
            background: rgba(59, 130, 246, 0.2) !important;
            color: #60a5fa !important;
        }

        [data-theme="dark"] .estado-preparado,
        [data-theme="dark"] .estado-listo {
            background: rgba(16, 185, 129, 0.2) !important;
            color: #34d399 !important;
        }

        [data-theme="dark"] .estado-entregado,
        [data-theme="dark"] .estado-completado,
        [data-theme="dark"] .estado-pago {
            background: rgba(5, 150, 105, 0.2) !important;
            color: #10b981 !important;
        }

        [data-theme="dark"] .estado-cancelado {
            background: rgba(239, 68, 68, 0.2) !important;
            color: #f87171 !important;
        }

        /* === ESTILOS PARA GRUPOS DE MONTO M√çNIMO === */
        .monto-minimo-group {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            background: #fafafa;
        }

        .monto-minimo-group:nth-of-type(1) {
            border-left: 4px solid #667eea; /* Azul para Totem */
        }

        .monto-minimo-group:nth-of-type(2) {
            border-left: 4px solid #10b981; /* Verde para M√≥vil */
        }

        [data-theme="dark"] .monto-minimo-group {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .monto-minimo-label {
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .monto-minimo-input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .monto-minimo-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .monto-minimo-btn {
            padding: 8px 16px !important;
            font-size: 14px !important;
            white-space: nowrap;
        }

        .monto-minimo-msg {
            margin-top: 8px;
            padding: 6px 12px;
            background: #d4edda;
            color: #155724;
            border-radius: 4px;
            font-size: 13px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        [data-theme="dark"] .monto-minimo-input {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: #fff;
        }

        [data-theme="dark"] .monto-minimo-msg {
            background: rgba(20, 83, 45, 0.3);
            color: #10b981;
        }

        /* === ESTILOS PARA UPLOAD DE ICONOS SVG === */
        .icono-upload-container {
            margin-top: 8px;
        }

        .icono-preview-container {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .icono-preview {
            width: 80px;
            height: 80px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            flex-shrink: 0;
        }

        .icono-preview img {
            max-width: 60px;
            max-height: 60px;
            object-fit: contain;
        }

        .icono-upload-actions {
            flex: 1;
        }

        .btn-upload-icono {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn-upload-icono:hover {
            background: #2563eb;
        }

        [data-theme="dark"] .icono-preview {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .btn-upload-icono {
            background: #2563eb;
        }

        [data-theme="dark"] .btn-upload-icono:hover {
            background: #1d4ed8;
        }

        /* === ESTILOS ESPEC√çFICOS PARA SECCI√ìN DE RENTABILIDAD === */
        /* Contenedores padre */
        .estadisticas-rentabilidad-row {
            margin: 24px 0 !important;
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
        }

        .rentabilidad-section {
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        .rentabilidad-content {
            background: transparent !important;
            border: none !important;
            border-radius: 0 !important;
            box-shadow: none !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* El contenedor principal que S√ç debe tener border-radius */
        .rentabilidad-section .productos-lista {
            border-radius: 16px !important;
            overflow: hidden !important;
            background: #fff !important;
            border: 1px solid #e5e7eb !important;
            box-shadow: 0 2px 8px 0 rgba(0, 0, 0, 0.03) !important;
            margin: 0 !important;
            padding: 0 !important;
        }

        /* Forzar que todos los elementos internos respeten el border-radius */
        .rentabilidad-section .productos-lista * {
            border-radius: inherit;
        }

        /* Header de rentabilidad */
        .rentabilidad-section .rentabilidad-header {
            border-radius: 16px 16px 0 0 !important;
            margin: 0 !important;
            padding: 16px !important;
            background: #f8f9fa !important;
            border-bottom: 1px solid #e9ecef !important;
        }

        /* Controles de rentabilidad */
        .rentabilidad-section .rentabilidad-controls {
            margin: 0 !important;
            padding: 16px !important;
            border-bottom: 1px solid #e9ecef !important;
            border-radius: 0 !important;
        }

        /* Wrapper de la tabla */
        .rentabilidad-section .rentabilidad-table-wrapper {
            border-radius: 0 !important;
            margin: 0 !important;
        }

        /* Tabla de rentabilidad */
        .rentabilidad-section .productos-lista table {
            border-radius: 0 !important;
            margin: 0 !important;
            border: none !important;
        }

        /* Header de tabla */
        .rentabilidad-section .productos-lista table thead tr {
            background: #f3f4f6 !important;
            border-radius: 0 !important;
        }

        /* Paginaci√≥n con bordes redondeados en la parte inferior */
        .rentabilidad-section #rentabilidad-pagination {
            border-radius: 0 0 16px 16px !important;
            margin: 0 !important;
            border-top: 1px solid #e9ecef !important;
        }

        /* Modo oscuro para rentabilidad */
        [data-theme="dark"] .estadisticas-rentabilidad-row,
        [data-theme="dark"] .rentabilidad-section,
        [data-theme="dark"] .rentabilidad-content {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        [data-theme="dark"] .rentabilidad-section .productos-lista {
            background: #1f2937 !important;
            border-color: #374151 !important;
        }

        [data-theme="dark"] .rentabilidad-section .rentabilidad-header {
            background: #374151 !important;
            border-bottom-color: #4b5563 !important;
        }

        [data-theme="dark"] .rentabilidad-section .rentabilidad-controls {
            border-bottom-color: #4b5563 !important;
            border-radius: 0 !important;
        }

        [data-theme="dark"] .rentabilidad-section .productos-lista table thead tr {
            background: #2d3748 !important;
        }

        [data-theme="dark"] .rentabilidad-section #rentabilidad-pagination {
            border-top-color: #4b5563 !important;
        }

        /* === ESTILOS ESPEC√çFICOS PARA ESTADOS DE PEDIDOS - FORZAR CONSISTENCIA === */
        /* Sobrescribir CUALQUIER estilo inline o generado din√°micamente */
        
        .pedidos-table td span[style*="gap"],
        .pedidos-table .estado-pendiente, 
        .pedidos-table .estado-esperando,
        .estado-pendiente, 
        .estado-esperando,
        span[style*="background:#fff3cd"],
        span[style*="background: #fff3cd"] {
            background: #fef3c7 !important;
            color: #f59e0b !important;
            padding: 4px 12px !important;
            border-radius: 16px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            text-transform: capitalize !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0 !important; /* FORZAR sin gap */
        }

        .pedidos-table td span[style*="gap"],
        .pedidos-table .estado-preparacion, 
        .pedidos-table .estado-preparando,
        .estado-preparacion, 
        .estado-preparando,
        span[style*="background:#d1ecf1"],
        span[style*="background: #d1ecf1"] {
            background: #d1ecf1 !important;
            color: #0c5460 !important;
            padding: 4px 12px !important;
            border-radius: 16px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            text-transform: capitalize !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0 !important; /* FORZAR sin gap */
        }

        .pedidos-table td span[style*="gap"],
        .pedidos-table .estado-preparado, 
        .pedidos-table .estado-listo,
        .estado-preparado, 
        .estado-listo,
        span[style*="background:#d4edda"],
        span[style*="background: #d4edda"] {
            background: #d1fae5 !important;
            color: #10b981 !important;
            padding: 4px 12px !important;
            border-radius: 16px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            text-transform: capitalize !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0 !important; /* FORZAR sin gap */
        }

        .pedidos-table td span[style*="gap"],
        .pedidos-table .estado-entregado, 
        .pedidos-table .estado-completado, 
        .pedidos-table .estado-pago,
        .estado-entregado, 
        .estado-completado, 
        .estado-pago,
        span[style*="background:#e6f9ed"],
        span[style*="background: #e6f9ed"] {
            background: #ecfdf5 !important;
            color: #059669 !important;
            padding: 4px 12px !important;
            border-radius: 16px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            text-transform: capitalize !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0 !important; /* FORZAR sin gap */
        }

        .pedidos-table td span[style*="gap"],
        .pedidos-table .estado-cancelado,
        .estado-cancelado,
        span[style*="background:#f8d7da"],
        span[style*="background: #f8d7da"] {
            background: #fee2e2 !important;
            color: #ef4444 !important;
            padding: 4px 12px !important;
            border-radius: 16px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            text-transform: capitalize !important;
            display: inline-flex !important;
            align-items: center !important;
            gap: 0 !important; /* FORZAR sin gap */
        }

        /* Bot√≥n de ojo mejorado */
        .btn-abrir-overlay {
            background: #f3f4f6 !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 6px !important;
            padding: 6px !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            color: #374151 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .btn-abrir-overlay:hover {
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
            color: white !important;
            transform: scale(1.05) !important;
        }

        .btn-abrir-overlay svg {
            width: 16px !important;
            height: 16px !important;
        }

        /* Modo oscuro para estados de pedidos */
        [data-theme="dark"] .estado-pendiente,
        [data-theme="dark"] .estado-esperando {
            background: rgba(251, 191, 36, 0.2) !important;
            color: #fbbf24 !important;
        }

        [data-theme="dark"] .estado-preparacion,
        [data-theme="dark"] .estado-preparando {
            background: rgba(59, 130, 246, 0.2) !important;
            color: #60a5fa !important;
        }

        [data-theme="dark"] .estado-preparado,
        [data-theme="dark"] .estado-listo {
            background: rgba(16, 185, 129, 0.2) !important;
            color: #34d399 !important;
        }

        [data-theme="dark"] .estado-entregado,
        [data-theme="dark"] .estado-completado,
        [data-theme="dark"] .estado-pago {
            background: rgba(5, 150, 105, 0.2) !important;
            color: #10b981 !important;
        }

        [data-theme="dark"] .estado-cancelado {
            background: rgba(239, 68, 68, 0.2) !important;
            color: #f87171 !important;
        }

        [data-theme="dark"] .btn-abrir-overlay {
            background: #374151 !important;
            border-color: #4b5563 !important;
            color: #e5e7eb !important;
        }

        [data-theme="dark"] .btn-abrir-overlay:hover {
            background: #3b82f6 !important;
            border-color: #3b82f6 !important;
            color: white !important;
        }

        /* === REGLA UNIVERSAL PARA ELIMINAR GAP EN ESTADOS === */
        /* Forzar la eliminaci√≥n de gap en cualquier span dentro de la tabla de pedidos */
        .pedidos-table td span,
        .pedidos-table span[style*="gap:6px"],
        .pedidos-table span[style*="gap: 6px"],
        .pedidos-table span[style*="display:inline-flex"],
        .pedidos-table span[style*="display: inline-flex"] {
            gap: 0 !important;
            font-size: 15px !important;
        }

        /* Ocultar cualquier SVG dentro de estados en la tabla de pedidos para evitar inconsistencias */
        .pedidos-table td span svg,
        .pedidos-table .estado-pendiente svg,
        .pedidos-table .estado-preparacion svg,
        .pedidos-table .estado-preparado svg,
        .pedidos-table .estado-entregado svg,
        .pedidos-table .estado-completado svg,
        .pedidos-table .estado-cancelado svg {
            display: none !important;
        }
    </style>
</body>

</html>
