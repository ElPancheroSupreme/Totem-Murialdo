<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ticket de Pago - Mercado Pago</title>
    <link rel="icon" href="../assets/images/Iconos/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="../assets/images/Iconos/site.webmanifest">
    <link rel="apple-touch-icon" sizes="180x180" href="../assets/images/Iconos/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../assets/images/Iconos/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../assets/images/Iconos/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../assets/images/Iconos/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="../assets/images/Iconos/android-chrome-512x512.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/style/ticket.css">
    <script src="../test/qz-tray.js"></script>
    <script src="../test/qz-config-final.js"></script>
    <!-- Librer√≠a para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
    <div class="ticket-vertical-main">
        <div class="ticket-vertical-content">
            <div class="ticket-container">
                <div class="ticket-header">
                    <div class="ticket-title">¬°Pago Exitoso!</div>
                    <div class="ticket-numero-orden" id="numero-orden">K0000</div>
                    <div class="ticket-subtitle">Retir√° tu pedido con este n√∫mero</div>
                </div>
                <div class="ticket-body">
                    <div class="ticket-info">
                        <div class="info-row">
                            <span class="info-label">Fecha:</span>
                            <span class="info-value" id="fecha">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hora:</span>
                            <span class="info-value" id="hora">-</span>
                        </div>
                        <div class="info-row" style="display: none;">
                            <span class="info-value" id="referencia">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">M√©todo de pago:</span>
                            <span class="info-value">QR Mercado Pago</span>
                        </div>
                    </div>
                    <div class="order-items" id="order-items"></div>
                    <div class="info-row total-row">
                        <span class="info-label">Total pagado:</span>
                        <span class="info-value" id="total-pagado">$0</span>
                    </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="Footer_Contenedor_Botones">
                <button id="Boton_Imprimir_Ticket">Imprimir Ticket</button>
                <button id="Boton_Descargar_PDF" style="display: none;">üìÑ Descargar Comprobante</button>
                <button id="Boton_Continuar">Continuar</button>
            </div>
        </footer>
    </div>
    <script>
        function formatearFecha(fecha) {
            const opciones = { year: 'numeric', month: 'long', day: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }
        function formatearHora(fecha) {
            const opciones = { hour: '2-digit', minute: '2-digit' };
            return fecha.toLocaleTimeString('es-ES', opciones);
        }

        async function cargarTicket() {
            console.log('=== DEBUG CARGAR TICKET ===');
            
            const ahora = new Date();
            
            // Obtener external_reference de la URL si existe
            const urlParams = new URLSearchParams(window.location.search);
            const refFromUrl = urlParams.get('ref');
            const sourceFromUrl = urlParams.get('source');
            
            console.log('üîç Par√°metros URL - ref:', refFromUrl, 'source:', sourceFromUrl);
            
            // Si hay external_reference en URL, guardarlo para uso posterior
            if (refFromUrl) {
                localStorage.setItem('external_reference', refFromUrl);
                console.log('üìÑ External reference guardado desde URL:', refFromUrl);
            }
            
            // Obtener datos del localStorage con debugging
            let items = JSON.parse(localStorage.getItem('ticket_items') || '[]');
            let totalString = localStorage.getItem('ticket_total') || '0';
            let numeroOrden = localStorage.getItem('numero_orden'); // NO generar autom√°ticamente
            let metodoPago = localStorage.getItem('metodo_pago') || 'QR Mercado Pago';
            
            // Verificar si tenemos un n√∫mero v√°lido (de la base de datos)
            if (!numeroOrden) {
                console.error('‚ùå CR√çTICO: No se encontr√≥ numero_orden en localStorage');
                console.log('üîç Verificando todos los valores en localStorage:');
                for (let key in localStorage) {
                    if (key.includes('numero') || key.includes('orden') || key.includes('pedido')) {
                        console.log(`  - ${key}: ${localStorage.getItem(key)}`);
                    }
                }
                
                // Si tenemos external_reference pero no numero_orden, es redirecci√≥n directa de MercadoPago
                if (refFromUrl && sourceFromUrl === 'checkoutpro') {
                    console.warn('üîÑ REDIRECCI√ìN DIRECTA DE MERCADOPAGO DETECTADA');
                    console.warn('üîÑ Obteniendo datos del pedido usando external_reference...');
                    
                    try {
                        const response = await fetch('/Totem_Murialdo/backend/api/get_datos_completos_pedido.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ external_reference: refFromUrl })
                        });
                        
                        const result = await response.json();
                        if (result.success && result.numero_pedido) {
                            // Obtener TODOS los datos del pedido, no solo el n√∫mero
                            numeroOrden = result.numero_pedido;
                            items = result.ticket_items || [];
                            totalString = result.ticket_total || '0';
                            metodoPago = result.metodo_pago || 'CheckoutPro Mercado Pago';
                            
                            console.log('‚úÖ Datos completos obtenidos desde redirecci√≥n:');
                            console.log('  - N√∫mero:', numeroOrden);
                            console.log('  - Items:', items.length, 'productos');
                            console.log('  - Total:', totalString);
                            console.log('  - M√©todo:', metodoPago);
                            
                            // Guardar en localStorage para futuras cargas
                            localStorage.setItem('numero_orden', numeroOrden);
                            localStorage.setItem('ticket_items', JSON.stringify(items));
                            localStorage.setItem('ticket_total', totalString);
                            localStorage.setItem('metodo_pago', metodoPago);
                        } else {
                            console.warn('‚ö†Ô∏è No se pudo obtener datos completos desde external_reference');
                            
                        }
                    } catch (error) {
                        console.error('‚ùå Error obteniendo datos desde external_reference:', error);
                        
                    }
                } else {
                    console.warn('‚ö†Ô∏è Usando n√∫mero generado como √∫ltimo recurso');
                    
                }
            } else if (numeroOrden && (
                (numeroOrden.toString().startsWith('QR-') && /[a-f]/.test(numeroOrden)) ||
                numeroOrden.toString().startsWith('CP-') ||
                numeroOrden.toString().startsWith('TEMP-')
            )) {
                // Si recibimos n√∫meros temporales (QR-6ec6c1, QR-d51a7d, CP-123456, TEMP-123456)
                // NO son n√∫meros reales de la base de datos, hay que buscar el real
                console.warn('‚ö†Ô∏è DETECTADO: N√∫mero temporal con caracteres (' + numeroOrden + '), obteniendo n√∫mero real...');
                
                const externalRef = localStorage.getItem('external_reference');
                
                // Para QR virtual, external_reference puede no existir, usar m√©todo alternativo
                if (externalRef) {
                    console.log('üîç Buscando n√∫mero real con external_reference:', externalRef);
                    
                    try {
                        const response = await fetch('/Totem_Murialdo/backend/api/get_datos_completos_pedido.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ external_reference: externalRef })
                        });
                        
                        const result = await response.json();
                        if (result.success && result.numero_pedido) {
                            numeroOrden = result.numero_pedido;
                            console.log('‚úÖ N√∫mero real obtenido con external_ref:', numeroOrden, '(m√©todo:', result.source, ')');
                            localStorage.setItem('numero_orden', numeroOrden);
                        } else {
                            console.warn('‚ö†Ô∏è No se pudo obtener n√∫mero real con external_ref, usando √∫ltimo pedido');
                            await buscarUltimoPedido();
                        }
                    } catch (error) {
                        console.error('‚ùå Error obteniendo n√∫mero real con external_ref:', error);
                        await buscarUltimoPedido();
                    }
                } else {
                    console.warn('‚ö†Ô∏è No hay external_reference, buscando √∫ltimo pedido virtual...');
                    await buscarUltimoPedido();
                }
                
                // Funci√≥n auxiliar para buscar √∫ltimo pedido
                async function buscarUltimoPedido() {
                    try {
                        const response = await fetch('/Totem_Murialdo/backend/api/get_numero_pedido.php', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ external_reference: 'ULTIMO_PEDIDO' }) // Se√±al especial
                        });
                        
                        const result = await response.json();
                        console.log('üîç Respuesta API √∫ltimo pedido:', result);
                        
                        if (result.success && result.numero_pedido) {
                            numeroOrden = result.numero_pedido;
                            console.log('‚úÖ √öltimo pedido obtenido:', numeroOrden, '(m√©todo:', result.metodo, ')');
                            localStorage.setItem('numero_orden', numeroOrden);
                        } else {
                            console.error('‚ö†Ô∏è No se pudo obtener √∫ltimo pedido desde API');
                            console.error('‚ö†Ô∏è Respuesta completa:', result);
                            
                            // NO GENERAR N√öMEROS TEMPORALES - mantener el original
                            console.error('‚ùå MANTENIENDO N√öMERO ORIGINAL - revisar conectividad de base de datos');
                            // numeroOrden se mantiene con el valor que ten√≠a
                        }
                    } catch (error) {
                        console.error('‚ùå Error obteniendo √∫ltimo pedido:', error);
                        console.error('‚ùå MANTENIENDO N√öMERO ORIGINAL - verificar conectividad');
                        // numeroOrden se mantiene con el valor que ten√≠a
                    }
                }
            }
            
            console.log('üìã Datos cargados del localStorage:');
            console.log('- ticket_items:', items);
            console.log('- ticket_total (string):', totalString);
            console.log('- numero_orden:', numeroOrden);
            console.log('- metodo_pago:', metodoPago);
            
            // NORMALIZAR M√âTODO DE PAGO - Convertir a formatos amigables
            if (metodoPago === 'QR_VIRTUAL') {
                metodoPago = 'QR Mercado Pago';
                console.log('üîÑ M√©todo de pago normalizado de QR_VIRTUAL a QR Mercado Pago');
            } else if (metodoPago === 'VIRTUAL') {
                // Distinguir entre QR virtual y CheckoutPro
                if (sourceFromUrl === 'checkoutpro' || refFromUrl?.startsWith('CP_')) {
                    metodoPago = 'CheckoutPro Mercado Pago';
                } else {
                    metodoPago = 'QR Mercado Pago';
                }
                console.log('üîÑ M√©todo de pago normalizado de VIRTUAL a:', metodoPago);
            }
            
            // VALIDAR Y NORMALIZAR N√öMERO DE ORDEN - Preservar formato correcto del backend
            console.log('üîç N√∫mero original del backend:', numeroOrden);
            
            // Si ya tiene formato correcto K-XXX, no modificar
            if (numeroOrden && numeroOrden.toString().match(/^K-\d{3}$/)) {
                console.log('‚úÖ N√∫mero ya tiene formato correcto, no se modifica:', numeroOrden);
            } else if (numeroOrden && numeroOrden.toString().startsWith('QR-')) {
                // Extraer solo los n√∫meros de QR-d51a7d -> 51a7d -> 517
                const despuesQR = numeroOrden.replace('QR-', '');
                const soloNumeros = despuesQR.replace(/\D/g, ''); // Extraer solo d√≠gitos
                const numLimpio = parseInt(soloNumeros) || 1; // Si no hay n√∫meros, usar 1
                numeroOrden = 'K-' + numLimpio.toString().padStart(3, '0');
                console.log('üîÑ N√∫mero QR- convertido:', `QR-${despuesQR} -> n√∫meros: ${soloNumeros} -> resultado: ${numeroOrden}`);
            } else if (numeroOrden && numeroOrden.toString().startsWith('K') && !numeroOrden.includes('-')) {
                // Si viene como K133 (formato legacy), convertir a K-133
                const soloNumero = numeroOrden.replace(/^K/, '').replace(/\D/g, '');
                if (soloNumero) {
                    const numLimpio = parseInt(soloNumero) || 0;
                    numeroOrden = 'K-' + numLimpio.toString().padStart(3, '0');
                    console.log('üîÑ N√∫mero K legacy convertido a:', numeroOrden);
                }
            } else if (numeroOrden && numeroOrden.toString().match(/^\d+$/)) {
                // Si viene como n√∫mero puro (ej: "133"), convertir a K-133
                const numLimpio = parseInt(numeroOrden) || 0;
                numeroOrden = 'K-' + numLimpio.toString().padStart(3, '0');
                console.log('üîÑ N√∫mero puro convertido a:', numeroOrden);
            } else if (numeroOrden) {
                console.warn('‚ö†Ô∏è Formato de n√∫mero no reconocido:', numeroOrden);
                
                // Si el n√∫mero contiene ERROR, QR-, TEMP- u otros marcadores temporales
                if (numeroOrden.includes('ERROR') || numeroOrden.includes('TEMP') || 
                    numeroOrden.match(/^QR-[a-f0-9]+$/i)) {
                    console.error('‚ùå N√öMERO TEMPORAL DETECTADO - no se puede mostrar ticket v√°lido');
                    mostrarErrorConexion();
                    return;
                }
            }
            
            console.log('‚úÖ N√∫mero final usado:', numeroOrden);
            
            // Verificar si tenemos datos v√°lidos
            if (items.length === 0) {
                console.warn('‚ö†Ô∏è No hay items en ticket_items, intentando recuperar...');
                
                // Intentar m√∫ltiples fuentes de backup
                const backupSources = [
                    'checkout_backup_carrito',
                    'carrito',
                    'pedido_items'
                ];
                
                for (const source of backupSources) {
                    const backup = localStorage.getItem(source);
                    if (backup) {
                        try {
                            const backupData = JSON.parse(backup);
                            if (Array.isArray(backupData) && backupData.length > 0) {
                                items = backupData;
                                localStorage.setItem('ticket_items', JSON.stringify(backupData));
                                console.log('üîÑ Usando backup de:', source, backupData);
                                break;
                            }
                        } catch (e) {
                            console.warn('Error parseando backup:', source, e);
                        }
                    }
                }
                
                if (items.length === 0) {
                    console.error('‚ùå No se pudieron recuperar items del pedido');
                }
            }
            
            // Verificar total - si est√° vac√≠o o es cero, intentar recuperar o calcular
            if (!totalString || totalString === '0' || totalString === '0.00') {
                console.warn('‚ö†Ô∏è Total inv√°lido, intentando recuperar...');
                
                const backupTotal = localStorage.getItem('total_carrito') || 
                                  localStorage.getItem('checkout_total') ||
                                  localStorage.getItem('pedido_total');
                                  
                if (backupTotal && backupTotal !== '0') {
                    totalString = backupTotal;
                    console.log('üîÑ Total recuperado de backup:', totalString);
                }
            }
            
            // Actualizar elementos en la p√°gina con datos normalizados
            document.getElementById('numero-orden').textContent = numeroOrden;
            
            // Actualizar m√©todo de pago con valor normalizado
            document.querySelectorAll('.info-label').forEach((el) => {
                if (el.textContent.includes('M√©todo de pago')) {
                    el.nextElementSibling.textContent = metodoPago;
                }
            });
            
            document.getElementById('fecha').textContent = formatearFecha(ahora);
            document.getElementById('hora').textContent = formatearHora(ahora);
            
            const referencia = 'REF-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            document.getElementById('referencia').textContent = referencia;
            
            const orderItems = document.getElementById('order-items');
            
            console.log('üõí Items finales a procesar:', items);
            
            // Validar que tenemos items v√°lidos
            if (!items || items.length === 0) {
                console.error('‚ùå No hay items v√°lidos para mostrar');
                orderItems.innerHTML = '<div style="text-align:center; color:#888; padding:20px;">No se pudieron cargar los items del pedido</div>';
                // Usar total del localStorage aunque no tengamos items
                const totalFallback = parseFloat(totalString) || 0;
                document.getElementById('total-pagado').textContent = `$${totalFallback.toLocaleString()}`;
                return;
            }
            
            // Agrupar productos iguales (nombre, id_producto, personalizaciones)
            const agrupados = [];
            let totalCalculado = 0;
            
            items.forEach(item => {
                console.log('üì¶ Procesando item:', item);
                
                // Validar que el item tiene los datos m√≠nimos necesarios
                if (!item.nombre) {
                    console.warn('‚ö†Ô∏è Item sin nombre:', item);
                    return;
                }
                
                const key = (item.id_producto || item.nombre) + '|' + JSON.stringify(item.personalizaciones || []);
                const existente = agrupados.find(p => p.key === key);
                
                if (existente) {
                    existente.cantidad += Number(item.cantidad) || 1;
                } else {
                    agrupados.push({ 
                        ...item, 
                        key,
                        cantidad: Number(item.cantidad) || 1
                    });
                }
            });
            
            let itemsHTML = '';
            agrupados.forEach(item => {
                // Mejorar el c√°lculo de precios para manejar diferentes formatos
                let precioBase = 0;
                if (item.precio !== undefined) {
                    precioBase = Number(item.precio);
                } else if (item.precio_unitario !== undefined) {
                    precioBase = Number(item.precio_unitario);
                } else if (item.price !== undefined) {
                    precioBase = Number(item.price);
                }
                
                // Calcular extras de personalizaciones
                let extras = 0;
                if (Array.isArray(item.personalizaciones) && item.personalizaciones.length > 0) {
                    extras = item.personalizaciones.reduce((acc, p) => {
                        if (typeof p === 'object' && p.precio_extra) {
                            const extraPrice = parseFloat(String(p.precio_extra).replace(',', '.')) || 0;
                            return acc + extraPrice;
                        }
                        return acc;
                    }, 0);
                }
                
                const precioUnitario = precioBase + extras;
                const subtotal = precioUnitario * item.cantidad;
                totalCalculado += subtotal;
                
                console.log(`üí∞ Item: ${item.nombre}, precio base: ${precioBase}, extras: ${extras}, cantidad: ${item.cantidad}, subtotal: ${subtotal}`);
                
                // Construir string de personalizaciones
                let persStr = '';
                if (Array.isArray(item.personalizaciones) && item.personalizaciones.length > 0) {
                    const personalizacionesTexto = item.personalizaciones
                        .map(p => p.nombre_opcion || p.nombre || p)
                        .filter(nombre => nombre && nombre !== '')
                        .join(', ');
                    
                    if (personalizacionesTexto) {
                        persStr = `<span style="background:#eee; color:#444; border-radius:6px; padding:2px 8px; margin-left:8px; font-size:0.95em;">${personalizacionesTexto}</span>`;
                    }
                }
                
                itemsHTML += `<div class='item'>
                    <span class='item-name'>${item.nombre}${persStr}</span>
                    <span class='item-quantity'>x${item.cantidad}</span>
                    <span class='item-price'>$${subtotal.toLocaleString()}</span>
                </div>`;
            });
            
            orderItems.innerHTML = itemsHTML;
            
            // Decidir qu√© total usar con l√≥gica mejorada
            let totalFinal = totalCalculado;
            
            if (totalString && totalString !== '0' && totalString !== '0.00') {
                // Limpiar el total del localStorage de posibles caracteres no num√©ricos
                const totalStringLimpio = totalString.toString().replace(/[^\d.,]/g, '');
                const totalFromStorage = parseFloat(totalStringLimpio.replace(',', '.'));
                
                if (!isNaN(totalFromStorage) && totalFromStorage > 0) {
                    // Si hay gran diferencia entre calculado y guardado, usar el mayor
                    const diferencia = Math.abs(totalFromStorage - totalCalculado);
                    const porcentajeDiferencia = diferencia / Math.max(totalFromStorage, totalCalculado);
                    
                    if (porcentajeDiferencia < 0.1) { // Diferencia menor al 10%
                        totalFinal = totalFromStorage;
                        console.log('üíµ Usando total del localStorage (similar al calculado):', totalFromStorage);
                    } else {
                        totalFinal = Math.max(totalFromStorage, totalCalculado);
                        console.log('üíµ Gran diferencia detectada. Usando el mayor:', totalFinal, '(Storage:', totalFromStorage, ', Calculado:', totalCalculado, ')');
                    }
                } else {
                    console.log('üíµ Total del storage inv√°lido, usando calculado:', totalCalculado);
                }
            } else {
                console.log('üíµ Sin total en storage, usando calculado:', totalCalculado);
            }
            
            document.getElementById('total-pagado').textContent = `$${totalFinal.toLocaleString()}`;
            
            console.log('üéØ Total final mostrado:', totalFinal);
            console.log('üìä Resumen ticket completado con', agrupados.length, 'items √∫nicos');
            
            // Limpiar localStorage despu√©s de un tiempo (pero no inmediatamente para debug)
            setTimeout(() => {
                localStorage.removeItem('ticket_items');
                localStorage.removeItem('ticket_total');
                console.log('üßπ LocalStorage limpiado');
            }, 5000); // 5 segundos en lugar de 1 para debugging
        }
        // Bot√≥n Continuar (reemplaza al bot√≥n Nueva Compra)
        document.getElementById('Boton_Continuar').addEventListener('click', function () {
            window.location.href = 'pantallafinal.html';
        });

        // Bot√≥n Imprimir Ticket (sin redirecci√≥n)
        document.getElementById('Boton_Imprimir_Ticket').addEventListener('click', function () {
            imprimirTicketQZ();
            // No hay redirecci√≥n autom√°tica, el usuario decide cu√°ndo continuar
        });

        function imprimirTicket() {
            // Recopilar los datos del ticket desde la pantalla
            const numeroOrden = document.getElementById('numero-orden').textContent;
            const fecha = document.getElementById('fecha').textContent;
            const hora = document.getElementById('hora').textContent;

            // Buscar el m√©todo de pago de forma segura
            let metodoPago = '';
            document.querySelectorAll('.info-label').forEach((el) => {
                if (el.textContent.includes('M√©todo de pago')) {
                    metodoPago = el.nextElementSibling.textContent;
                }
            });

            // Obtener el total pagado tal como aparece en pantalla
            const totalPagado = document.getElementById('total-pagado').textContent;

            // Recopilar los items del pedido
            const items = [];
            document.querySelectorAll('#order-items .item').forEach(item => {
                const nombre = item.querySelector('.item-name').textContent;
                const cantidad = item.querySelector('.item-quantity').textContent.replace('x', '');
                const precio = item.querySelector('.item-price').textContent;
                items.push({ nombre, cantidad, precio });
            });

            // Enviar los datos al archivo PHP
            fetch('../../backend/api/print_ticket.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    numeroOrden,
                    fecha,
                    hora,
                    metodoPago,
                    totalPagado,
                    items
                })
            })
                .then(response => response.text())
                .then(data => {
                    console.log('Respuesta de impresi√≥n:', data);
                })
                .catch(error => {
                    console.error('Error al imprimir el ticket:', error);
                });
        }

        // Funci√≥n para imprimir con QZ Tray (sin cartel usando llaves demo)
        function printWithQZTray(ticketContent) {
            return new Promise((resolve, reject) => {
                if (typeof qz === 'undefined') {
                    reject(new Error('QZ Tray no est√° disponible'));
                    return;
                }

                console.log('üîß Iniciando impresi√≥n directa con QZ Tray...');

                // Verificar si ya est√° conectado o conectar (IGUAL QUE EN TEST)
                const printPromise = qz.websocket.isActive() 
                    ? Promise.resolve()
                    : connectToQZTray();

                printPromise
                    .then(() => {
                        console.log('‚úÖ Usando conexi√≥n existente o nueva para impresi√≥n');
                        return qz.printers.find();
                    })
                    .then((printers) => {
                        if (printers.length === 0) {
                            throw new Error('No se encontraron impresoras disponibles');
                        }

                        console.log('üñ®Ô∏è Impresoras encontradas:', printers.join(', '));
                        
                        // Buscar la impresora t√©rmica EPSON TM-T88V que detectaste
                        let selectedPrinter = printers[0]; // Por defecto la primera
                        
                        const epsonThermal = printers.find(p => 
                            p.toLowerCase().includes('epson tm-t88v') ||
                            p.toLowerCase().includes('tm-t88v')
                        );
                        
                        if (epsonThermal) {
                            selectedPrinter = epsonThermal;
                            console.log('üéØ Usando impresora t√©rmica EPSON:', selectedPrinter);
                        }
                        
                        // USAR LA MISMA CONFIGURACI√ìN QUE FUNCIONA EN TEST
                        const config = qz.configs.create(selectedPrinter);
                        
                        const data = [{
                            type: 'raw',
                            format: 'plain',
                            data: ticketContent
                        }];

                        console.log('üìÑ Enviando ticket a la impresora:', selectedPrinter);
                        return qz.print(config, data);
                    })
                    .then(() => {
                        console.log('‚úÖ Ticket impreso exitosamente SIN CARTEL');
                        resolve();
                    })
                    .catch((error) => {
                        console.error('‚ùå Error al imprimir:', error);
                        reject(error);
                    });
            });
        }

        // Funci√≥n para imprimir ticket usando QZ Tray con configuraci√≥n mejorada
        function imprimirTicketQZ() {
            // Recopilar datos del ticket desde la pantalla (ya normalizados)
            const numeroOrden = document.getElementById('numero-orden').textContent;
            const fecha = document.getElementById('fecha').textContent;
            const hora = document.getElementById('hora').textContent;
            const totalPagado = document.getElementById('total-pagado').textContent;

            // Buscar el m√©todo de pago (ya normalizado)
            let metodoPago = 'QR Mercado Pago';
            document.querySelectorAll('.info-label').forEach((el) => {
                if (el.textContent.includes('M√©todo de pago')) {
                    metodoPago = el.nextElementSibling.textContent;
                }
            });

            // Obtener items originales con personalizaciones desde localStorage
            let itemsOriginales = JSON.parse(localStorage.getItem('ticket_items') || '[]');
            
            // Si no hay items, intentar recuperar como en cargarTicket
            if (itemsOriginales.length === 0) {
                const backupSources = ['checkout_backup_carrito', 'carrito', 'pedido_items'];
                for (const source of backupSources) {
                    const backup = localStorage.getItem(source);
                    if (backup) {
                        try {
                            const backupData = JSON.parse(backup);
                            if (Array.isArray(backupData) && backupData.length > 0) {
                                itemsOriginales = backupData;
                                break;
                            }
                        } catch (e) {
                            console.warn('Error parseando backup para impresi√≥n:', source, e);
                        }
                    }
                }
            }
            
            // Agrupar items originales (igual que en cargarTicket)
            const itemsAgrupados = {};
            itemsOriginales.forEach(item => {
                const key = item.id_producto + '|' + JSON.stringify(item.personalizaciones || []);
                if (itemsAgrupados[key]) {
                    itemsAgrupados[key].cantidad += Number(item.cantidad);
                } else {
                    itemsAgrupados[key] = { ...item, cantidad: Number(item.cantidad) };
                }
            });

            // Crear el contenido del ticket con formato t√©rmico
            const ticketData = [
                '\x1B@', // Inicializar impresora
                '\x1B!\x38', // Texto grande
                'TOTEM MURIALDO\n',
                '\x1B!\x00', // Texto normal
                '===============================\n',
                `Ticket No: ${numeroOrden}\n`,
                `Fecha: ${fecha}\n`,
                `Hora: ${hora}\n`,
                '===============================\n'
            ];

            // Agregar items del pedido con formato de comandas
            Object.values(itemsAgrupados).forEach(item => {
                // Usar el nombre limpio del producto
                const nombreLimpio = item.nombre;
                
                // Agregar el producto con cantidad
                ticketData.push(`${item.cantidad}x ${nombreLimpio}\n`);
                
                // Agregar personalizaciones si existen (igual que en comandas)
                if (Array.isArray(item.personalizaciones) && item.personalizaciones.length > 0) {
                    item.personalizaciones.forEach(pers => {
                        const nombrePers = pers.nombre_opcion || pers;
                        ticketData.push(`     -${nombrePers}\n`);
                    });
                }
                
                // Calcular precio con extras
                const precioBase = item.precio ?? item.precio_unitario ?? 0;
                const extras = Array.isArray(item.personalizaciones) 
                    ? item.personalizaciones.reduce((acc, p) => acc + (typeof p === 'object' ? (parseFloat(String(p.precio_extra).replace(',', '.')) || 0) : 0), 0) 
                    : 0;
                const subtotal = (Number(precioBase) + extras) * Number(item.cantidad);
                
                ticketData.push(`$${subtotal.toLocaleString()}\n`);
            });

            ticketData.push('===============================\n');
            ticketData.push(`TOTAL: ${totalPagado}\n`);
            ticketData.push(`PAGO: ${metodoPago}\n`);
            ticketData.push('===============================\n');
            ticketData.push('GRACIAS POR SU COMPRA\n');
            ticketData.push('\n\n\n');
            ticketData.push('\x1DVA0'); // Corte de papel

            // Usar la funci√≥n de impresi√≥n con QZ Tray (sin cartel)
            printWithQZTray(ticketData.join(''))
                .then(() => {
                    console.log('üéâ Ticket enviado a la impresora exitosamente');
                    // Mostrar mensaje de √©xito al usuario
                    const botonImprimir = document.getElementById('Boton_Imprimir_Ticket');
                    const textoOriginal = botonImprimir.textContent;
                    botonImprimir.textContent = '‚úì Impreso';
                    botonImprimir.style.backgroundColor = '#28a745';
                    
                    // Restaurar el bot√≥n despu√©s de 3 segundos
                    setTimeout(() => {
                        botonImprimir.textContent = textoOriginal;
                        botonImprimir.style.backgroundColor = '';
                    }, 3000);
                })
                .catch(err => {
                    console.error('‚ùå Error de impresi√≥n:', err);
                    // Mostrar mensaje de error al usuario
                    const botonImprimir = document.getElementById('Boton_Imprimir_Ticket');
                    const textoOriginal = botonImprimir.textContent;
                    botonImprimir.textContent = '‚úó Error';
                    botonImprimir.style.backgroundColor = '#dc3545';
                    
                    // Mostrar detalles del error
                    alert('Error al imprimir: ' + err.message + '\n\nVerifica que QZ Tray est√© ejecut√°ndose y que haya una impresora conectada.');
                    
                    // Restaurar el bot√≥n despu√©s de 3 segundos
                    setTimeout(() => {
                        botonImprimir.textContent = textoOriginal;
                        botonImprimir.style.backgroundColor = '';
                    }, 3000);
                });
        }

        window.addEventListener('DOMContentLoaded', async () => {
            // Configurar QZ Tray al cargar la p√°gina (IGUAL QUE EN TEST QUE FUNCIONA)
            console.log('üîß Inicializando QZ Tray...');
            console.log('üåê Entorno: ' + (window.location.hostname === 'ilm2025.webhop.net' ? 'Producci√≥n' : 'Local'));
            
            // Cargar los datos del ticket primero
            await cargarTicket();
            
            // Configurar QZ Tray despu√©s de cargar la p√°gina (como en test)
            setTimeout(() => {
                if (typeof qz !== 'undefined' && typeof configureQZTray === 'function') {
                    try {
                        if (configureQZTray()) {
                            console.log('‚úÖ QZ Tray configurado con llaves demo - Cartel eliminado');
                        } else {
                            console.error('‚ùå Error configurando QZ Tray');
                        }
                    } catch (error) {
                        console.error('‚ùå Excepci√≥n al configurar QZ Tray:', error);
                    }
                } else {
                    console.error('‚ùå QZ Tray o su configuraci√≥n no est√°n disponibles');
                }
            }, 500);
        });

        // === DETECCI√ìN M√ìVIL Y GESTI√ìN DE BOTONES ===
        function esDispositivoMovil() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            console.log('=== DETECCI√ìN M√ìVIL EN TICKET ===');
            console.log('screen.width:', screen.width);
            console.log('screen.height:', screen.height);
            console.log('window.innerWidth:', window.innerWidth);
            console.log('window.innerHeight:', window.innerHeight);
            
            // EXCLUIR resoluci√≥n espec√≠fica 1080x1920 (va a imprimir normal)
            const esResolucion1080x1920 = (
                (screen.width === 1080 && screen.height === 1920) ||
                (screen.height === 1080 && screen.width === 1920) ||
                (window.innerWidth === 1080 && window.innerHeight === 1920) ||
                (window.innerHeight === 1080 && window.innerWidth === 1920)
            );
            
            if (esResolucion1080x1920) {
                console.log('üîç Resoluci√≥n 1080x1920 detectada - NO ES M√ìVIL para efectos del ticket');
                return false;
            }
            
            // Detectar m√≥viles por user agent
            const esMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent);
            
            // Detectar por caracter√≠sticas de pantalla t√°ctil y tama√±o
            const esPantallaTactil = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const esPantallaChica = window.innerWidth <= 768;
            
            const resultado = esMobile || (esPantallaTactil && esPantallaChica);
            console.log('¬øEs dispositivo m√≥vil para ticket?:', resultado);
            
            return resultado;
        }

        // === GENERAR PDF DEL TICKET (COPIA VISUAL) ===
        function generarPDFTicket() {
            console.log('üìÑ Generando PDF del ticket con datos reales...');
            
            // Debug de datos disponibles
            console.log('üîç Datos disponibles para PDF:');
            console.log('- localStorage ticket_items:', localStorage.getItem('ticket_items'));
            console.log('- localStorage ticket_total:', localStorage.getItem('ticket_total'));
            console.log('- localStorage metodo_pago:', localStorage.getItem('metodo_pago'));
            console.log('- DOM numero_orden:', document.getElementById('numero-orden')?.textContent);
            console.log('- DOM fecha:', document.getElementById('fecha')?.textContent);
            console.log('- DOM hora:', document.getElementById('hora')?.textContent);
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // === COLORES Y ESTILOS SIMILARES AL TICKET ===
                const colorPrimario = [58, 154, 83]; // Verde #3A9A53
                const colorSecundario = [102, 102, 102]; // Gris
                const colorTexto = [51, 51, 51]; // Negro suave
                
                // === ENCABEZADO ===
                doc.setFillColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.rect(0, 0, 210, 40, 'F'); // Fondo verde
                
                doc.setTextColor(255, 255, 255); // Texto blanco
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text('COMPROBANTE DE PAGO', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text('Totem Murialdo - Sistema de Pedidos', 105, 30, { align: 'center' });
                
                // === INFORMACI√ìN PRINCIPAL ===
                let yPos = 55;
                doc.setTextColor(colorTexto[0], colorTexto[1], colorTexto[2]);
                
                // Obtener datos reales del ticket (elementos con IDs actuales)
                const numeroOrden = document.getElementById('numero-orden')?.textContent || 'N/A';
                const fechaPago = document.getElementById('fecha')?.textContent || new Date().toLocaleDateString('es-ES');
                const horaPago = document.getElementById('hora')?.textContent || new Date().toLocaleTimeString('es-ES');
                const metodoPago = localStorage.getItem('metodo_pago') || 'QR Mercado Pago';
                const totalPagado = document.getElementById('total-amount')?.textContent || localStorage.getItem('ticket_total') || 'N/A';
                
                // Card de informaci√≥n (fondo gris claro)
                doc.setFillColor(248, 249, 250);
                doc.roundedRect(15, yPos - 5, 180, 35, 3, 3, 'F');
                
                // N√∫mero de orden destacado
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('N√∫mero de orden:', 20, yPos + 5);
                doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.text(numeroOrden, 85, yPos + 5);
                
                // Informaci√≥n en dos columnas
                doc.setTextColor(colorTexto[0], colorTexto[1], colorTexto[2]);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
                
                yPos += 15;
                doc.text('Fecha:', 20, yPos);
                doc.text(fechaPago, 50, yPos);
                doc.text('Hora:', 110, yPos);
                doc.text(horaPago, 130, yPos);
                
                yPos += 8;
                doc.text('M√©todo de pago:', 20, yPos);
                doc.setFont('helvetica', 'bold');
                doc.text(metodoPago, 65, yPos);
                
                // === DETALLE DEL PEDIDO ===
                yPos += 20;
                
                // Encabezado de items (fondo verde claro)
                doc.setFillColor(232, 245, 232);
                doc.rect(15, yPos - 3, 180, 12, 'F');
                
                doc.setTextColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(14);
                doc.text('DETALLE DEL PEDIDO', 20, yPos + 5);
                
                yPos += 15;
                
                // Encabezados de columnas
                doc.setTextColor(colorSecundario[0], colorSecundario[1], colorSecundario[2]);
                doc.setFontSize(10);
                doc.text('PRODUCTO', 20, yPos);
                doc.text('CANT.', 120, yPos);
                doc.text('PRECIO UNIT.', 140, yPos);
                doc.text('SUBTOTAL', 170, yPos);
                
                // L√≠nea separadora
                doc.setDrawColor(colorSecundario[0], colorSecundario[1], colorSecundario[2]);
                doc.setLineWidth(0.3);
                doc.line(20, yPos + 2, 190, yPos + 2);
                
                yPos += 10;
                
                // === OBTENER ITEMS REALES DEL TICKET ===
                let ticketItems = [];
                console.log('üìã Obteniendo items para PDF...');
                
                // Primero intentar desde localStorage (datos originales)
                try {
                    const storedItems = localStorage.getItem('ticket_items');
                    if (storedItems) {
                        ticketItems = JSON.parse(storedItems);
                        console.log('‚úÖ Items obtenidos del localStorage:', ticketItems);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error obteniendo items del localStorage:', error);
                }
                
                // Si no hay items en localStorage, obtener del DOM actualizado
                if (ticketItems.length === 0) {
                    console.log('üîç Obteniendo items del DOM...');
                    const itemElements = document.querySelectorAll('.order-item');
                    itemElements.forEach(itemEl => {
                        const nombre = itemEl.querySelector('.item-name')?.textContent?.trim() || 'Producto';
                        const cantidad = itemEl.querySelector('.item-quantity')?.textContent?.replace('x', '')?.trim() || '1';
                        const precio = itemEl.querySelector('.item-unit-price')?.textContent?.replace('$', '')?.replace(',', '')?.trim() || '0';
                        
                        ticketItems.push({ 
                            nombre: nombre, 
                            cantidad: parseInt(cantidad) || 1, 
                            precio_unitario: parseFloat(precio) || 0
                        });
                    });
                    console.log('‚úÖ Items obtenidos del DOM:', ticketItems);
                }
                
                // === AGREGAR ITEMS AL PDF ===
                doc.setTextColor(colorTexto[0], colorTexto[1], colorTexto[2]);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                
                let totalCalculado = 0;
                
                ticketItems.forEach((item, index) => {
                    if (yPos > 250) { // Nueva p√°gina si es necesario
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    const nombre = item.nombre || `Producto ${index + 1}`;
                    const cantidad = parseInt(item.cantidad) || 1;
                    const precioUnit = parseFloat(item.precio_unitario) || 0;
                    const subtotal = cantidad * precioUnit;
                    totalCalculado += subtotal;
                    
                    // Fondo alternado para items
                    if (index % 2 === 0) {
                        doc.setFillColor(251, 252, 253);
                        doc.rect(15, yPos - 3, 180, 8, 'F');
                    }
                    
                    // Truncar nombre si es muy largo
                    const nombreCorto = nombre.length > 30 ? nombre.substring(0, 27) + '...' : nombre;
                    
                    doc.text(nombreCorto, 20, yPos);
                    doc.text(cantidad.toString(), 125, yPos, { align: 'center' });
                    doc.text(`$${precioUnit.toFixed(2)}`, 155, yPos, { align: 'center' });
                    doc.text(`$${subtotal.toFixed(2)}`, 185, yPos, { align: 'right' });
                    
                    yPos += 8;
                });
                
                // === TOTAL FINAL ===
                yPos += 10;
                
                // Usar el total calculado o el del localStorage, formateado correctamente
                let totalFinal = totalCalculado;
                const totalStorage = localStorage.getItem('ticket_total');
                if (totalStorage && parseFloat(totalStorage.replace(',', '')) > 0) {
                    totalFinal = parseFloat(totalStorage.replace(',', ''));
                }
                
                console.log('üí∞ Total para PDF - Calculado:', totalCalculado, 'Storage:', totalStorage, 'Final:', totalFinal);
                
                // Fondo destacado para el total
                doc.setFillColor(colorPrimario[0], colorPrimario[1], colorPrimario[2]);
                doc.roundedRect(15, yPos - 3, 180, 15, 3, 3, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.text('TOTAL PAGADO:', 20, yPos + 7);
                doc.text(`$${totalFinal.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, 185, yPos + 7, { align: 'right' });
                
                // === PIE DE P√ÅGINA ===
                yPos += 30;
                doc.setTextColor(colorSecundario[0], colorSecundario[1], colorSecundario[2]);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.text('Comprobante generado autom√°ticamente', 105, yPos, { align: 'center' });
                doc.text(`Fecha de generaci√≥n: ${new Date().toLocaleString('es-ES')}`, 105, yPos + 5, { align: 'center' });
                
                // Informaci√≥n adicional del establecimiento
                yPos += 15;
                doc.setFontSize(8);
                doc.text('Totem Murialdo - Sistema de Pedidos Autom√°tico', 105, yPos, { align: 'center' });
                doc.text('Conserve este comprobante como respaldo de su pago', 105, yPos + 5, { align: 'center' });
                
                // === GENERAR Y DESCARGAR ===
                const fechaHoy = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
                const horaActual = new Date().toTimeString().slice(0, 5).replace(':', ''); // HHMM
                const numeroLimpio = numeroOrden.replace(/[^A-Z0-9]/g, ''); // Solo alfanum√©rico
                const fileName = `Comprobante_${numeroLimpio}_${fechaHoy}_${horaActual}.pdf`;
                
                // Descargar PDF
                doc.save(fileName);
                
                console.log('‚úÖ PDF generado exitosamente (copia visual):', fileName);
                
                // Mostrar mensaje de √©xito al usuario
                const statusMessage = document.createElement('div');
                statusMessage.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #d4edda; color: #155724; padding: 15px 20px;
                    border: 1px solid #c3e6cb; border-radius: 8px;
                    font-family: Inter, sans-serif; font-size: 14px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    max-width: 300px; text-align: center;
                `;
                statusMessage.innerHTML = `
                    ‚úÖ <strong>Comprobante descargado</strong><br>
                    <small>Orden: ${numeroOrden}<br>
                    Total: ${totalFinal.toLocaleString('es-ES', { style: 'currency', currency: 'ARS' })}</small>
                `;
                document.body.appendChild(statusMessage);
                
                setTimeout(() => {
                    if (document.body.contains(statusMessage)) {
                        document.body.removeChild(statusMessage);
                    }
                }, 4000);
                
            } catch (error) {
                console.error('‚ùå Error generando PDF:', error);
                alert('Error al generar el comprobante PDF. Por favor intente nuevamente.');
            }
        }

        // Event listener para bot√≥n de descarga PDF
        document.getElementById('Boton_Descargar_PDF').addEventListener('click', function() {
            generarPDFTicket();
        });

        // === CONFIGURAR BOTONES SEG√öN DISPOSITIVO ===
        document.addEventListener('DOMContentLoaded', function() {
            if (esDispositivoMovil()) {
                // Es m√≥vil: ocultar imprimir, mostrar descargar PDF
                console.log('üì± Dispositivo m√≥vil detectado - mostrando bot√≥n de descarga PDF');
                document.getElementById('Boton_Imprimir_Ticket').style.display = 'none';
                document.getElementById('Boton_Descargar_PDF').style.display = 'inline-block';
            } else {
                // No es m√≥vil: mostrar imprimir, ocultar PDF
                console.log('üñ•Ô∏è Dispositivo de escritorio/tablet - mostrando bot√≥n de imprimir');
                document.getElementById('Boton_Imprimir_Ticket').style.display = 'inline-block';
                document.getElementById('Boton_Descargar_PDF').style.display = 'none';
            }
        });

        // === FUNCI√ìN PARA MOSTRAR ERROR DE CONEXI√ìN ===
        function mostrarErrorConexion() {
            const ticketContainer = document.querySelector('.ticket-container');
            
            ticketContainer.innerHTML = `
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="font-size: 48px; color: #ff4444; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <div style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 15px;">
                        Error de Conexi√≥n
                    </div>
                    <div style="font-size: 16px; color: #666; margin-bottom: 25px; line-height: 1.4;">
                        No se pudo obtener la informaci√≥n del pedido desde la base de datos.<br>
                        El pago se proces√≥ correctamente.
                    </div>
                    <div style="background: #f8f8f8; padding: 15px; border-radius: 8px; margin-bottom: 25px;">
                        <div style="font-size: 14px; color: #333; margin-bottom: 10px;">
                            <strong>¬øQu√© hacer?</strong>
                        </div>
                        <div style="font-size: 13px; color: #666; line-height: 1.4;">
                            ‚Ä¢ Contacta al personal del establecimiento<br>
                            ‚Ä¢ Muestra esta pantalla como comprobante de pago<br>
                            ‚Ä¢ El pedido est√° registrado en el sistema
                        </div>
                    </div>
                    <button onclick="window.location.href=((localStorage.getItem('punto_venta_nombre') || '').toLowerCase() === 'buffet' ? 'buffet.html' : 'kiosco_dinamico.html')" 
                            style="background: #00a650; color: white; padding: 12px 24px; 
                                   border: none; border-radius: 6px; font-size: 16px; 
                                   cursor: pointer; margin-right: 10px;">
                        Volver al Men√∫
                    </button>
                    <button onclick="location.reload()" 
                            style="background: #0066cc; color: white; padding: 12px 24px; 
                                   border: none; border-radius: 6px; font-size: 16px; 
                                   cursor: pointer;">
                        Reintentar
                    </button>
                </div>
            `;
        }
    </script>
</body>

</html>
